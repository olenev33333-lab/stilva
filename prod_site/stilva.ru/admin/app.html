<!doctype html>
<html lang="ru">
<head>
  <meta charset="utf-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Админка</title>
  <style>
    :root{
      --bg:#f7f8fa; --card:#fff; --text:#0f172a; --muted:#64748b; --line:#e5e7eb;
      --accent:#0ea5e9; --success:#16a34a; --danger:#dc2626;
      --shadow:0 10px 30px rgba(0,0,0,.06);
      --btn:#e5e7eb; --btnText:#111; --btnHover:#d1d5db;
    }
    *{box-sizing:border-box}
    body{font-family:Inter,system-ui,Segoe UI,Roboto,Arial,sans-serif;margin:0;background:var(--bg);color:var(--text)}
    header{padding:16px 24px;border-bottom:1px solid var(--line);background:#fff;position:sticky;top:0;z-index:10;display:flex;justify-content:space-between;align-items:center}
    .wrap{max-width:100%;margin:0;padding:20px clamp(12px, 4vw, 32px)}

    .split{display:grid;grid-template-columns:1fr 1fr;gap:20px;align-items:start}
    @media (max-width:1100px){.split{grid-template-columns:1fr}}

    .card{background:var(--card);border:1px solid var(--line);border-radius:14px;padding:16px;box-shadow:var(--shadow);display:flex;flex-direction:column;min-height:240px;position:relative}
    .card-head{display:flex;gap:10px;align-items:center;margin-bottom:8px}
    .card-title{font-size:18px;font-weight:800;margin:0;margin-right:auto}
    .card-body{position:relative;min-height:160px}

    table{width:100%;border-collapse:collapse;background:#fff;table-layout:fixed}
    thead th{position:sticky;top:0;background:#f8fafc;border-bottom:1px solid var(--line);z-index:1}
    th,td{padding:10px;border-bottom:1px solid var(--line);text-align:left;font-size:14px;vertical-align:top}
    .cell-ellipsis{white-space:nowrap;overflow:hidden;text-overflow:ellipsis}
    .cell-wrap{white-space:normal;overflow:visible;word-break:break-word}
    td.actions{width:150px}
    td.actions .btns{display:flex;flex-direction:column;gap:8px;align-items:stretch}
    .scroll-area{overflow:auto;border:1px solid var(--line);border-radius:10px;max-height:64vh;background:#fff;position:relative}
    .scroll-area{scrollbar-width:thin;scrollbar-color:#cbd5e1 transparent}
    .scroll-area::-webkit-scrollbar{width:10px;height:10px}
    .scroll-area::-webkit-scrollbar-thumb{background:#cbd5e1;border-radius:8px}
    .scroll-area::-webkit-scrollbar-track{background:transparent}

    input,select,textarea{background:#fff;color:#0f172a;border:1px solid var(--line);border-radius:10px;padding:10px;outline:none}
    select, input, textarea{transition:box-shadow .15s ease, transform .06s ease}
    select:focus, input:focus, textarea:focus{box-shadow:0 0 0 3px rgba(14,165,233,.2)}
    button{background:var(--success);border:none;color:#fff;padding:10px 14px;border-radius:10px;cursor:pointer;font-weight:700;transition:transform .06s ease, opacity .2s}
    button:active{transform:translateY(1px)}
    .danger{background:#ef4444}
    .ghost{background:var(--btn);color:var(--btnText)}
    .ghost:hover{background:var(--btnHover)}
    .muted{color:var(--muted);font-size:12px}

    .pane-overlay{position:absolute;inset:0;display:flex;align-items:center;justify-content:center;background:rgba(15,23,42,.14);backdrop-filter:saturate(120%) blur(1px);z-index:99;opacity:0;transform:scale(.98);transition:opacity .12s ease, transform .12s ease;pointer-events:none}
    .pane-overlay.active{opacity:1;transform:scale(1);pointer-events:auto}
    .pane-spinner{width:36px;height:36px;border-radius:50%;border:3px solid rgba(34,197,94,.35);border-top-color:var(--success);animation:spin .6s linear infinite;box-shadow:0 2px 10px rgba(34,197,94,.25)}
    @keyframes spin{to{transform:rotate(360deg)}}

    .bigmenu{display:grid;gap:12px}
    .bigmenu button{width:100%;padding:20px 18px;border-radius:16px;font-size:18px;font-weight:800;background:var(--btn);color:var(--btnText);box-shadow:0 10px 24px rgba(0,0,0,.04)}
    .bigmenu button:hover{background:var(--btnHover)}
    .bigmenu button.disabled{opacity:.55;cursor:not-allowed}

    .th-sort{cursor:pointer;display:inline-flex;align-items:center;gap:6px}
    .th-sort .carret{width:10px;height:10px;display:inline-block;border-right:2px solid #94a3b8;border-bottom:2px solid #94a3b8;transform:rotate(45deg);opacity:.6}
    .th-sort.asc .carret{transform:rotate(225deg)}
    .th-sort.desc .carret{transform:rotate(45deg)}

    .modal-backdrop{position:fixed;inset:0;background:rgba(15,23,42,.35);backdrop-filter:blur(2px);display:none;align-items:center;justify-content:center;z-index:10000}
    .modal{background:#fff;border:1px solid var(--line);border-radius:16px;box-shadow:0 24px 64px rgba(0,0,0,.2);width: min(1800px, calc(100vw - 48px));max-height:88vh;overflow:auto;padding:16px}
    .modal-head{display:flex;align-items:center;justify-content:space-between;margin-bottom:8px}
    .close-x{background:transparent;border:none;font-size:22px;cursor:pointer;color:#111}

    .mini-table{display:grid;grid-template-columns:1fr auto auto auto;gap:6px;font-size:13px}
    .mini-table .head{font-weight:700;color:#334155}
  
    .cancel-note{color: var(--danger); font-weight: 800; text-transform: uppercase; margin-top:10px; font-size: 12px;}
    #order-modal-backdrop .modal{
  width: min(920px, 96vw);
  max-height: 86vh; /* чтобы совпадало по высоте с товарными модалками */
}
/* Сузить выпадашку статуса в таблицах заказов */
#orders-right-table td:nth-child(5) select,
#orders-left-table  td:nth-child(5) select {
  width: 132px !important;     /* при необходимости поменяй на 120–140 */
  min-width: 132px !important;
  max-width: 132px !important;
  box-sizing: border-box;
  white-space: nowrap;
}

  </style>
<style>
/* ===== Stats UI (pretty but restrained) ===== */
.stats-kpis{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:12px}
.stat-card{position:relative;background:linear-gradient(180deg,#f7fbff, #ffffff);border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:0 8px 20px rgba(2,6,23,.05)}
.stat-card::after{content:'';position:absolute;left:0;right:0;top:0;height:3px;background:#93c5fd;border-radius:12px 12px 0 0;opacity:.35}
.stat-title{font-size:12px;color:var(--muted);letter-spacing:.02em}
.stat-value{font-size:22px;font-weight:800;margin-top:4px}

.stats-lists{display:grid;grid-template-columns:1fr 1fr;gap:12px}
.list-card{background:#fff;border:1px solid var(--line);border-radius:12px;padding:12px;box-shadow:0 8px 20px rgba(2,6,23,.04)}
.list-title{font-weight:800;margin:0 0 8px 0;color:#0f172a;font-size:14px}
.stat-list{list-style:none;margin:0;padding:0;display:flex;flex-direction:column;gap:6px}
.stat-list li{display:flex;justify-content:space-between;align-items:baseline;border-bottom:1px dashed #e5e7eb;padding:6px 0}
.stat-list li:last-child{border-bottom:none}
.stat-list b{font-variant-numeric:tabular-nums}

@media (max-width: 900px){
  .stats-lists{grid-template-columns:1fr}
}
/* ===== /Stats UI ===== */
</style>

  <style>
  .admin-header { position: relative; }
  .admin-header .logout-link{
    position: absolute;
    right: 16px; top: 50%; transform: translateY(-50%);
    padding: 8px 12px; border-radius: 10px;
    background: #ef4444; color: #fff; text-decoration: none; font-weight: 700;
    line-height: 1; opacity: .95;
  }
  .admin-header .settings-link{
    position: absolute;
    right: 108px; top: 50%; transform: translateY(-50%);
    padding: 8px 12px; border-radius: 10px;
    background: var(--btn); color: var(--btnText); text-decoration: none; font-weight: 700;
    line-height: 1; cursor: pointer;
  }
  .admin-header .logout-link:hover { opacity: 1; }
  @media (max-width: 640px){ .admin-header .logout-link{ right:10px; padding:8px 10px } .admin-header .settings-link{ right:90px; padding:8px 10px } }
  /* === Stats: уменьшение типографики под размер «Заказов» === */
#stats-pane, #stats-pane-left {           /* базовый текст блока */
  font-size: 14px;                        /* как в заказах */
}

/* заголовки мини-карт и списков — на полтона меньше */
#stats-pane .list-title, 
#stats-pane-left .list-title { 
  font-size: 13px; 
}

/* подписи в KPI-карточках */
#stats-pane .stat-title, 
#stats-pane-left .stat-title {
  font-size: 11px;
}

/* крупные значения KPI, чтобы оставались читаемыми, но без крика */
#stats-pane .stat-value, 
#stats-pane-left .stat-value {
  font-size: 18px;
}

/* чуть компактнее карточки, чтобы все дышало ровнее */
#stats-pane .stat-card, 
#stats-pane-left .stat-card {
  padding: 10px;
}
/* Шапка статистики в одну строку + ужимаем селект статусов */
#stats-right .card-head > div,
#stats-left  .card-head > div {
  flex-wrap: nowrap !important; /* бьём inline flex-wrap:wrap */
  gap: 6px;                     /* было 8px — чуть компактнее */
}

#stat-status,
#stat-status-left {
  width: 150px;      /* подгони при желании: 140–170px */
  min-width: 150px;  /* фиксируем, чтобы не плясал */
}

/* На узких экранах всё равно разрешаем перенос */
@media (max-width: 1200px){
  #stats-right .card-head > div,
  #stats-left  .card-head > div { flex-wrap: wrap !important; }
}

</style>

<style>
/* ===== Row status highlighting across the whole admin (all dates) ===== */
#orders-left-table tbody tr.status-new,
#orders-right-table tbody tr.status-new { background:#f0fdf4; }         /* very pale green */

#orders-left-table tbody tr.status-delivery,
#orders-right-table tbody tr.status-delivery { background:#fefce8; }    /* pale yellow */

#orders-left-table tbody tr.status-critical,
#orders-right-table tbody tr.status-critical,
#orders-left-table tbody tr.status-cancelled,
#orders-right-table tbody tr.status-cancelled { background:#fef2f2; }   /* very pale red */
</style>
<style>
#orders-left-table tbody tr.status-inprogress,
#orders-right-table tbody tr.status-inprogress { background:#fefce8; } /* very pale yellow */
</style>

<style>
/* ===== DDS layout safety ===== */
.card, .card-body, .scroll-area { min-width: 0; }
#dds-left-table td, #dds-right-table td { word-break: break-word; }
#dds-pane-left, #dds-pane-right { padding-right:24px; box-sizing:border-box; }
#dds-left-table, #dds-right-table { width:calc(100% - 16px); margin-right:16px; table-layout: fixed; }
#dds-left-table td.actions, #dds-right-table td.actions { overflow:hidden; padding-right:18px; }
#dds-left-table td.actions .btns, #dds-right-table td.actions .btns { width:100%; align-items:flex-start; }
#dds-left-table td.actions button, #dds-right-table td.actions button { width:85%; box-sizing:border-box; }
#dds-left-table tbody tr.dds-void,
#dds-right-table tbody tr.dds-void { opacity:.6; }
.dds-kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(180px,1fr));gap:12px;margin-bottom:12px}
</style>
<style>
/* ===== Stock UI ===== */
.stock-toolbar{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
#stock-left-table, #stock-right-table{table-layout:fixed;width:100%}
#stock-pane-left, #stock-pane-right{padding-right:16px;box-sizing:border-box}
#stock-left-table td.actions, #stock-right-table td.actions{overflow:visible;padding-right:8px;text-align:center}
#stock-left-table td.actions .btns, #stock-right-table td.actions .btns{align-items:center}
#stock-left-table td.actions button, #stock-right-table td.actions button{width:auto;min-width:110px;text-align:center;margin:0 auto;box-sizing:border-box}
.stock-kpi-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(160px,1fr));gap:12px;margin-bottom:12px}
.stock-row{display:grid;grid-template-columns:1fr 120px 120px 40px;gap:8px;align-items:center}
.stock-row--head{font-size:12px;color:var(--muted);font-weight:700}
.stock-rows{display:grid;gap:8px}
.stock-row select,.stock-row input{width:100%}
.stock-file-row{display:flex;gap:10px;align-items:center;flex-wrap:wrap}
.stock-file-row input[type=\"file\"]{border:none;padding:0}
.stock-mini{font-size:12px;color:var(--muted)}
.stock-movements-toolbar{display:flex;gap:8px;align-items:center;flex-wrap:wrap;margin-bottom:10px}
.stock-movements-toolbar input{flex:1 1 260px;min-width:220px}
.stock-movements-toolbar select{min-width:150px}
.stock-movements-qty{font-weight:800}
.stock-movements-qty.pos{color:#166534}
.stock-movements-qty.neg{color:#b91c1c}
.stock-movements-qty.zero{color:#64748b}
#stock-left-table th:nth-child(2), #stock-left-table td:nth-child(2),
#stock-right-table th:nth-child(2), #stock-right-table td:nth-child(2){
  white-space:normal;
  word-break:break-word;
  overflow:visible;
  text-overflow:clip;
}
/* ===== Order modal extras ===== */
.order-section{margin-top:14px}
.order-section .list-title{margin:0 0 6px 0;font-weight:800;color:#0f172a;font-size:14px}
.order-checklist{display:grid;gap:8px}
.order-checklist label{display:flex;gap:8px;align-items:center}
.order-badge{display:inline-flex;align-items:center;gap:6px;padding:4px 8px;border-radius:999px;font-size:12px;font-weight:700}
.order-badge.ok{background:#ecfdf5;color:#065f46;border:1px solid #bbf7d0}
.order-badge.warn{background:#fff7ed;color:#9a3412;border:1px solid #fed7aa}
.order-availability{display:grid;grid-template-columns:1fr auto auto auto;gap:6px;font-size:13px}
.order-availability .head{font-weight:700;color:#334155}
@media (max-width:800px){
  .order-availability{grid-template-columns:1fr auto}
  .order-availability .head:nth-child(3),
  .order-availability .head:nth-child(4){display:none}
  .order-availability div:nth-child(3n){display:none}
  .order-availability div:nth-child(4n){display:none}
}
@media (max-width: 900px){
  .stock-row{grid-template-columns:1fr 90px 90px 36px}
}
.production-toolbar{margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap}
.production-toolbar input,.production-toolbar select{max-width:170px}
.production-progress{height:8px;border-radius:999px;background:#e5e7eb;overflow:hidden}
.production-progress > span{display:block;height:100%;background:linear-gradient(90deg,#10b981,#3b82f6)}
.production-stages{display:grid;grid-template-columns:repeat(6,minmax(110px,1fr));gap:8px}
.production-stages .adm-field{margin:0}
.production-files{display:grid;gap:8px}
.production-file-row{display:flex;justify-content:space-between;gap:8px;align-items:center;padding:8px 10px;border:1px solid #e2e8f0;border-radius:10px;background:#fff}
@media (max-width:1100px){
  .production-stages{grid-template-columns:repeat(3,minmax(120px,1fr))}
}
@media (max-width:720px){
  .production-toolbar input,.production-toolbar select{max-width:100%}
  .production-stages{grid-template-columns:repeat(2,minmax(120px,1fr))}
}
</style>


</head>
<body>
<header class="admin-header">
  <strong>Админ-панель</strong>
  <div id="whoami" class="muted"></div>
  <button id="open-settings" class="settings-link">Настройки</button>
  <a href="?logout=1" class="logout-link">Выйти</a>
</header>

<div class="wrap">
  <div class="split">

    <!-- ЛЕВАЯ ПОЛОВИНА: Заказы -->
<section class="card" id="left-card">
  <div class="pane-overlay"><div class="pane-spinner"></div></div>

  <div id="left-menu">
    <h3 class="card-title" style="margin-bottom:12px">Разделы</h3>
    <div class="bigmenu">
      <button class="ghost" id="open-products-left">Товары</button>
      <button class="ghost" id="open-stats-left">Статистика</button>
      <button class="ghost" id="open-orders-left">Заказы</button>
      <button class="ghost" id="open-stock-left">Учет товара</button>
      <button class="ghost" id="open-production-left">Производство</button>
      <button class="ghost" id="open-dds-left">ДДС</button>
    </div>
  </div>

  <div id="products-left" style="display:none">
    <div class="card-head" style="margin-top:-8px">
      <h3 class="card-title">Товары</h3>
      <button id="add-product-left">+ Товар</button>
      <button class="ghost" id="close-products-left">Закрыть</button>
    </div>
    <div class="card-body">
      <div class="scroll-area" id="products-pane-left">
        <div class="pane-overlay"><div class="pane-spinner"></div></div>
        <table id="products-left-table">
          <colgroup>
            <col style="width:70px"><col style="width:420px"><col style="width:120px"><col style="width:140px"><col style="width:150px">
          </colgroup>
          <thead>
          <tr>
            <th>ID</th><th>Название</th><th>Цена</th><th>В наличии</th><th>Срок, дн.</th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="stats-left" style="display:none">
    <div class="card-head" style="margin-top:-8px">
      <h3 class="card-title">Статистика</h3>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input id="from-left" type="date"><input id="to-left" type="date">
        <select id="stat-status-left" title="Статус">
          <option value="">Статусы: все</option><option value="Выполнен">Только выполненные</option><option value="Новый">Только новые</option><option value="В работе">Только в работе</option><option value="Передан в доставку">Передан в доставку</option><option value="Критическое ожидание">Только критическое ожидание</option><option value="Отменен">Только отмененные</option>
        </select>
        <button id="load-stats-left" class="ghost">Показать</button>
        <button id="export-stats" class="ghost">Скачать Excel</button>
        <button class="ghost" id="close-stats-left">Закрыть</button>
      </div>
    </div>
    <div class="card-body">
      <div class="scroll-area" id="stats-pane-left" style="padding:12px">
        <div class="pane-overlay"><div class="pane-spinner"></div></div>
        <div id="stats-result-left" class="muted"></div>
        <div id="top-customers-left" class="muted" style="margin-top:8px"></div>
      </div>
    </div>
  </div>

  <div id="orders-left" style="display:none">
    <div class="card-head" style="margin-top:-8px">
      <h3 class="card-title">Заказы</h3>
      <select id="status-filter-left" title="Фильтр по статусу">
        <option value="">Все</option><option>Новый</option><option>В работе</option><option>Передан в доставку</option><option>Критическое ожидание</option><option>Выполнен</option><option>Отменен</option>
      </select>
      <button id="reload-orders-left" class="ghost">Обновить</button>
      <button id="export-orders-left" class="ghost">Скачать Excel</button>
      <button class="ghost" id="close-orders-left">Закрыть</button>
    </div>
    <div class="card-body">
      <div class="scroll-area" id="orders-left-pane">
        <div class="pane-overlay"><div class="pane-spinner"></div></div>
        <table id="orders-left-table">
          <colgroup>
            <col style="width:64px"><col style="width:120px"><col style="width:220px"><col style="width:90px"><col style="width:140px"><col style="width:160px">
          </colgroup>
          <thead>
            <tr>
              <th><span class="th-sort" data-col="id">№ <i class="carret"></i></span></th>
              <th><span class="th-sort" data-col="created_at">Дата <i class="carret"></i></span></th>
              <th><span class="th-sort" data-col="customer">Клиент <i class="carret"></i></span></th>
              <th><span class="th-sort" data-col="total">Сумма <i class="carret"></i></span></th>
              <th><span class="th-sort" data-col="status">Статус <i class="carret"></i></span></th>
              <th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="stock-left" style="display:none">
    <div class="card-head" style="margin-top:-8px">
      <h3 class="card-title">Учет товара</h3>
      <div class="stock-toolbar">
        <input id="stock-search-left" type="text" placeholder="Поиск товара">
        <button id="stock-refresh-left" class="ghost">Обновить</button>
        <button id="stock-history-left" class="ghost">История</button>
        <button id="stock-in-left">+ Приход</button>
        <button id="stock-adjust-left" class="ghost">Корректировка</button>
        <button id="stock-upd-left" class="ghost">УПД</button>
        <button class="ghost" id="close-stock-left">Закрыть</button>
      </div>
    </div>
    <div class="card-body">
      <div class="scroll-area" id="stock-pane-left">
        <div class="pane-overlay"><div class="pane-spinner"></div></div>
        <div id="stock-kpi-left" class="muted" style="padding:8px 8px 12px"></div>
        <table id="stock-left-table">
          <colgroup>
            <col style="width:8%"><col style="width:26%"><col style="width:10%"><col style="width:10%">
            <col style="width:10%"><col style="width:10%"><col style="width:16%">
          </colgroup>
          <thead>
          <tr>
            <th>ID</th><th>Название</th><th>Склад</th><th>Резерв</th><th>Доступно</th><th>Под заказ</th><th></th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="production-left" style="display:none">
    <div class="card-head" style="margin-top:-8px">
      <h3 class="card-title">Производство</h3>
      <div class="production-toolbar">
        <input id="production-no-left" type="text" placeholder="№ производства">
        <input id="production-order-left" type="number" min="1" step="1" placeholder="№ заказа">
        <input id="production-address-left" type="text" placeholder="Адрес">
        <input id="production-deadline-from-left" type="date" title="Дедлайн от">
        <input id="production-deadline-to-left" type="date" title="Дедлайн до">
        <select id="production-state-left" title="Статус">
          <option value="">Статус: все</option>
          <option value="draft">Черновик</option>
          <option value="confirmed">Подтвержден</option>
          <option value="in_work">В работе</option>
          <option value="ready">Готов</option>
          <option value="closed">Закрыт</option>
          <option value="cancelled">Отменен</option>
        </select>
        <button id="production-apply-left" class="ghost">Показать</button>
        <button id="production-add-left">+ Заказ</button>
        <button id="production-refresh-left" class="ghost">Обновить</button>
        <button class="ghost" id="close-production-left">Закрыть</button>
      </div>
    </div>
    <div class="card-body">
      <div class="scroll-area" id="production-pane-left">
        <div class="pane-overlay"><div class="pane-spinner"></div></div>
        <table id="production-left-table">
          <colgroup>
            <col style="width:150px"><col style="width:90px"><col style="width:220px"><col style="width:110px">
            <col style="width:120px"><col style="width:140px"><col style="width:90px"><col style="width:120px">
          </colgroup>
          <thead>
            <tr>
              <th>№ производства</th><th>Заказ</th><th>Адрес</th><th>Дедлайн</th>
              <th>Статус</th><th>Прогресс</th><th>Позиций</th><th></th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>

  <div id="dds-left" style="display:none">
    <div class="card-head" style="margin-top:-8px">
      <h3 class="card-title">ДДС</h3>
      <div style="margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
        <input id="dds-from-left" type="date">
        <input id="dds-to-left" type="date">
        <select id="dds-type-left" title="Тип">
          <option value="">Тип: все</option>
          <option value="income">Только приход</option>
          <option value="expense">Только расход</option>
        </select>
        <select id="dds-status-left" title="Статус">
          <option value="">Статус: все</option>
          <option value="active">Только активные</option>
          <option value="void">Только аннулированные</option>
        </select>
        <select id="dds-payment-left" title="Способ оплаты">
          <option value="">Оплата: все</option>
          <option value="cash">Наличные</option>
          <option value="card">Карта</option>
          <option value="transfer">Перевод</option>
          <option value="bank">Безнал</option>
        </select>
        <select id="dds-category-left" title="Категория">
          <option value="">Категория: все</option>
        </select>
        <button id="dds-apply-left" class="ghost">Показать</button>
        <button id="dds-export-left" class="ghost">Выгрузить Excel</button>
        <button id="dds-add-left">+ Проводка</button>
        <button class="ghost" id="close-dds-left">Закрыть</button>
      </div>
    </div>
    <div class="card-body">
      <div class="scroll-area" id="dds-pane-left">
        <div class="pane-overlay"><div class="pane-spinner"></div></div>
        <div id="dds-kpi-left" class="muted" style="padding:8px 8px 12px"></div>
        <table id="dds-left-table">
          <colgroup>
            <col style="width:90px"><col style="width:90px"><col style="width:110px"><col style="width:150px">
            <col style="width:110px"><col style="width:110px"><col style="width:80px"><col style="width:180px">
          </colgroup>
          <thead>
          <tr>
            <th>Дата</th><th>Тип</th><th>Сумма</th><th>Категория</th>
            <th>Оплата</th><th>Статус</th><th>Заказ</th><th></th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</section>

    <!-- ПРАВАЯ ПОЛОВИНА -->
    <section class="card" id="right-card">
      <div class="pane-overlay"><div class="pane-spinner"></div></div>

      <div id="right-menu">
        <h3 class="card-title" style="margin-bottom:12px">Разделы</h3>
        <div class="bigmenu">
          <button class="ghost" id="open-products">Товары</button>
          <button class="ghost" id="open-stats">Статистика</button>
          <button class="ghost" id="open-orders-right">Заказы</button>
          <button class="ghost" id="open-stock">Учет товара</button>
          <button class="ghost" id="open-production">Производство</button>
          <button class="ghost" id="open-dds">ДДС</button>
        </div>
      </div>

      <div id="products-right" style="display:none">
        <div class="card-head" style="margin-top:-8px">
          <h3 class="card-title">Товары</h3>
          <button id="add-product-right">+ Товар</button>
          <button class="ghost" id="close-products">Закрыть</button>
        </div>
        <div class="card-body">
          <div class="scroll-area" id="products-pane">
            <div class="pane-overlay"><div class="pane-spinner"></div></div>
            <table id="products-table">
              <colgroup>
                <col style="width:70px"><col style="width:420px"><col style="width:120px"><col style="width:140px"><col style="width:150px">
              </colgroup>
              <thead>
              <tr>
                <th>ID</th><th>Название</th><th>Цена</th><th>В наличии</th><th>Срок, дн.</th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="stats-right" style="display:none">
        <div class="card-head" style="margin-top:-8px">
          <h3 class="card-title">Статистика</h3>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="from" type="date"><input id="to" type="date">
            <select id="stat-status" title="Статус">
        <option value="">Статусы: все</option><option value="Выполнен">Только выполненные</option><option value="Новый">Только новые</option><option value="В работе">Только в работе</option><option value="Передан в доставку">Передан в доставку</option><option value="Критическое ожидание">Только критическое ожидание</option><option value="Отменен">Только отмененные</option>
            </select>
            <button id="load-stats" class="ghost">Показать</button>
            <button id="export-stats" class="ghost">Скачать Excel</button>
            <button class="ghost" id="close-stats">Закрыть</button>
          </div>
        </div>
        <div class="card-body">
          <div class="scroll-area" id="stats-pane" style="padding:12px">
            <div class="pane-overlay"><div class="pane-spinner"></div></div>
            <div id="stats-result" class="muted"></div>
            <div id="top-customers" class="muted" style="margin-top:8px"></div>
          </div>
        </div>
      </div>

      <div id="orders-right" style="display:none">
        <div class="card-head" style="margin-top:-8px">
          <h3 class="card-title">Заказы</h3>
          <select id="status-filter-right" title="Фильтр по статусу">
            <option value="">Все</option><option>Новый</option><option>В работе</option><option>Передан в доставку</option><option>Критическое ожидание</option><option>Выполнен</option><option>Отменен</option>
          </select>
          <button id="reload-orders-right" class="ghost">Обновить</button>
          <button id="export-orders-right" class="ghost">Скачать Excel</button>
          <button class="ghost" id="close-orders-right">Закрыть</button>
        </div>
        <div class="card-body">
          <div class="scroll-area" id="orders-right-pane">
            <div class="pane-overlay"><div class="pane-spinner"></div></div>
            <table id="orders-right-table">
              <colgroup>
                <col style="width:64px"><col style="width:120px"><col style="width:220px"><col style="width:90px"><col style="width:140px"><col style="width:160px">
              </colgroup>
              <thead>
                <tr>
                  <th><span class="th-sort" data-col="id">№ <i class="carret"></i></span></th>
                  <th><span class="th-sort" data-col="created_at">Дата <i class="carret"></i></span></th>
                  <th><span class="th-sort" data-col="customer">Клиент <i class="carret"></i></span></th>
                  <th><span class="th-sort" data-col="total">Сумма <i class="carret"></i></span></th>
                  <th><span class="th-sort" data-col="status">Статус <i class="carret"></i></span></th>
                  <th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="stock-right" style="display:none">
        <div class="card-head" style="margin-top:-8px">
          <h3 class="card-title">Учет товара</h3>
          <div class="stock-toolbar">
            <input id="stock-search-right" type="text" placeholder="Поиск товара">
            <button id="stock-refresh-right" class="ghost">Обновить</button>
            <button id="stock-history-right" class="ghost">История</button>
            <button id="stock-in-right">+ Приход</button>
            <button id="stock-adjust-right" class="ghost">Корректировка</button>
            <button id="stock-upd-right" class="ghost">УПД</button>
            <button class="ghost" id="close-stock-right">Закрыть</button>
          </div>
        </div>
        <div class="card-body">
          <div class="scroll-area" id="stock-pane-right">
            <div class="pane-overlay"><div class="pane-spinner"></div></div>
            <div id="stock-kpi-right" class="muted" style="padding:8px 8px 12px"></div>
            <table id="stock-right-table">
            <colgroup>
                <col style="width:8%"><col style="width:26%"><col style="width:10%"><col style="width:10%">
                <col style="width:10%"><col style="width:10%"><col style="width:16%">
              </colgroup>
              <thead>
              <tr>
                <th>ID</th><th>Название</th><th>Склад</th><th>Резерв</th><th>Доступно</th><th>Под заказ</th><th></th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="production-right" style="display:none">
        <div class="card-head" style="margin-top:-8px">
          <h3 class="card-title">Производство</h3>
          <div class="production-toolbar">
            <input id="production-no-right" type="text" placeholder="№ производства">
            <input id="production-order-right" type="number" min="1" step="1" placeholder="№ заказа">
            <input id="production-address-right" type="text" placeholder="Адрес">
            <input id="production-deadline-from-right" type="date" title="Дедлайн от">
            <input id="production-deadline-to-right" type="date" title="Дедлайн до">
            <select id="production-state-right" title="Статус">
              <option value="">Статус: все</option>
              <option value="draft">Черновик</option>
              <option value="confirmed">Подтвержден</option>
              <option value="in_work">В работе</option>
              <option value="ready">Готов</option>
              <option value="closed">Закрыт</option>
              <option value="cancelled">Отменен</option>
            </select>
            <button id="production-apply-right" class="ghost">Показать</button>
            <button id="production-add-right">+ Заказ</button>
            <button id="production-refresh-right" class="ghost">Обновить</button>
            <button class="ghost" id="close-production-right">Закрыть</button>
          </div>
        </div>
        <div class="card-body">
          <div class="scroll-area" id="production-pane-right">
            <div class="pane-overlay"><div class="pane-spinner"></div></div>
            <table id="production-right-table">
              <colgroup>
                <col style="width:150px"><col style="width:90px"><col style="width:220px"><col style="width:110px">
                <col style="width:120px"><col style="width:140px"><col style="width:90px"><col style="width:120px">
              </colgroup>
              <thead>
                <tr>
                  <th>№ производства</th><th>Заказ</th><th>Адрес</th><th>Дедлайн</th>
                  <th>Статус</th><th>Прогресс</th><th>Позиций</th><th></th>
                </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

      <div id="dds-right" style="display:none">
        <div class="card-head" style="margin-top:-8px">
          <h3 class="card-title">ДДС</h3>
          <div style="margin-left:auto;display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input id="dds-from-right" type="date">
            <input id="dds-to-right" type="date">
            <select id="dds-type-right" title="Тип">
              <option value="">Тип: все</option>
              <option value="income">Только приход</option>
              <option value="expense">Только расход</option>
            </select>
            <select id="dds-status-right" title="Статус">
              <option value="">Статус: все</option>
              <option value="active">Только активные</option>
              <option value="void">Только аннулированные</option>
            </select>
            <select id="dds-payment-right" title="Способ оплаты">
              <option value="">Оплата: все</option>
              <option value="cash">Наличные</option>
              <option value="card">Карта</option>
              <option value="transfer">Перевод</option>
              <option value="bank">Безнал</option>
            </select>
            <select id="dds-category-right" title="Категория">
              <option value="">Категория: все</option>
            </select>
            <button id="dds-apply-right" class="ghost">Показать</button>
            <button id="dds-export-right" class="ghost">Выгрузить Excel</button>
            <button id="dds-add-right">+ Проводка</button>
            <button class="ghost" id="close-dds-right">Закрыть</button>
          </div>
        </div>
        <div class="card-body">
          <div class="scroll-area" id="dds-pane-right">
            <div class="pane-overlay"><div class="pane-spinner"></div></div>
            <div id="dds-kpi-right" class="muted" style="padding:8px 8px 12px"></div>
            <table id="dds-right-table">
              <colgroup>
                <col style="width:90px"><col style="width:90px"><col style="width:110px"><col style="width:150px">
                <col style="width:110px"><col style="width:110px"><col style="width:80px"><col style="width:180px">
              </colgroup>
              <thead>
              <tr>
                <th>Дата</th><th>Тип</th><th>Сумма</th><th>Категория</th>
                <th>Оплата</th><th>Статус</th><th>Заказ</th><th></th>
              </tr>
              </thead>
              <tbody></tbody>
            </table>
          </div>
        </div>
      </div>

    </section>
  </div>
</div>

<!-- Модалка: состав заказа -->
<div class="modal-backdrop" id="order-modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="order-modal-title">
    <div class="modal-head">
      <h3 id="order-modal-title" class="card-title" style="margin:0">Состав заказа</h3>
      <button class="close-x" id="order-modal-close">✕</button>
    </div>
    <div class="scroll-area" style="max-height:72vh">
      <div style="padding:12px" id="order-modal-content"></div>
    </div>
  </div>
</div>

<!-- Модалка: заказ на производство -->
<div class="modal-backdrop" id="production-modal-backdrop" style="display:none">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="production-modal-title" style="width:min(1120px,96vw)">
    <div class="modal-head">
      <h3 id="production-modal-title" class="card-title" style="margin:0">Заказ на производство</h3>
      <button class="close-x" id="production-modal-close">✕</button>
    </div>
    <div class="scroll-area" style="max-height:72vh">
      <div style="padding:12px">
        <div class="order-section">
          <div class="list-title">Шапка заказа</div>
          <div class="adm-grid">
            <div class="adm-col">
              <div class="adm-field"><label>№ производства</label><input type="text" id="production-form-no" disabled></div>
              <div class="adm-field"><label>№ клиентского заказа</label><input type="number" id="production-form-order-id" min="1" step="1"></div>
              <div class="adm-field"><label>Адрес</label><input type="text" id="production-form-address"></div>
            </div>
            <div class="adm-col">
              <div class="adm-field"><label>Дедлайн</label><input type="date" id="production-form-deadline"></div>
              <div class="adm-field">
                <label>Статус</label>
                <select id="production-form-state">
                  <option value="draft">Черновик</option>
                  <option value="confirmed">Подтвержден</option>
                  <option value="in_work">В работе</option>
                  <option value="ready">Готов</option>
                  <option value="closed">Закрыт</option>
                  <option value="cancelled">Отменен</option>
                </select>
              </div>
              <div class="adm-field"><label>Комментарий</label><input type="text" id="production-form-comment"></div>
            </div>
          </div>
        </div>

        <div class="order-section">
          <div class="list-title">Позиции и стадии</div>
          <div id="production-items-wrap" style="display:grid;gap:10px"></div>
          <div style="margin-top:8px">
            <button class="ghost" id="production-item-add" type="button">+ Позиция</button>
          </div>
        </div>

        <div class="order-section">
          <div class="list-title">Чертежи и файлы</div>
          <div style="display:flex;gap:8px;align-items:center;flex-wrap:wrap">
            <input type="file" id="production-file-input" accept=".pdf,.png,.jpg,.jpeg,.dwg,.dxf">
            <button class="ghost" id="production-file-upload" type="button">Загрузить</button>
          </div>
          <div id="production-files-list" class="production-files" style="margin-top:8px"></div>
        </div>

        <div class="adm-actions">
          <button class="adm-btn adm-btn--accent" id="production-save">Сохранить</button>
          <button class="adm-btn adm-btn--ghost" id="production-close-btn">Закрыть</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Модалка: настройки -->
<div class="modal-backdrop" id="settings-modal-backdrop" style="display:none">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="settings-modal-title" style="width:min(980px,96vw)">
    <div class="modal-head">
      <h3 id="settings-modal-title" class="card-title" style="margin:0">Настройки</h3>
      <button class="close-x" id="settings-modal-close">✕</button>
    </div>
    <div class="scroll-area" style="max-height:72vh">
      <div style="padding:12px">
        <div class="order-section">
          <div class="list-title">Настройки продавца</div>
          <div class="adm-grid">
            <div class="adm-col">
              <div class="adm-field">
                <label>Тип продавца</label>
                <select id="set_seller_type">
                  <option value="org">Организация</option>
                  <option value="ip">ИП</option>
                </select>
              </div>
              <div class="adm-field"><label>Наименование / ФИО</label><input type="text" id="set_seller_name"></div>
              <div class="adm-field"><label>ИНН</label><input type="text" id="set_seller_inn"></div>
              <div class="adm-field"><label>КПП</label><input type="text" id="set_seller_kpp"></div>
              <div class="adm-field"><label>Адрес</label><input type="text" id="set_seller_address"></div>
            </div>
            <div class="adm-col">
              <div class="adm-field"><label>Телефон</label><input type="text" id="set_seller_phone"></div>
              <div class="adm-field"><label>Email</label><input type="text" id="set_seller_email"></div>
              <div class="adm-field"><label>Банк</label><input type="text" id="set_bank_name"></div>
              <div class="adm-field"><label>БИК</label><input type="text" id="set_bank_bik"></div>
              <div class="adm-field"><label>Корсчет</label><input type="text" id="set_bank_corr"></div>
              <div class="adm-field"><label>Расчетный счет</label><input type="text" id="set_bank_account"></div>
            </div>
          </div>
        </div>

        <div class="order-section">
          <div class="list-title">УПД по умолчанию</div>
          <div class="adm-grid">
            <div class="adm-col">
              <div class="adm-field">
                <label>Ставка НДС</label>
                <select id="set_vat_rate">
                  <option value="без НДС">без НДС</option>
                  <option value="0%">0%</option>
                  <option value="5%">5%</option>
                  <option value="7%">7%</option>
                  <option value="10%">10%</option>
                  <option value="20%">20%</option>
                  <option value="5/105">5/105</option>
                  <option value="7/107">7/107</option>
                  <option value="10/110">10/110</option>
                  <option value="20/120">20/120</option>
                  <option value="НДС исчисляется налоговым агентом">НДС исчисляется налоговым агентом</option>
                </select>
              </div>
              <div class="adm-field">
                <label><input type="checkbox" id="set_vat_included"> Цена включает НДС</label>
              </div>
              <div class="adm-field"><label>Ед. изм. (код)</label><input type="text" id="set_unit_code" placeholder="796"></div>
            </div>
            <div class="adm-col">
              <div class="adm-field"><label>Ед. изм. (название)</label><input type="text" id="set_unit_name" placeholder="шт"></div>
              <div class="adm-field"><label>Содержание операции</label><input type="text" id="set_operation_content" placeholder="Отгрузка товаров"></div>
              <div class="adm-field"><label>Основание документа</label><input type="text" id="set_basis_name" placeholder="Заказ"></div>
            </div>
          </div>
        </div>

        <div class="order-section">
          <div class="list-title">ЭДО (для имени XML)</div>
          <div class="adm-grid">
            <div class="adm-col">
              <div class="adm-field"><label>Код оператора ЭДО</label><input type="text" id="set_edi_operator" placeholder="000"></div>
            </div>
            <div class="adm-col">
              <div class="adm-field">
                <label>UID отправителя</label>
                <div style="display:flex; gap:8px; align-items:center">
                  <input type="text" id="set_edi_sender_uid" style="flex:1">
                  <button class="ghost" id="set_edi_sender_gen" type="button">Новый GUID</button>
                </div>
              </div>
            </div>
          </div>
          <div class="muted">Если не используете ЭДО — оставьте код «000», GUID сформируется автоматически.</div>
        </div>

        <div class="order-section">
          <div class="list-title">Уведомления о новых заявках</div>
          <div class="adm-grid">
            <div class="adm-col">
              <div class="adm-field">
                <label><input type="checkbox" id="set_notify_tg_enabled"> Включить Telegram-уведомления</label>
              </div>
              <div class="adm-field"><label>Bot token</label><input type="text" id="set_notify_tg_bot_token" placeholder="123456789:AA..."></div>
            </div>
            <div class="adm-col">
              <div class="adm-field"><label>Chat ID</label><input type="text" id="set_notify_tg_chat_id" placeholder="-1001234567890 или 123456789"></div>
              <div class="adm-field">
                <label>Проверка</label>
                <div style="display:flex; gap:8px; align-items:center">
                  <button class="ghost" id="set_notify_tg_test" type="button">Отправить тест</button>
                  <span class="muted" id="set_notify_tg_test_status"></span>
                </div>
              </div>
            </div>
          </div>
          <div class="muted">Чтобы узнать Chat ID, напишите боту @userinfobot или добавьте своего бота в нужный чат и получите ID через Bot API.</div>
          <div class="adm-grid" style="margin-top:10px">
            <div class="adm-col">
              <div class="adm-field">
                <label><input type="checkbox" id="set_notify_email_enabled"> Включить email-уведомления (заглушка)</label>
              </div>
              <div class="adm-field"><label>Email получателя</label><input type="email" id="set_notify_email_to" placeholder="you@domain.ru"></div>
            </div>
            <div class="adm-col">
              <div class="adm-field"><label>Тема письма</label><input type="text" id="set_notify_email_subject" placeholder="Новая заявка STILVA"></div>
              <div class="muted">SMTP и реальная отправка будут подключены отдельным шагом.</div>
            </div>
          </div>
        </div>

        <div class="order-section">
          <div class="list-title">Настройки сайта (SEO)</div>
          <div class="adm-grid">
            <div class="adm-col">
              <div class="adm-field"><label>Название сайта</label><input type="text" id="set_seo_site_name" placeholder="STILVA"></div>
              <div class="adm-field"><label>Title</label><input type="text" id="set_seo_title"></div>
              <div class="adm-field"><label>Description</label><textarea id="set_seo_description" rows="3"></textarea></div>
              <div class="adm-field"><label>Keywords</label><textarea id="set_seo_keywords" rows="2"></textarea></div>
            </div>
            <div class="adm-col">
              <div class="adm-field"><label>Canonical URL</label><input type="text" id="set_seo_canonical" placeholder="https://stilva.ru/"></div>
              <div class="adm-field">
                <label>Robots</label>
                <input type="text" id="set_seo_robots" placeholder="index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1">
              </div>
              <div class="adm-field"><label>OG Title</label><input type="text" id="set_seo_og_title"></div>
              <div class="adm-field"><label>OG Description</label><textarea id="set_seo_og_description" rows="2"></textarea></div>
              <div class="adm-field"><label>OG Image URL</label><input type="text" id="set_seo_og_image" placeholder="https://stilva.ru/pictures/1000x400x1800.png"></div>
              <div class="adm-field">
                <label>OG Type</label>
                <select id="set_seo_og_type">
                  <option value="website">website</option>
                  <option value="product">product</option>
                  <option value="article">article</option>
                </select>
              </div>
              <div class="adm-field"><label>OG Locale</label><input type="text" id="set_seo_og_locale" placeholder="ru_RU"></div>
              <div class="adm-field">
                <label>Twitter card</label>
                <select id="set_seo_twitter_card">
                  <option value="summary_large_image">summary_large_image</option>
                  <option value="summary">summary</option>
                </select>
              </div>
              <div class="adm-field"><label>Theme color</label><input type="text" id="set_seo_theme_color" placeholder="#f7f8fb"></div>
              <div class="adm-field"><label>Google verification</label><input type="text" id="set_seo_google_verification" placeholder="xxxxxxxxxxxxxxxxxx"></div>
              <div class="adm-field"><label>Yandex verification</label><input type="text" id="set_seo_yandex_verification" placeholder="xxxxxxxxxxxxxxxxxx"></div>
              <div class="adm-field"><label>Bing verification</label><input type="text" id="set_seo_bing_verification" placeholder="xxxxxxxxxxxxxxxxxx"></div>
              <div class="adm-field"><label>Google Analytics ID (G-...)</label><input type="text" id="set_seo_google_analytics_id" placeholder="G-XXXXXXXXXX"></div>
              <div class="adm-field"><label>Yandex Metrika ID</label><input type="text" id="set_seo_yandex_metrika_id" placeholder="12345678"></div>
            </div>
          </div>
          <div class="muted">Если поля OG и Twitter пустые — используются Title/Description. URL лучше задавать абсолютные.</div>
        </div>

        <div class="order-section">
          <div class="list-title">Главная страница</div>
          <div class="adm-grid">
            <div class="adm-col">
              <div class="adm-field"><label>Hero: надзаголовок</label><input type="text" id="set_home_hero_eyebrow"></div>
              <div class="adm-field"><label>Hero: заголовок</label><textarea id="set_home_hero_title" rows="2"></textarea></div>
              <div class="adm-field"><label>Hero: текст</label><textarea id="set_home_hero_lead" rows="3"></textarea></div>
              <div class="adm-field"><label>Hero: кнопка 1 (текст)</label><input type="text" id="set_home_hero_cta1_text"></div>
              <div class="adm-field"><label>Hero: кнопка 1 (ссылка)</label><input type="text" id="set_home_hero_cta1_link" placeholder="#catalog"></div>
              <div class="adm-field"><label>Hero: кнопка 2 (текст)</label><input type="text" id="set_home_hero_cta2_text"></div>
              <div class="adm-field"><label>Hero: кнопка 2 (ссылка)</label><input type="text" id="set_home_hero_cta2_link" placeholder="#specs"></div>
            </div>
            <div class="adm-col">
              <div class="adm-field"><label>Плюсы: заголовок</label><input type="text" id="set_home_benefits_title"></div>
              <div class="adm-field"><label>Плюсы: лид</label><textarea id="set_home_benefits_lead" rows="2"></textarea></div>
              <div class="adm-field"><label>Плюсы (строки: Заголовок | Текст)</label><textarea id="set_home_benefits_items" rows="6"></textarea></div>
              <div class="adm-field"><label>Характеристики: заголовок</label><input type="text" id="set_home_specs_title"></div>
              <div class="adm-field"><label>Характеристики: лид</label><textarea id="set_home_specs_lead" rows="2"></textarea></div>
              <div class="adm-field"><label>Характеристики (строки: Заголовок | Текст)</label><textarea id="set_home_specs_items" rows="6"></textarea></div>
            </div>
          </div>
          <div class="adm-grid">
            <div class="adm-col">
              <div class="adm-field"><label>Сферы применения: заголовок</label><input type="text" id="set_home_cases_title"></div>
              <div class="adm-field"><label>Сферы применения: лид</label><textarea id="set_home_cases_lead" rows="2"></textarea></div>
              <div class="adm-field"><label>Сферы применения (строки: Заголовок | Текст)</label><textarea id="set_home_cases_items" rows="6"></textarea></div>
            </div>
            <div class="adm-col">
              <div class="adm-field"><label>Типы стеллажей: заголовок</label><input type="text" id="set_home_types_title"></div>
              <div class="adm-field"><label>Типы стеллажей: лид</label><textarea id="set_home_types_lead" rows="2"></textarea></div>
              <div class="adm-field"><label>Типы стеллажей (строки: Заголовок | Текст)</label><textarea id="set_home_types_items" rows="6"></textarea></div>
            </div>
          </div>
          <div class="adm-grid">
            <div class="adm-col">
              <div class="adm-field"><label>FAQ: заголовок</label><input type="text" id="set_home_faq_title"></div>
              <div class="adm-field"><label>FAQ: лид</label><textarea id="set_home_faq_lead" rows="2"></textarea></div>
              <div class="adm-field"><label>FAQ (строки: Вопрос | Ответ)</label><textarea id="set_home_faq_items" rows="6"></textarea></div>
            </div>
            <div class="adm-col">
              <div class="adm-field"><label>Контакты: заголовок</label><input type="text" id="set_home_contacts_title"></div>
              <div class="adm-field"><label>Контакты: лид</label><textarea id="set_home_contacts_lead" rows="2"></textarea></div>
              <div class="adm-field"><label>Контакты: примечание</label><textarea id="set_home_contacts_note" rows="2"></textarea></div>
              <div class="adm-field"><label>Telegram: username</label><input type="text" id="set_home_tg_handle" placeholder="stilva_support"></div>
              <div class="adm-field"><label>WhatsApp: номер</label><input type="text" id="set_home_wa_phone" placeholder="79000000000"></div>
            </div>
          </div>
          <div class="adm-grid">
            <div class="adm-col">
              <div class="adm-field"><label>SEO-блок: заголовок</label><input type="text" id="set_home_seo_title"></div>
              <div class="adm-field"><label>SEO-блок: текст (абзацы разделяйте пустой строкой)</label><textarea id="set_home_seo_text" rows="8"></textarea></div>
            </div>
          </div>
          <div class="muted">Для списков используйте формат: Заголовок | Текст (одна строка — один элемент).</div>
        </div>

        <div class="adm-actions">
          <button class="adm-btn adm-btn--accent" id="settings-save">Сохранить</button>
          <button class="adm-btn adm-btn--ghost" id="settings-cancel">Закрыть</button>
        </div>
      </div>
    </div>
  </div>
</div>

<!-- Модалка: УПД -->
<div class="modal-backdrop" id="upd-modal-backdrop" style="display:none">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="upd-modal-title" style="width:min(980px,96vw)">
    <div class="modal-head">
      <h3 id="upd-modal-title" class="card-title" style="margin:0">УПД (отгрузка)</h3>
      <button class="close-x" id="upd-modal-close">✕</button>
    </div>
    <div style="padding:12px">
      <div class="order-section">
        <div class="list-title">Выбор заказа</div>
        <div class="adm-grid">
          <div class="adm-col">
            <div class="adm-field"><label>Номер заказа</label><input type="number" id="upd-order-id" min="1" step="1"></div>
          </div>
          <div class="adm-col" style="justify-content:flex-end">
            <button class="ghost" id="upd-load-order">Загрузить</button>
          </div>
        </div>
        <div id="upd-order-summary" class="muted" style="margin-top:8px">—</div>
      </div>

      <div id="upd-confirm-box" class="order-section" style="display:none">
        <div class="list-title">Подтверждение</div>
        <div style="display:flex; gap:8px; align-items:center; flex-wrap:wrap">
          <span>Создать УПД по выбранному заказу?</span>
          <button id="upd-confirm-yes">Да</button>
          <button class="ghost" id="upd-confirm-no">Нет</button>
        </div>
      </div>

      <div class="adm-actions">
        <button class="adm-btn adm-btn--accent" id="upd-create">Создать УПД</button>
        <button class="adm-btn adm-btn--ghost" id="upd-download-xml" disabled>Скачать XML</button>
        <button class="adm-btn adm-btn--ghost" id="upd-print" disabled>Печать</button>
        <button class="adm-btn adm-btn--ghost" id="upd-close">Закрыть</button>
      </div>
    </div>
  </div>
</div>

<!-- Модалка: полный товар -->
<div class="modal-backdrop" id="product-modal-backdrop">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="modal-title">
    <div class="modal-head">
      <h3 id="modal-title" class="card-title" style="margin:0">Карточка товара</h3>
      <button class="close-x" id="modal-close">✕</button>
    </div>
    <div class="scroll-area" style="max-height:72vh">
      <div style="padding:12px">
        <table id="product-full-table" style="width:100%">
          <colgroup>
            <col style="width:70px"><col style="width:220px"><col style="width:100px"><col style="width:70px">
            <col style="width:240px"><col style="width:90px"><col style="width:130px"><col style="width:140px">
            <col style="width:110px"><col style="width:110px"><col style="width:120px"><col style="width:130px">
            <col style="width:auto"><col style="width:180px">
          </colgroup>
          <thead>
          <tr>
            <th>ID</th><th>Название</th><th>Цена</th><th>Публ.</th><th>Фото URL</th><th>Полок</th>
            <th>Материал</th><th>Конструкция</th><th>Перфорация</th><th>Толщ., мм</th>
            <th>В наличии</th><th>Срок, дн.</th><th>Описание</th><th></th>
          </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Модалка: ДДС (проводка) -->
<div class="modal-backdrop" id="dds-modal-backdrop" style="display:none">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="dds-modal-title">
    <div class="modal-head">
      <h3 id="dds-modal-title" class="card-title" style="margin:0">Проводка</h3>
      <button class="close-x" id="dds-modal-close">✕</button>
    </div>
    <div style="padding:12px;display:grid;gap:10px">
      <div class="adm-grid">
        <div class="adm-col">
          <div class="adm-field">
            <label>Дата</label>
            <input type="date" id="dds_date">
          </div>
          <div class="adm-field">
            <label>Тип</label>
            <select id="dds_type">
              <option value="income">Приход</option>
              <option value="expense">Расход</option>
            </select>
          </div>
          <div class="adm-field">
            <label>Сумма, ₽</label>
            <input type="number" id="dds_amount" min="0" step="0.01" placeholder="0.00">
          </div>
        </div>
        <div class="adm-col">
          <div class="adm-field">
            <label>Категория</label>
            <select id="dds_category"></select>
          </div>
          <div class="adm-field">
            <label>Способ оплаты</label>
            <select id="dds_payment">
              <option value="cash">Наличные</option>
              <option value="card">Карта</option>
              <option value="transfer">Перевод</option>
              <option value="bank">Безнал</option>
            </select>
          </div>
          <div class="adm-field">
            <label>Комментарий</label>
            <textarea id="dds_comment" rows="4" placeholder="Например: аренда за месяц"></textarea>
          </div>
        </div>
      </div>
      <div class="adm-actions">
        <button class="adm-btn adm-btn--ghost" id="dds-modal-cancel">Отмена</button>
        <button class="adm-btn adm-btn--accent" id="dds-modal-save">Сохранить</button>
      </div>
    </div>
  </div>
</div>

<!-- Модалка: комментарий ДДС -->
<div class="modal-backdrop" id="dds-comment-backdrop" style="display:none">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="dds-comment-title" style="width:min(760px,96vw)">
    <div class="modal-head">
      <h3 id="dds-comment-title" class="card-title" style="margin:0">Комментарий</h3>
      <button class="close-x" id="dds-comment-close">✕</button>
    </div>
    <div style="padding:12px">
      <div id="dds-comment-body" style="white-space:pre-wrap;line-height:1.5"></div>
    </div>
  </div>
</div>

<!-- Модалка: приход товара -->
<div class="modal-backdrop" id="stock-in-backdrop" style="display:none">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="stock-in-title" style="width:min(980px,96vw)">
    <div class="modal-head">
      <h3 id="stock-in-title" class="card-title" style="margin:0">Приход товара</h3>
      <button class="close-x" id="stock-in-close">✕</button>
    </div>
    <div style="padding:12px">
      <div class="adm-grid">
        <div class="adm-col">
          <div class="adm-field">
            <label>Тип документа</label>
            <select id="stock-doc-type">
              <option value="invoice">Накладная</option>
              <option value="act">Акт</option>
              <option value="receipt">Квитанция</option>
              <option value="other">Другое</option>
            </select>
          </div>
          <div class="adm-field">
            <label>Номер документа</label>
            <input type="text" id="stock-doc-number" placeholder="Например: 123/А">
          </div>
          <div class="adm-field">
            <label>Дата документа</label>
            <input type="date" id="stock-doc-date">
          </div>
          <div class="adm-field">
            <label>Поставщик</label>
            <input type="text" id="stock-doc-supplier" placeholder="Компания или ИП">
          </div>
        </div>
        <div class="adm-col">
          <div class="adm-field">
            <label>Комментарий</label>
            <textarea id="stock-doc-comment" rows="4" placeholder="Любые детали (необязательно)"></textarea>
          </div>
          <div class="adm-field">
            <label>Файл документа (необязательно)</label>
            <div class="stock-file-row">
              <input type="file" id="stock-doc-file">
              <span class="stock-mini" id="stock-doc-file-label">Файл не выбран</span>
            </div>
          </div>
        </div>
      </div>

      <div style="margin-top:12px">
        <div class="stock-row stock-row--head">
          <div>Товар</div><div>Кол-во</div><div>Цена</div><div></div>
        </div>
        <div id="stock-in-items" class="stock-rows"></div>
        <div style="margin-top:8px">
          <button class="ghost" id="stock-in-add-row">+ Добавить позицию</button>
        </div>
      </div>

      <div class="adm-actions">
        <button class="adm-btn adm-btn--ghost" id="stock-in-cancel">Отмена</button>
        <button class="adm-btn adm-btn--accent" id="stock-in-save">Сохранить</button>
      </div>
    </div>
  </div>
</div>

<!-- Модалка: корректировка склада -->
<div class="modal-backdrop" id="stock-adjust-backdrop" style="display:none">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="stock-adjust-title" style="width:min(720px,96vw)">
    <div class="modal-head">
      <h3 id="stock-adjust-title" class="card-title" style="margin:0">Корректировка</h3>
      <button class="close-x" id="stock-adjust-close">✕</button>
    </div>
    <div style="padding:12px">
      <div class="adm-grid">
        <div class="adm-col">
          <div class="adm-field">
            <label>Товар</label>
            <select id="stock-adjust-product"></select>
          </div>
          <div class="adm-field">
            <label>Изменение, шт.</label>
            <input type="number" id="stock-adjust-qty" step="1" placeholder="Например: -2 или 5">
          </div>
        </div>
        <div class="adm-col">
          <div class="adm-field">
            <label>Комментарий</label>
            <textarea id="stock-adjust-comment" rows="4" placeholder="Причина корректировки (необязательно)"></textarea>
          </div>
        </div>
      </div>
      <div class="adm-actions">
        <button class="adm-btn adm-btn--ghost" id="stock-adjust-cancel">Отмена</button>
        <button class="adm-btn adm-btn--accent" id="stock-adjust-save">Сохранить</button>
      </div>
    </div>
  </div>
</div>

<!-- Модалка: движения по товару -->
<div class="modal-backdrop" id="stock-movements-backdrop" style="display:none">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="stock-movements-title" style="width:min(1100px,96vw)">
    <div class="modal-head">
      <h3 id="stock-movements-title" class="card-title" style="margin:0">История движений</h3>
      <button class="close-x" id="stock-movements-close">✕</button>
    </div>
    <div style="padding:12px">
      <div class="stock-movements-toolbar">
        <input type="text" id="stock-movements-search" placeholder="Поиск: товар, заказ, документ, комментарий">
        <select id="stock-movements-type">
          <option value="">Тип: все</option>
          <option value="in">Приход</option>
          <option value="out">Списание</option>
          <option value="reserve">Резерв</option>
          <option value="release">Снятие резерва</option>
          <option value="adjust">Корректировка</option>
        </select>
        <select id="stock-movements-reason">
          <option value="">Причина: все</option>
          <option value="purchase">Закупка</option>
          <option value="order">Заказ</option>
          <option value="writeoff">Списание</option>
          <option value="manual">Вручную</option>
          <option value="production">Производство</option>
        </select>
        <button class="ghost" id="stock-movements-refresh">Обновить</button>
      </div>
      <div class="scroll-area" id="stock-movements-pane" style="max-height:70vh">
        <div class="pane-overlay"><div class="pane-spinner"></div></div>
        <table id="stock-movements-table">
          <colgroup>
            <col style="width:140px"><col style="width:220px"><col style="width:140px"><col style="width:90px">
            <col style="width:120px"><col style="width:90px"><col style="width:90px"><col style="width:280px">
          </colgroup>
          <thead>
            <tr>
              <th>Дата</th><th>Товар</th><th>Тип</th><th>Кол-во</th><th>Причина</th>
              <th>Заказ</th><th>Док</th><th>Комментарий</th>
            </tr>
          </thead>
          <tbody></tbody>
        </table>
      </div>
    </div>
  </div>
</div>

<!-- Модалка: ДДС по приходу -->
<div class="modal-backdrop" id="stock-dds-backdrop" style="display:none">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="stock-dds-title" style="width:min(520px,96vw)">
    <div class="modal-head">
      <h3 id="stock-dds-title" class="card-title" style="margin:0">Расход в ДДС</h3>
      <button class="close-x" id="stock-dds-close">✕</button>
    </div>
    <div style="padding:12px">
      <div class="adm-field">
        <label>Дата</label>
        <input type="date" id="stock-dds-date">
      </div>
      <div class="adm-field">
        <label>Сумма, ₽</label>
        <input type="number" id="stock-dds-amount" min="0" step="0.01" placeholder="0.00">
      </div>
      <div class="adm-field">
        <label>Способ оплаты</label>
        <select id="stock-dds-payment">
          <option value="bank">Безнал</option>
          <option value="transfer">Перевод</option>
          <option value="card">Карта</option>
          <option value="cash">Наличные</option>
        </select>
      </div>
      <div class="adm-field">
        <label>Комментарий (необязательно)</label>
        <input type="text" id="stock-dds-comment" placeholder="Например: закупка по накладной">
      </div>
      <div class="adm-actions">
        <button class="adm-btn adm-btn--ghost" id="stock-dds-cancel">Не вносить</button>
        <button class="adm-btn adm-btn--accent" id="stock-dds-save">Внести в ДДС</button>
      </div>
    </div>
  </div>
</div>

<!-- Модалка: подтверждения ДДС -->
<div class="modal-backdrop" id="stock-dds-confirm-backdrop" style="display:none">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="stock-dds-confirm-title" style="width:min(520px,96vw)">
    <div class="modal-head">
      <h3 id="stock-dds-confirm-title" class="card-title" style="margin:0">ДДС</h3>
      <button class="close-x" id="stock-dds-confirm-close">✕</button>
    </div>
    <div style="padding:12px">
      <div id="stock-dds-confirm-text" style="line-height:1.5"></div>
      <div class="adm-actions">
        <button class="adm-btn adm-btn--ghost" id="stock-dds-confirm-secondary">Нет</button>
        <button class="adm-btn adm-btn--accent" id="stock-dds-confirm-primary">Да</button>
      </div>
    </div>
  </div>
</div>

<script>
  /* API */
  window.api = async (path, opts = {}) => {
    const res = await fetch(path, {
      credentials: 'include',
      headers: { 'Content-Type': 'application/json', 'x-dev-auth': '1', ...(opts.headers||{}) },
      ...opts
    });
    return res;
  };

  /* Вуаль */
  function findOverlayHost(el){ const pane = el.closest?.('.scroll-area'); if(pane) return pane; const card = el.closest?.('.card'); if(card) return card; return document.body; }
  function showPaneOverlay(el){ const host=findOverlayHost(el); const ov=host.querySelector(':scope > .pane-overlay')||host.querySelector('.pane-overlay'); if(ov) ov.classList.add('active') }
  function hidePaneOverlay(el){ const host=findOverlayHost(el); const ov=host.querySelector(':scope > .pane-overlay')||host.querySelector('.pane-overlay'); if(ov) ov.classList.remove('active') }
  async function withOverlay(el, fn){ try{ showPaneOverlay(el); return await fn(); } finally{ hidePaneOverlay(el); } }

/* ==== Cancel helpers ==== */
const CANCEL_STAMP_PREFIX = 'ОТМЕНЕН ПО ПРИЧИНЕ:';
function hasCancelStampLine(line){ return /^ОТМЕНЕН\s+ПО\s+ПРИЧИНЕ\s*:/i.test((line||'').trim()); }
function addCancelStampToNote(prevNote, reason){
  const clean = (prevNote||'').split(/\r?\n/).filter(l => !hasCancelStampLine(l));
  const head = (CANCEL_STAMP_PREFIX + ' ' + reason).trim();
  const tail = clean.filter(l => l.trim() !== '');
  return [head, ...tail].join('\n');
}
function removeCancelStampFromNote(prevNote){
  return (prevNote||'').split(/\r?\n/).filter(l => !hasCancelStampLine(l)).join('\n');
}
function extractCancelReasonFromNote(note){
  const m = (note||'').match(/ОТМЕНЕН\s+ПО\s+ПРИЧИНЕ\s*:\s*(.+)/i);
  return m ? m[1].trim() : '';
}

/* ==== LocalStorage cache for cancel_reason ==== */
const LS_KEY = 'cancel_reasons_v1';
function readCRMap(){ try{ return JSON.parse(localStorage.getItem(LS_KEY) || '{}'); }catch(_){ return {}; } }
function writeCRMap(map){ try{ localStorage.setItem(LS_KEY, JSON.stringify(map)); }catch(_){} }
function setLocalCancel(id, reason, note){ const map = readCRMap(); map[id] = { reason: String(reason||'').trim(), note: String(note||''), ts: Date.now() }; writeCRMap(map); }
function clearLocalCancel(id){ const map = readCRMap(); if(map[id]){ delete map[id]; writeCRMap(map); } }
function mergeLocalCancels(list){
  const map = readCRMap();
  for(const o of list){
    if(!o) continue;
    const id = String(o.id);
    if((o.status === 'Отменен') && (!o.cancel_reason || !o.note)){
      if(map[id]){
        if(!o.cancel_reason) o.cancel_reason = map[id].reason;
        if(!o.note) o.note = map[id].note;
      }
    }else if(o.cancel_reason){
      setLocalCancel(id, o.cancel_reason, o.note || '');
    }else if(o.status !== 'Отменен'){
      clearLocalCancel(id);
    }
  }
}

/* ===== ЗАКАЗЫ ===== */
let ordersCache = [];
let currentSortLeft = {col:null, dir:1};
let currentSortRight = {col:null, dir:1};

function sortOrders(list, sort){
  const dir = sort.dir; const col=sort.col; if(!col) return list;
  const getVal = (o)=>{
    if(col==='id') return Number(o.id)||0;
    if(col==='created_at') return o.created_at ? new Date(o.created_at).getTime() : 0;
    if(col==='customer') return (o.customer_name||'') + (o.phone||'') + (o.email||'');
    if(col==='total') return Number(o.total)||0;
    if(col==='status') return o.status||'';
    return 0;
  };
  return [...list].sort((a,b)=>{ const av=getVal(a), bv=getVal(b); if(av<bv) return -1*dir; if(av>bv) return 1*dir; return 0; });
}

function renderOrderRow(o){
  const tr=document.createElement('tr');
  tr.innerHTML =
    '<td class="cell-ellipsis">'+(o.id||'–')+'</td>'+
    '<td class="cell-wrap">'+(o.created_at ? new Date(o.created_at).toLocaleString() : '—')+'</td>'+
    '<td class="cell-wrap">'+[(o.customer_name||''),(o.phone||''),(o.email||'')].filter(Boolean).join(' / ')+'</td>'+
    '<td class="cell-wrap">'+(o.total||0)+'</td>'+
    '<td><select data-id="'+o.id+'" class="status-select">' + ['Новый','В работе','Передан в доставку','Критическое ожидание','Выполнен','Отменен'].map(s=>'<option '+(s===(o.status||'')?'selected':'')+'>'+s+'</option>').join('') + '</select></td>'+
    '<td class="actions"><div class="btns"><button class="ghost open-order" data-id="'+o.id+'">Открыть заказ</button><button class="danger del-order" data-id="'+o.id+'">Удалить</button></div></td>';
  return tr;
}


function statusClass(s){
  if(s==='Новый') return 'status-new';
  if(s==='В работе') return 'status-inprogress';
  if(s==='Передан в доставку') return 'status-delivery';
  if(s==='Критическое ожидание') return 'status-critical';
  if(s==='Отменен') return 'status-cancelled';
  return '';
}
function applyRowStatusClass(tr, status){
  if(!tr) return;
  tr.classList.remove('status-new','status-inprogress','status-delivery','status-critical','status-cancelled');
  const c = statusClass(status||'');
  if(c) tr.classList.add(c);
}



async function loadOrdersInto(tbodySel, paneId, statusFilterId, sortState){
  const tbody=document.querySelector(tbodySel);
  const pane=document.getElementById(paneId);
  const filterEl=document.getElementById(statusFilterId);
  if(!tbody||!pane) return;
  const cols=document.querySelector('#'+paneId+' table colgroup').children.length;
  tbody.innerHTML=skeletonRows(cols,8);
  await withOverlay(pane, async ()=>{
    const prevCache = ordersCache.slice();
    const res=await api('/api/orders'); 
    const fresh = res.ok ? await res.json() : [];
    mergeLocalCancels(fresh);
    const byIdPrev = new Map(prevCache.map(o=>[String(o.id), o]));
    for(const o of fresh){
      const pid = String(o.id);
      const prev = byIdPrev.get(pid);
      if(prev && o.status === 'Отменен'){
        if(!o.cancel_reason && prev.cancel_reason){ o.cancel_reason = prev.cancel_reason; }
        if(!o.note && prev.note){ o.note = prev.note; }
      }
    }
    ordersCache = fresh;

    const status=filterEl?filterEl.value:'';
    let data=status?ordersCache.filter(o=>(o.status||'')===status):ordersCache.slice();
    data=sortOrders(data, sortState);
    tbody.innerHTML='';
    data.forEach(o=>{ const tr = renderOrderRow(o); applyRowStatusClass(tr, o.status||''); tbody.appendChild(tr); });

    tbody.querySelectorAll('.status-select').forEach(sel=>{
      sel.addEventListener('change', async e=>{
        const id=e.target.dataset.id, newStatus=e.target.value;
        const prevOrder = ordersCache.find(x=>String(x.id)===String(id));
        const prevStatus = prevOrder ? (prevOrder.status || '') : '';
        await withOverlay(e.target, async ()=>{
          if (newStatus === 'Выполнен'){
            try{
              const resCheck = await api('/api/orders/'+id);
              const full = resCheck.ok ? await resCheck.json() : null;
              const payAmount = full && full.payment_amount != null ? parseFloat(full.payment_amount) : 0;
              const payMethod = full && full.payment_method ? String(full.payment_method) : '';
              const okMethod = ['cash','card','transfer','bank'].includes(payMethod);
              if (!okMethod || !(payAmount > 0)){
                alert('Перед установкой статуса \"Выполнен\" заполните сумму оплаты и способ оплаты в карточке заказа.');
                e.target.value = prevStatus || '';
                applyRowStatusClass(e.target.closest('tr'), prevStatus || '');
                openOrderById(id);
                return;
              }
            }catch(_){
              // если не удалось проверить — не ставим статус
              alert('Не удалось проверить оплату. Откройте карточку заказа и заполните оплату.');
              e.target.value = prevStatus || '';
              applyRowStatusClass(e.target.closest('tr'), prevStatus || '');
              return;
            }
          }
          const resp = await api('/api/orders/'+id+'/status',{method:'PATCH', body: JSON.stringify({status:newStatus})});
          if (!resp.ok){
            const text = await resp.text();
            if (text && text.includes('payment_required')){
              alert('Перед установкой статуса \"Выполнен\" заполните сумму оплаты и способ оплаты в карточке заказа.');
              openOrderById(id);
            } else {
              alert('Не удалось изменить статус');
            }
            e.target.value = prevStatus || '';
            applyRowStatusClass(e.target.closest('tr'), prevStatus || '');
            return;
          }
          const idx=ordersCache.findIndex(x=>String(x.id)===String(id)); if(idx>-1) ordersCache[idx].status=newStatus; applyRowStatusClass(e.target.closest('tr'), newStatus);
          ddsRefreshOpen();
          stockRefreshOpen();
        });
      });
    });
    tbody.querySelectorAll('.del-order').forEach(btn=>{
      btn.addEventListener('click', async e=>{
        const id=e.target.dataset.id;
        if(confirm('Удалить заказ '+id+'?')){
          await withOverlay(e.target, async ()=>{
            await api('/api/orders/'+id,{method:'DELETE'});
            ordersCache = ordersCache.filter(x=>String(x.id)!==String(id));
            clearLocalCancel(String(id));
            await loadOrdersInto(tbodySel,paneId,statusFilterId,sortState);
          });
        }
      });
    });
    tbody.querySelectorAll('.open-order').forEach(btn=>{
      btn.addEventListener('click', e=>{
        const id=e.target.dataset.id;
        openOrderById(id);
      });
    });
  });
}

function wireOrderSort(tableSelector, sortState, refreshFn){
  const table=document.querySelector(tableSelector);
  table.querySelectorAll('thead .th-sort').forEach(h=>{
    h.addEventListener('click', ()=>{
      const col=h.dataset.col;
      if(sortState.col===col) sortState.dir*=-1; else {sortState.col=col; sortState.dir=1;}
      table.querySelectorAll('.th-sort').forEach(x=>x.classList.remove('asc','desc'));
      h.classList.add(sortState.dir===1?'asc':'desc');
      refreshFn();
    });
  });
}

/* Модалка заказа */
const orderModalBackdrop=document.getElementById('order-modal-backdrop');
const orderModalClose=document.getElementById('order-modal-close');
const orderModalContent=document.getElementById('order-modal-content');

function openOrderModal(order){
  const items=Array.isArray(order.items)?order.items:[];
  const rows=items.map(it=>{
    const name=it&&it.name?String(it.name):'Товар';
    const qty=Number(it&&it.qty)||1;
    const price=Number(it&&it.price)||0;
    const sum=qty*price;
    return `<div>${name}</div><div>${qty}</div><div>${price}</div><div>${sum}</div>`;
  }).join('');
  const availabilityRows = items.map(it=>{
    const name=it&&it.name?String(it.name):'Товар';
    const qty=Number(it&&it.qty)||1;
    const availRaw = (it && it.available_qty != null) ? Number(it.available_qty) : null;
    const avail = Number.isFinite(availRaw) ? Math.max(0, availRaw) : null;
    const shortage = (it && it.shortage_qty != null) ? Number(it.shortage_qty) : null;
    let statusHtml = '<span class="order-badge warn">—</span>';
    if (avail != null){
      statusHtml = (shortage && shortage > 0)
        ? `<span class="order-badge warn">Не хватает: ${shortage}</span>`
        : `<span class="order-badge ok">Хватает</span>`;
    }
    return `<div>${name}</div><div>${qty}</div><div>${avail != null ? avail : '—'}</div><div>${statusHtml}</div>`;
  }).join('');
  const _noteRaw=(order.note||'').trim();
  const _reason=(order.cancel_reason||'').trim() || extractCancelReasonFromNote(_noteRaw);
  const reasonHtml = _reason ? `<div class="cancel-note">Отменен по причине: ${_reason}</div>` : '';
  const otherNote = removeCancelStampFromNote(_noteRaw).trim();
  const noteHtml = (otherNote ? `<div class="muted" style="margin-top:10px">Примечание: ${otherNote}</div>` : '') + reasonHtml;
  const total = Number(order.total)||0;
  const payStatus = (order.payment_status || 'unpaid');
  const payAmount = (order.payment_amount != null) ? Number(order.payment_amount) : 0;
  const payMethod = order.payment_method || 'bank';
  const payDate = order.payment_date || '';
  const deliveryType = order.delivery_type || 'pickup';
  const deliveryAddress = order.delivery_address || '';
  const updBuyerType = order.upd_buyer_type || 'org';
  const updBuyerName = order.upd_buyer_name || order.customer_name || '';
  const updBuyerInn = order.upd_buyer_inn || '';
  const updBuyerKpp = order.upd_buyer_kpp || '';
  const updBuyerAddr = order.upd_buyer_address || order.delivery_address || '';
  const updBuyerOther = order.upd_buyer_other || '';
  const updShipperSame = order.upd_shipper_same == null ? 1 : Number(order.upd_shipper_same);
  const updShipperName = order.upd_shipper_name || '';
  const updShipperInn = order.upd_shipper_inn || '';
  const updShipperKpp = order.upd_shipper_kpp || '';
  const updShipperAddr = order.upd_shipper_address || '';
  const updConsSame = order.upd_consignee_same == null ? 1 : Number(order.upd_consignee_same);
  const updConsName = order.upd_consignee_name || updBuyerName || '';
  const updConsAddr = order.upd_consignee_address || updBuyerAddr || '';
  const updDocDate = order.upd_doc_date || new Date().toISOString().slice(0,10);
  const updVatRate = order.upd_vat_rate || 'без НДС';
  const updVatIncluded = !!order.upd_vat_included;
  const updSigner1Fio = order.upd_signer1_fio || '';
  const updSigner1Pos = order.upd_signer1_pos || '';
  const updSigner1Type = order.upd_signer1_type || '1';
  const updSigner1Authority = order.upd_signer1_authority || '1';
  const updSigner1Date = order.upd_signer1_date || updDocDate;
  const updSigner2Fio = order.upd_signer2_fio || '';
  const updSigner2Pos = order.upd_signer2_pos || '';
  const updSigner2Type = order.upd_signer2_type || '1';
  const updSigner2Authority = order.upd_signer2_authority || '1';
  const updSigner2Date = order.upd_signer2_date || updDocDate;
  const checklist = {
    contacted: !!order.checklist_contacted,
    confirmed: !!order.checklist_confirmed,
    picked: !!order.checklist_picked,
    shipped: !!order.checklist_shipped,
    docs: !!order.checklist_docs
  };
  orderModalContent.innerHTML = `
    <div class="order-section">
      <div class="list-title">Данные клиента</div>
      <div class="adm-grid">
        <div class="adm-col">
          <div class="adm-field"><label>Имя</label><input type="text" id="o_customer_name" value="${(order.customer_name||'').replace(/"/g,'&quot;')}"></div>
          <div class="adm-field"><label>Телефон</label><input type="text" id="o_phone" value="${(order.phone||'').replace(/"/g,'&quot;')}"></div>
        </div>
        <div class="adm-col">
          <div class="adm-field"><label>Email</label><input type="text" id="o_email" value="${(order.email||'').replace(/"/g,'&quot;')}"></div>
        </div>
      </div>
    </div>
    <div class="mini-table">
      <div class="head">Наименование</div><div class="head">Кол-во</div><div class="head">Цена</div><div class="head">Сумма</div>
      ${rows || '<div>—</div><div></div><div></div><div></div>'}
    </div>
    <div style="margin-top:12px"><strong>Итого по заказу:</strong> ${total} ₽</div>
    ${noteHtml}
    <div class="order-section">
      <div class="list-title" style="display:flex;align-items:center;justify-content:space-between;gap:8px">
        <span>Наличие по позициям</span>
        <button class="ghost" id="o_to_production" type="button">В производство</button>
      </div>
      <div class="order-availability">
        <div class="head">Товар</div><div class="head">Нужно</div><div class="head">Доступно</div><div class="head">Статус</div>
        ${availabilityRows || '<div>—</div><div></div><div></div><div></div>'}
      </div>
    </div>
    <div class="order-section">
      <div class="list-title">Доставка</div>
      <div class="adm-grid">
        <div class="adm-col">
          <div class="adm-field">
            <label>Способ</label>
            <select id="o_delivery_type">
              <option value="pickup" ${deliveryType==='pickup'?'selected':''}>Самовывоз</option>
              <option value="delivery" ${deliveryType==='delivery'?'selected':''}>Доставка</option>
            </select>
          </div>
        </div>
        <div class="adm-col">
          <div class="adm-field">
            <label>Адрес доставки</label>
            <input type="text" id="o_delivery_address" value="${String(deliveryAddress||'').replace(/"/g,'&quot;')}">
          </div>
        </div>
      </div>
    </div>
    <div class="order-section">
      <div class="list-title">Оплата</div>
      <div class="adm-grid">
        <div class="adm-col">
          <div class="adm-field">
            <label>Статус оплаты</label>
            <select id="o_payment_status">
              <option value="unpaid" ${payStatus==='unpaid'?'selected':''}>Не оплачено</option>
              <option value="partial" ${payStatus==='partial'?'selected':''}>Частично</option>
              <option value="paid" ${payStatus==='paid'?'selected':''}>Оплачено</option>
            </select>
          </div>
          <div class="adm-field">
            <label>Сумма оплаты, ₽</label>
            <input type="number" id="o_payment_amount" min="0" step="0.01" value="${Number.isFinite(payAmount)?payAmount:''}">
          </div>
        </div>
        <div class="adm-col">
          <div class="adm-field">
            <label>Дата оплаты</label>
            <input type="date" id="o_payment_date" value="${payDate}">
          </div>
          <div class="adm-field">
            <label>Способ оплаты</label>
            <select id="o_payment_method">
              <option value="bank" ${payMethod==='bank'?'selected':''}>Безнал</option>
              <option value="transfer" ${payMethod==='transfer'?'selected':''}>Перевод</option>
              <option value="card" ${payMethod==='card'?'selected':''}>Карта</option>
              <option value="cash" ${payMethod==='cash'?'selected':''}>Наличные</option>
            </select>
          </div>
        </div>
      </div>
    </div>
    <div class="order-section">
      <div class="list-title">УПД (отгрузка)</div>
      <div class="adm-grid">
        <div class="adm-col">
          <div class="adm-field">
            <label>Тип покупателя</label>
            <select id="o_upd_buyer_type">
              <option value="org" ${updBuyerType==='org'?'selected':''}>Организация</option>
              <option value="ip" ${updBuyerType==='ip'?'selected':''}>ИП</option>
              <option value="person" ${updBuyerType==='person'?'selected':''}>Физлицо</option>
            </select>
          </div>
          <div class="adm-field"><label>Наименование / ФИО покупателя</label><input type="text" id="o_upd_buyer_name" value="${String(updBuyerName).replace(/"/g,'&quot;')}"></div>
          <div class="adm-field"><label>ИНН покупателя</label><input type="text" id="o_upd_buyer_inn" value="${String(updBuyerInn).replace(/"/g,'&quot;')}"></div>
          <div class="adm-field"><label>КПП покупателя</label><input type="text" id="o_upd_buyer_kpp" value="${String(updBuyerKpp).replace(/"/g,'&quot;')}"></div>
          <div class="adm-field"><label>Адрес покупателя</label><input type="text" id="o_upd_buyer_address" value="${String(updBuyerAddr).replace(/"/g,'&quot;')}"></div>
          <div class="adm-field"><label>Иные сведения (физлицо)</label><input type="text" id="o_upd_buyer_other" value="${String(updBuyerOther).replace(/"/g,'&quot;')}"></div>
        </div>
        <div class="adm-col">
          <div class="adm-field"><label>Дата УПД</label><input type="date" id="o_upd_doc_date" value="${String(updDocDate).replace(/"/g,'&quot;')}"></div>
          <div class="adm-field">
            <label>Ставка НДС</label>
            <select id="o_upd_vat_rate">
              <option value="без НДС" ${updVatRate==='без НДС'?'selected':''}>без НДС</option>
              <option value="0%" ${updVatRate==='0%'?'selected':''}>0%</option>
              <option value="5%" ${updVatRate==='5%'?'selected':''}>5%</option>
              <option value="7%" ${updVatRate==='7%'?'selected':''}>7%</option>
              <option value="10%" ${updVatRate==='10%'?'selected':''}>10%</option>
              <option value="20%" ${updVatRate==='20%'?'selected':''}>20%</option>
              <option value="5/105" ${updVatRate==='5/105'?'selected':''}>5/105</option>
              <option value="7/107" ${updVatRate==='7/107'?'selected':''}>7/107</option>
              <option value="10/110" ${updVatRate==='10/110'?'selected':''}>10/110</option>
              <option value="20/120" ${updVatRate==='20/120'?'selected':''}>20/120</option>
              <option value="НДС исчисляется налоговым агентом" ${updVatRate==='НДС исчисляется налоговым агентом'?'selected':''}>НДС исчисляется налоговым агентом</option>
            </select>
          </div>
          <div class="adm-field">
            <label><input type="checkbox" id="o_upd_vat_included" ${updVatIncluded?'checked':''}> Цена включает НДС</label>
          </div>
        </div>
      </div>

      <div class="adm-grid" style="margin-top:8px">
        <div class="adm-col">
          <div class="adm-field">
            <label><input type="checkbox" id="o_upd_shipper_same" ${updShipperSame ? 'checked':''}> Грузоотправитель = продавец</label>
          </div>
          <div class="adm-field"><label>Грузоотправитель (наименование)</label><input type="text" id="o_upd_shipper_name" value="${String(updShipperName).replace(/"/g,'&quot;')}"></div>
          <div class="adm-field"><label>ИНН грузоотправителя</label><input type="text" id="o_upd_shipper_inn" value="${String(updShipperInn).replace(/"/g,'&quot;')}"></div>
          <div class="adm-field"><label>КПП грузоотправителя</label><input type="text" id="o_upd_shipper_kpp" value="${String(updShipperKpp).replace(/"/g,'&quot;')}"></div>
          <div class="adm-field"><label>Адрес грузоотправителя</label><input type="text" id="o_upd_shipper_address" value="${String(updShipperAddr).replace(/"/g,'&quot;')}"></div>
        </div>
        <div class="adm-col">
          <div class="adm-field">
            <label><input type="checkbox" id="o_upd_consignee_same" ${updConsSame ? 'checked':''}> Грузополучатель = покупатель</label>
          </div>
          <div class="adm-field"><label>Грузополучатель (наименование)</label><input type="text" id="o_upd_consignee_name" value="${String(updConsName).replace(/"/g,'&quot;')}"></div>
          <div class="adm-field"><label>Адрес грузополучателя</label><input type="text" id="o_upd_consignee_address" value="${String(updConsAddr).replace(/"/g,'&quot;')}"></div>
        </div>
      </div>

      <div class="order-section" style="margin-top:8px">
        <div class="list-title">Подписанты (ЭП)</div>
        <div class="adm-grid">
          <div class="adm-col">
            <div class="adm-field"><label>Подписант 1 (ФИО)</label><input type="text" id="o_upd_signer1_fio" value="${String(updSigner1Fio).replace(/"/g,'&quot;')}"></div>
            <div class="adm-field"><label>Должность</label><input type="text" id="o_upd_signer1_pos" value="${String(updSigner1Pos).replace(/"/g,'&quot;')}"></div>
            <div class="adm-field">
              <label>Тип подписи</label>
              <select id="o_upd_signer1_type">
                <option value="1" ${updSigner1Type==='1'?'selected':''}>КЭП</option>
                <option value="2" ${updSigner1Type==='2'?'selected':''}>Простая ЭП</option>
                <option value="3" ${updSigner1Type==='3'?'selected':''}>НЭП</option>
              </select>
            </div>
            <div class="adm-field">
              <label>Подтверждение полномочий</label>
              <select id="o_upd_signer1_authority">
                <option value="1" ${updSigner1Authority==='1'?'selected':''}>По ЭП</option>
                <option value="2" ${updSigner1Authority==='2'?'selected':''}>МЧД в пакете</option>
                <option value="6" ${updSigner1Authority==='6'?'selected':''}>Иное</option>
              </select>
            </div>
            <div class="adm-field"><label>Дата подписания</label><input type="date" id="o_upd_signer1_date" value="${String(updSigner1Date).replace(/"/g,'&quot;')}"></div>
          </div>
          <div class="adm-col">
            <div class="adm-field"><label>Подписант 2 (ФИО)</label><input type="text" id="o_upd_signer2_fio" value="${String(updSigner2Fio).replace(/"/g,'&quot;')}"></div>
            <div class="adm-field"><label>Должность</label><input type="text" id="o_upd_signer2_pos" value="${String(updSigner2Pos).replace(/"/g,'&quot;')}"></div>
            <div class="adm-field">
              <label>Тип подписи</label>
              <select id="o_upd_signer2_type">
                <option value="1" ${updSigner2Type==='1'?'selected':''}>КЭП</option>
                <option value="2" ${updSigner2Type==='2'?'selected':''}>Простая ЭП</option>
                <option value="3" ${updSigner2Type==='3'?'selected':''}>НЭП</option>
              </select>
            </div>
            <div class="adm-field">
              <label>Подтверждение полномочий</label>
              <select id="o_upd_signer2_authority">
                <option value="1" ${updSigner2Authority==='1'?'selected':''}>По ЭП</option>
                <option value="2" ${updSigner2Authority==='2'?'selected':''}>МЧД в пакете</option>
                <option value="6" ${updSigner2Authority==='6'?'selected':''}>Иное</option>
              </select>
            </div>
            <div class="adm-field"><label>Дата подписания</label><input type="date" id="o_upd_signer2_date" value="${String(updSigner2Date).replace(/"/g,'&quot;')}"></div>
          </div>
        </div>
      </div>
      <div class="adm-actions" style="justify-content:flex-start;gap:8px;flex-wrap:wrap">
        <button class="adm-btn adm-btn--accent" id="o_upd_create">Создать УПД</button>
        <button class="adm-btn adm-btn--ghost" id="o_upd_xml" disabled>Скачать XML</button>
        <button class="adm-btn adm-btn--ghost" id="o_upd_print" disabled>Печать</button>
        <span id="o_upd_status" class="muted"></span>
      </div>
    </div>
    <div class="order-section">
      <div class="list-title">Чек-лист</div>
      <div class="order-checklist">
        <label><input type="checkbox" id="o_check_contacted" ${checklist.contacted?'checked':''}> Связались с клиентом</label>
        <label><input type="checkbox" id="o_check_confirmed" ${checklist.confirmed?'checked':''}> Подтверждение заказа</label>
        <label><input type="checkbox" id="o_check_picked" ${checklist.picked?'checked':''}> Комплектация выполнена</label>
        <label><input type="checkbox" id="o_check_shipped" ${checklist.shipped?'checked':''}> Отгрузка / самовывоз завершены</label>
        <label><input type="checkbox" id="o_check_docs" ${checklist.docs?'checked':''}> Документы (УПД) подготовлены</label>
      </div>
    </div>
    <div class="adm-actions">
      <button class="adm-btn adm-btn--accent" id="order-save">Сохранить</button>
    </div>
  `;
  orderModalContent.dataset.id = String(order.id || '');
  const deliveryEl = document.getElementById('o_delivery_type');
  const addrEl = document.getElementById('o_delivery_address');
  function toggleAddress(){
    if (!deliveryEl || !addrEl) return;
    const isDelivery = deliveryEl.value === 'delivery';
    addrEl.disabled = !isDelivery;
    addrEl.style.opacity = isDelivery ? '1' : '.6';
  }
  if (deliveryEl) deliveryEl.addEventListener('change', toggleAddress);
  toggleAddress();
  const shipperSameEl = document.getElementById('o_upd_shipper_same');
  const shipperFields = ['o_upd_shipper_name','o_upd_shipper_inn','o_upd_shipper_kpp','o_upd_shipper_address'];
  const consigneeSameEl = document.getElementById('o_upd_consignee_same');
  const consigneeFields = ['o_upd_consignee_name','o_upd_consignee_address'];
  const buyerNameEl = document.getElementById('o_upd_buyer_name');
  const buyerAddrEl = document.getElementById('o_upd_buyer_address');
  const buyerTypeEl = document.getElementById('o_upd_buyer_type');
  const buyerInnEl = document.getElementById('o_upd_buyer_inn');
  const buyerKppEl = document.getElementById('o_upd_buyer_kpp');
  const buyerOtherEl = document.getElementById('o_upd_buyer_other');
  async function fillShipperFromSettings(force=false){
    const data = await getSettingsCache();
    const s = data && data.seller ? data.seller : {};
    const map = {
      o_upd_shipper_name: (s.name || s.fio || '').trim(),
      o_upd_shipper_inn: (s.inn || '').trim(),
      o_upd_shipper_kpp: (s.kpp || '').trim(),
      o_upd_shipper_address: (s.address || '').trim()
    };
    shipperFields.forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      if (force || !el.value.trim()){
        if (map[id]) el.value = map[id];
      }
    });
  }
  function toggleShipper(){
    const on = shipperSameEl?.checked;
    shipperFields.forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      el.disabled = !!on;
      el.style.opacity = on ? '.6' : '1';
    });
    if (on) fillShipperFromSettings();
  }
  function toggleConsignee(){
    const on = consigneeSameEl?.checked;
    consigneeFields.forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      el.disabled = !!on;
      el.style.opacity = on ? '.6' : '1';
    });
    if (on) fillConsigneeFromBuyer();
  }
  function fillConsigneeFromBuyer(force=false){
    const name = (buyerNameEl?.value || '').trim();
    const addr = (buyerAddrEl?.value || '').trim();
    const map = { o_upd_consignee_name: name, o_upd_consignee_address: addr };
    consigneeFields.forEach(id=>{
      const el = document.getElementById(id);
      if (!el) return;
      if (force || !el.value.trim()){
        if (map[id]) el.value = map[id];
      }
    });
  }
  function toggleBuyerType(){
    const type = buyerTypeEl?.value || 'org';
    const show = (el, on)=>{ const wrap = el?.closest('.adm-field'); if (wrap) wrap.style.display = on ? '' : 'none'; };
    const disable = (el, on)=>{ if (el){ el.disabled = !!on; el.style.opacity = on ? '.6' : '1'; } };
    if (type === 'person'){
      show(buyerInnEl, false);
      show(buyerKppEl, false);
      show(buyerOtherEl, true);
      disable(buyerInnEl, true);
      disable(buyerKppEl, true);
      disable(buyerOtherEl, false);
    } else if (type === 'ip'){
      show(buyerInnEl, true);
      show(buyerKppEl, false);
      show(buyerOtherEl, false);
      disable(buyerInnEl, false);
      disable(buyerKppEl, true);
      disable(buyerOtherEl, true);
    } else {
      show(buyerInnEl, true);
      show(buyerKppEl, true);
      show(buyerOtherEl, false);
      disable(buyerInnEl, false);
      disable(buyerKppEl, false);
      disable(buyerOtherEl, true);
    }
  }
  shipperSameEl?.addEventListener('change', toggleShipper);
  consigneeSameEl?.addEventListener('change', toggleConsignee);
  buyerNameEl?.addEventListener('input', ()=>{ if (consigneeSameEl?.checked) fillConsigneeFromBuyer(true); });
  buyerAddrEl?.addEventListener('input', ()=>{ if (consigneeSameEl?.checked) fillConsigneeFromBuyer(true); });
  buyerTypeEl?.addEventListener('change', toggleBuyerType);
  toggleShipper();
  toggleConsignee();
  toggleBuyerType();

  const updCreateBtn = document.getElementById('o_upd_create');
  const updXmlBtn = document.getElementById('o_upd_xml');
  const updPrintBtn = document.getElementById('o_upd_print');
  const updStatusEl = document.getElementById('o_upd_status');

  async function refreshOrderUpd(orderId){
    const meta = await updFetchByOrder(orderId);
    if (meta && meta.id){
      orderModalContent.dataset.updId = String(meta.id);
      updXmlBtn.disabled = false;
      updPrintBtn.disabled = false;
      if (updStatusEl) updStatusEl.textContent = `УПД создан: ${meta.doc_number || meta.id}`;
    } else {
      orderModalContent.dataset.updId = '';
      updXmlBtn.disabled = true;
      updPrintBtn.disabled = true;
      if (updStatusEl) updStatusEl.textContent = 'УПД не создан';
    }
  }

  updCreateBtn?.addEventListener('click', async (e)=>{
    e.preventDefault();
    const ok = await orderModalSave(true);
    if (!ok) return;
    const doc = await updCreateForOrder(order.id);
    if (!doc) return;
    orderModalContent.dataset.updId = String(doc.id);
    updXmlBtn.disabled = false;
    updPrintBtn.disabled = false;
    if (updStatusEl) updStatusEl.textContent = `УПД создан: ${doc.doc_number || doc.id}`;
  });
  updXmlBtn?.addEventListener('click', (e)=>{
    e.preventDefault();
    const id = orderModalContent.dataset.updId;
    if (!id) return;
    window.location.href = `/api/upd/${id}/xml`;
  });
  updPrintBtn?.addEventListener('click', (e)=>{
    e.preventDefault();
    const id = orderModalContent.dataset.updId;
    if (!id) return;
    window.open(`/api/upd/${id}/print`, '_blank');
  });
  document.getElementById('o_to_production')?.addEventListener('click', async (e)=>{
    e.preventDefault();
    const ok = await orderModalSave(true);
    if (!ok) return;
    await productionCreateFromOrder(order.id);
  });
  refreshOrderUpd(order.id);

  document.getElementById('order-save')?.addEventListener('click', orderModalSave);
  orderModalBackdrop.style.display='flex';
}
async function orderModalSave(silent=false){
  const id = orderModalContent.dataset.id;
  if (!id) return false;
  const payload = {
    customer_name: (document.getElementById('o_customer_name')?.value || '').trim(),
    phone: (document.getElementById('o_phone')?.value || '').trim(),
    email: (document.getElementById('o_email')?.value || '').trim(),
    delivery_type: document.getElementById('o_delivery_type')?.value || 'pickup',
    delivery_address: (document.getElementById('o_delivery_address')?.value || '').trim(),
    payment_status: document.getElementById('o_payment_status')?.value || 'unpaid',
    payment_amount: parseFloat(document.getElementById('o_payment_amount')?.value || '0') || 0,
    payment_date: document.getElementById('o_payment_date')?.value || '',
    payment_method: document.getElementById('o_payment_method')?.value || 'bank',
    checklist_contacted: document.getElementById('o_check_contacted')?.checked ? 1 : 0,
    checklist_confirmed: document.getElementById('o_check_confirmed')?.checked ? 1 : 0,
    checklist_picked: document.getElementById('o_check_picked')?.checked ? 1 : 0,
    checklist_shipped: document.getElementById('o_check_shipped')?.checked ? 1 : 0,
    checklist_docs: document.getElementById('o_check_docs')?.checked ? 1 : 0,
    upd_buyer_type: document.getElementById('o_upd_buyer_type')?.value || 'org',
    upd_buyer_name: (document.getElementById('o_upd_buyer_name')?.value || '').trim(),
    upd_buyer_inn: (document.getElementById('o_upd_buyer_inn')?.value || '').trim(),
    upd_buyer_kpp: (document.getElementById('o_upd_buyer_kpp')?.value || '').trim(),
    upd_buyer_address: (document.getElementById('o_upd_buyer_address')?.value || '').trim(),
    upd_buyer_other: (document.getElementById('o_upd_buyer_other')?.value || '').trim(),
    upd_shipper_same: document.getElementById('o_upd_shipper_same')?.checked ? 1 : 0,
    upd_shipper_name: (document.getElementById('o_upd_shipper_name')?.value || '').trim(),
    upd_shipper_inn: (document.getElementById('o_upd_shipper_inn')?.value || '').trim(),
    upd_shipper_kpp: (document.getElementById('o_upd_shipper_kpp')?.value || '').trim(),
    upd_shipper_address: (document.getElementById('o_upd_shipper_address')?.value || '').trim(),
    upd_consignee_same: document.getElementById('o_upd_consignee_same')?.checked ? 1 : 0,
    upd_consignee_name: (document.getElementById('o_upd_consignee_name')?.value || '').trim(),
    upd_consignee_address: (document.getElementById('o_upd_consignee_address')?.value || '').trim(),
    upd_doc_date: document.getElementById('o_upd_doc_date')?.value || '',
    upd_vat_rate: document.getElementById('o_upd_vat_rate')?.value || 'без НДС',
    upd_vat_included: document.getElementById('o_upd_vat_included')?.checked ? 1 : 0,
    upd_signer1_fio: (document.getElementById('o_upd_signer1_fio')?.value || '').trim(),
    upd_signer1_pos: (document.getElementById('o_upd_signer1_pos')?.value || '').trim(),
    upd_signer1_type: document.getElementById('o_upd_signer1_type')?.value || '1',
    upd_signer1_authority: document.getElementById('o_upd_signer1_authority')?.value || '1',
    upd_signer1_date: document.getElementById('o_upd_signer1_date')?.value || '',
    upd_signer2_fio: (document.getElementById('o_upd_signer2_fio')?.value || '').trim(),
    upd_signer2_pos: (document.getElementById('o_upd_signer2_pos')?.value || '').trim(),
    upd_signer2_type: document.getElementById('o_upd_signer2_type')?.value || '1',
    upd_signer2_authority: document.getElementById('o_upd_signer2_authority')?.value || '1',
    upd_signer2_date: document.getElementById('o_upd_signer2_date')?.value || ''
  };
  // sanitize buyer fields by type
  if (payload.upd_buyer_type === 'person'){
    payload.upd_buyer_inn = '';
    payload.upd_buyer_kpp = '';
  } else if (payload.upd_buyer_type === 'ip'){
    payload.upd_buyer_kpp = '';
    payload.upd_buyer_other = '';
  } else {
    payload.upd_buyer_other = '';
  }
  try{
    const res = await api('/api/orders/'+id, { method:'PATCH', body: JSON.stringify(payload) });
    if (!res.ok) throw new Error(await res.text());
    const idx = ordersCache.findIndex(x=>String(x.id)===String(id));
    if (idx > -1) Object.assign(ordersCache[idx], payload);
    if (document.getElementById('o_upd_xml')){
      const meta = await updFetchByOrder(id);
      const updXmlBtn = document.getElementById('o_upd_xml');
      const updPrintBtn = document.getElementById('o_upd_print');
      const updStatusEl = document.getElementById('o_upd_status');
      if (meta && meta.id){
        orderModalContent.dataset.updId = String(meta.id);
        if (updXmlBtn) updXmlBtn.disabled = false;
        if (updPrintBtn) updPrintBtn.disabled = false;
        if (updStatusEl) updStatusEl.textContent = `УПД создан: ${meta.doc_number || meta.id}`;
      } else {
        orderModalContent.dataset.updId = '';
        if (updXmlBtn) updXmlBtn.disabled = true;
        if (updPrintBtn) updPrintBtn.disabled = true;
        if (updStatusEl) updStatusEl.textContent = 'УПД не создан';
      }
    }
    return true;
  }catch(err){
    console.error(err);
    if (!silent) alert('Не удалось сохранить заказ');
    return false;
  }
}
function closeOrderModal(){ orderModalBackdrop.style.display='none'; orderModalContent.innerHTML=''; }
orderModalClose.addEventListener('click', closeOrderModal);
orderModalBackdrop.addEventListener('click', e=>{ if(e.target===orderModalBackdrop) closeOrderModal() });

// Гидратация полного заказа перед открытием модалки
async function openOrderById(id){
  let ord = ordersCache.find(x=>String(x.id)===String(id));
  try{
    const res = await api('/api/orders/'+id);
    if(res.ok){
      const full = await res.json();
      if(ord){ Object.assign(ord, full); }
      else { ord = full; ordersCache.push(full); }
      if(ord.status === 'Отменен'){
        const reason = (ord.cancel_reason||'') || extractCancelReasonFromNote(ord.note||'');
        setLocalCancel(String(id), reason, ord.note||'');
      }
    }
  }catch(e){}
  if(ord) openOrderModal(ord);
}


/* ===== ТОВАРЫ (списки + открытие модалки редактирования) ===== */
let productsCache = [];

async function loadProductsShortInto(tableId, paneId){
  const tbody = document.querySelector('#'+tableId+' tbody');
  const pane = document.getElementById(paneId);
  if(!tbody || !pane) return;
  const cols = document.querySelector('#'+tableId+' colgroup').children.length;
  tbody.innerHTML = skeletonRows(cols, 10);
  await withOverlay(pane, async ()=>{
    if(!productsCache.length){
      const res = await api('/api/products');
      productsCache = res.ok ? await res.json() : [];
    }
    tbody.innerHTML = '';
    productsCache.forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML =
        '<td class="cell-ellipsis">'+(p.id||'')+'</td>'+
        '<td class="cell-ellipsis">'+(p.name||'')+'</td>'+
        '<td class="cell-ellipsis">'+(p.price||0)+'</td>'+
        '<td class="cell-ellipsis">'+(p.stock_qty ?? 0)+'</td>'+
        '<td class="cell-ellipsis">'+(p.lead_time_days ?? '')+'</td>';
      tr.addEventListener('click', ()=> openEditById(p.id));
      tbody.appendChild(tr);
    });
  });
}

async function openEditById(id){
  if(!id) return;
  if(!productsCache.length){
    const r = await api('/api/products');
    productsCache = r.ok ? await r.json() : [];
  }
  let p = productsCache.find(x => String(x.id) === String(id));
  if(!p){
    try{ const r = await api('/api/products/'+id); if(r.ok) p = await r.json(); }catch(_){}
  }
  if(window.__openEditProduct) window.__openEditProduct(p || {id});
}
/* ===== /ТОВАРЫ ===== */

/* === helper: load items for orders when /api/orders returns trimmed objects === */
const __itemsCache = new Map();
async function ensureItems(orders){
  if(!Array.isArray(orders) || !orders.length) return;
  const need = orders.filter(o => !Array.isArray(o.items) || o.items.length === 0);
  if(!need.length) return;
  await Promise.all(need.map(async o => {
    const key = String(o.id);
    if(__itemsCache.has(key)){ o.items = __itemsCache.get(key); return; }
    try{
      const r = await api('/api/orders/' + key);
      if(r.ok){
        const full = await r.json();
        const items = Array.isArray(full.items) ? full.items : [];
        __itemsCache.set(key, items);
        o.items = items;
      }
    }catch(_){ /* тихо */ }
  }));
}

/* ===== ДДС ===== */
const ddsTypeLabels = { income: 'Приход', expense: 'Расход' };
const ddsStatusLabels = { active: 'Активна', void: 'Аннулирована' };
const ddsPaymentLabels = { cash: 'Наличные', card: 'Карта', transfer: 'Перевод', bank: 'Безнал' };
const ddsFallback = {
  income: ['Продажа','Доп. услуги','Прочее'],
  expense: ['Закупка','Доставка','Аренда','Зарплата','Реклама','Налоги','Хозяйственные','Прочее']
};
const ddsState = { categories: { income: [], expense: [] } };
const ddsLast = { left: null, right: null };
const ddsComments = new Map();

function ddsToNum(v){
  if (v == null) return 0;
  const s = String(v).replace(/\s+/g,'').replace(',', '.');
  const n = Number(s);
  return Number.isFinite(n) ? n : 0;
}

function ddsMergeCats(list, fallback){
  const set = new Set((list || []).map(x => x.name));
  const out = (list || []).slice();
  (fallback || []).forEach(name => { if (!set.has(name)) out.push({ name }); });
  return out;
}

async function ddsLoadCategories(type){
  if (!type) return;
  if (ddsState.categories[type] && ddsState.categories[type].length) return;
  try{
    const res = await api('/api/cashflow/categories?type=' + encodeURIComponent(type));
    if (res.ok){
      const list = await res.json();
      ddsState.categories[type] = ddsMergeCats(list, ddsFallback[type]);
      return;
    }
  }catch(_){}
  ddsState.categories[type] = ddsMergeCats([], ddsFallback[type]);
}

async function ddsFillCategorySelect(selectEl, type, keepValue){
  if (!selectEl) return;
  if (type) {
    await ddsLoadCategories(type);
  } else {
    await ddsLoadCategories('income');
    await ddsLoadCategories('expense');
  }
  const list = type
    ? (ddsState.categories[type] || [])
    : [...(ddsState.categories.income||[]), ...(ddsState.categories.expense||[])];
  selectEl.innerHTML = '<option value="">Категория: все</option>' +
    list.map(c => `<option value="${c.name}">${c.name}</option>`).join('');
  if (keepValue) selectEl.value = keepValue;
}

function ddsBuildQuery(params){
  const q = Object.entries(params).filter(([,v])=>v).map(([k,v])=>`${encodeURIComponent(k)}=${encodeURIComponent(v)}`).join('&');
  return q ? ('?' + q) : '';
}

async function loadDds(side){
  const pane = document.getElementById(`dds-pane-${side}`);
  const tbody = document.querySelector(`#dds-${side}-table tbody`);
  const kpi = document.getElementById(`dds-kpi-${side}`);
  if (!pane || !tbody || !kpi) return;

  const from = document.getElementById(`dds-from-${side}`)?.value || '';
  const to = document.getElementById(`dds-to-${side}`)?.value || '';
  const type = document.getElementById(`dds-type-${side}`)?.value || '';
  const status = document.getElementById(`dds-status-${side}`)?.value || '';
  const payment = document.getElementById(`dds-payment-${side}`)?.value || '';
  const categoryEl = document.getElementById(`dds-category-${side}`);
  const category = categoryEl?.value || '';

  await ddsFillCategorySelect(categoryEl, type || '', category);

  const cols = document.querySelector(`#dds-${side}-table colgroup`).children.length;
  tbody.innerHTML = skeletonRows(cols, 6);

  await withOverlay(pane, async ()=>{
    const res = await api('/api/cashflow' + ddsBuildQuery({ from, to, type, status, payment, category }));
    const list = res.ok ? await res.json() : [];
    ddsLast[side] = list;

    const income = list.filter(x=>x.status !== 'void' && x.type === 'income').reduce((s,x)=>s+ddsToNum(x.amount),0);
    const expense = list.filter(x=>x.status !== 'void' && x.type === 'expense').reduce((s,x)=>s+ddsToNum(x.amount),0);
    const net = income - expense;

    kpi.innerHTML = `
      <div class="dds-kpi-grid">
        <div class="stat-card"><div class="stat-title">Приход</div><div class="stat-value">${income.toLocaleString('ru-RU',{minimumFractionDigits:2, maximumFractionDigits:2})} ₽</div></div>
        <div class="stat-card"><div class="stat-title">Расход</div><div class="stat-value">${expense.toLocaleString('ru-RU',{minimumFractionDigits:2, maximumFractionDigits:2})} ₽</div></div>
        <div class="stat-card"><div class="stat-title">Чистый поток</div><div class="stat-value">${net.toLocaleString('ru-RU',{minimumFractionDigits:2, maximumFractionDigits:2})} ₽</div></div>
      </div>`;
    kpi.classList && kpi.classList.remove('muted');

    tbody.innerHTML = '';
    list.forEach(row=>{
      const tr = document.createElement('tr');
      if (row.status === 'void') tr.classList.add('dds-void');
      const orderTxt = row.order_id ? ('#' + row.order_id) : '—';
      const commentTxt = row.comment ? String(row.comment) : '';
      const hasComment = commentTxt.trim() !== '';
      if (row.id != null) ddsComments.set(String(row.id), commentTxt);
      tr.innerHTML =
        `<td class="cell-ellipsis">${row.date || '—'}</td>` +
        `<td class="cell-ellipsis">${ddsTypeLabels[row.type] || row.type}</td>` +
        `<td class="cell-ellipsis">${ddsToNum(row.amount).toLocaleString('ru-RU',{minimumFractionDigits:2, maximumFractionDigits:2})}</td>` +
        `<td class="cell-ellipsis">${row.category || '—'}</td>` +
        `<td class="cell-ellipsis">${ddsPaymentLabels[row.payment_method] || row.payment_method}</td>` +
        `<td class="cell-ellipsis">${ddsStatusLabels[row.status] || row.status}</td>` +
        `<td class="cell-ellipsis">${orderTxt}</td>` +
        `<td class="actions"><div class="btns">` +
          `<button class="ghost dds-comment" data-id="${row.id}" ${hasComment ? '' : 'disabled'}>Комментарий</button>` +
          (row.status === 'void'
            ? `<button class="ghost dds-restore" data-id="${row.id}">Вернуть</button>`
            : `<button class="ghost dds-void" data-id="${row.id}">Аннулировать</button>`) +
          `<button class="danger dds-delete" data-id="${row.id}">Удалить</button>` +
        `</div></td>`;
      tbody.appendChild(tr);
    });
    if (!list.length){
      tbody.innerHTML = `<tr><td colspan="8"><span class="muted">Проводок нет</span></td></tr>`;
    }
  });
}

function ddsIsOpen(side){
  const el = document.getElementById(`dds-${side}`);
  return el && el.style.display !== 'none';
}

function ddsRefreshOpen(){
  if (ddsIsOpen('left')) loadDds('left');
  if (ddsIsOpen('right')) loadDds('right');
}

function ddsModalOpen(side){
  const back = document.getElementById('dds-modal-backdrop');
  if (!back) return;
  const typeSel = document.getElementById('dds_type');
  const dateInput = document.getElementById('dds_date');
  const amountInput = document.getElementById('dds_amount');
  const commentInput = document.getElementById('dds_comment');
  const paymentSel = document.getElementById('dds_payment');

  const defaultType = document.getElementById(`dds-type-${side}`)?.value || 'income';
  typeSel.value = defaultType || 'income';
  dateInput.value = new Date().toISOString().slice(0,10);
  amountInput.value = '';
  commentInput.value = '';
  paymentSel.value = 'bank';
  ddsFillCategorySelect(document.getElementById('dds_category'), typeSel.value).then(()=>{
    const catSel = document.getElementById('dds_category');
    if (catSel) catSel.value = '';
  });
  back.style.display = 'flex';
}

function ddsModalClose(){
  const back = document.getElementById('dds-modal-backdrop');
  if (back) back.style.display = 'none';
}

function ddsCommentOpen(id){
  const back = document.getElementById('dds-comment-backdrop');
  const body = document.getElementById('dds-comment-body');
  if (!back || !body) return;
  const txt = ddsComments.get(String(id)) || '';
  body.textContent = txt ? txt : '—';
  back.style.display = 'flex';
}
function ddsCommentClose(){
  const back = document.getElementById('dds-comment-backdrop');
  if (back) back.style.display = 'none';
}

document.addEventListener('change', (e)=>{
  const t = e.target.closest('#dds_type');
  if (t){
    ddsFillCategorySelect(document.getElementById('dds_category'), t.value);
  }
  const typeLeft = e.target.closest('#dds-type-left');
  if (typeLeft) ddsFillCategorySelect(document.getElementById('dds-category-left'), typeLeft.value, document.getElementById('dds-category-left')?.value || '');
  const typeRight = e.target.closest('#dds-type-right');
  if (typeRight) ddsFillCategorySelect(document.getElementById('dds-category-right'), typeRight.value, document.getElementById('dds-category-right')?.value || '');
});

document.addEventListener('click', async (e)=>{
  const c = e.target.closest('.dds-comment');
  const v = e.target.closest('.dds-void');
  const r = e.target.closest('.dds-restore');
  const d = e.target.closest('.dds-delete');
  if (c){
    const id = c.dataset.id;
    if (!c.disabled) ddsCommentOpen(id);
  }
  if (v){
    const id = v.dataset.id;
    await withOverlay(v, async ()=>{
      await api('/api/cashflow/' + id, { method:'PATCH', body: JSON.stringify({ status: 'void' }) });
      ddsRefreshOpen();
    });
  }
  if (r){
    const id = r.dataset.id;
    await withOverlay(r, async ()=>{
      await api('/api/cashflow/' + id, { method:'PATCH', body: JSON.stringify({ status: 'active' }) });
      ddsRefreshOpen();
    });
  }
  if (d){
    const id = d.dataset.id;
    if (!confirm('Удалить проводку #' + id + '?')) return;
    await withOverlay(d, async ()=>{
      await api('/api/cashflow/' + id, { method:'DELETE' });
      ddsRefreshOpen();
    });
  }
});

document.addEventListener('click', (e)=>{
  const openLeft = e.target.closest('#dds-add-left');
  const openRight = e.target.closest('#dds-add-right');
  if (openLeft){ e.preventDefault(); ddsModalOpen('left'); }
  if (openRight){ e.preventDefault(); ddsModalOpen('right'); }
  const close = e.target.closest('#dds-modal-close, #dds-modal-cancel');
  if (close){ e.preventDefault(); ddsModalClose(); }
  const closeComment = e.target.closest('#dds-comment-close');
  if (closeComment){ e.preventDefault(); ddsCommentClose(); }
});

document.getElementById('dds-modal-save')?.addEventListener('click', async ()=>{
  const date = document.getElementById('dds_date').value || new Date().toISOString().slice(0,10);
  const typeRaw = document.getElementById('dds_type').value || 'income';
  const type = (typeRaw === 'expense' || typeRaw === 'income') ? typeRaw : 'income';
  const amount = ddsToNum(document.getElementById('dds_amount').value);
  const categoryRaw = document.getElementById('dds_category').value || '';
  const category = categoryRaw.trim() || 'Прочее';
  const paymentRaw = document.getElementById('dds_payment').value || 'bank';
  const payment = ['cash','card','transfer','bank'].includes(paymentRaw) ? paymentRaw : 'bank';
  const comment = document.getElementById('dds_comment').value || '';

  try{
    const res = await api('/api/cashflow', {
      method:'POST',
      body: JSON.stringify({
        date,
        type,
        amount,
        category,
        payment_method: payment,
        comment
      })
    });
    if (!res.ok) throw new Error(await res.text());
    ddsModalClose();
    ddsRefreshOpen();
  }catch(err){
    console.error(err);
    alert('Не удалось сохранить проводку');
  }
});

document.getElementById('dds-modal-backdrop')?.addEventListener('click', (e)=>{
  if (e.target && e.target.id === 'dds-modal-backdrop') ddsModalClose();
});
document.getElementById('dds-comment-backdrop')?.addEventListener('click', (e)=>{
  if (e.target && e.target.id === 'dds-comment-backdrop') ddsCommentClose();
});

/* ===== DDS export ===== */
function ddsEscapeCell(v){
  const s = String(v ?? '').replace(/\r?\n|\r/g, ' ').replace(/"/g, '""').trim();
  return '"' + s + '"';
}
function ddsLinesToCSV(lines){
  return lines.map(row => row.map(ddsEscapeCell).join('\t')).join('\r\n');
}
function ddsToXLSBlob(csv){
  const buf = new Uint16Array(csv.length + 1);
  buf[0] = 0xFEFF;
  for (let i=0;i<csv.length;i++) buf[i+1]=csv.charCodeAt(i);
  return new Blob([buf], { type: 'application/vnd.ms-excel;charset=utf-16le' });
}
function ddsDownload(blob, prefix){
  const a = document.createElement('a');
  a.href = URL.createObjectURL(blob);
  const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
  a.download = `${prefix}_${stamp}.xls`;
  document.body.appendChild(a); a.click();
  setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
}
function ddsBuildExportLines(list){
  const lines = [];
  lines.push(['Дата','Тип','Сумма','Категория','Оплата','Статус','Комментарий','Заказ']);
  (list || []).forEach(row=>{
    lines.push([
      row.date || '',
      ddsTypeLabels[row.type] || row.type || '',
      ddsToNum(row.amount || 0),
      row.category || '',
      ddsPaymentLabels[row.payment_method] || row.payment_method || '',
      ddsStatusLabels[row.status] || row.status || '',
      row.comment ? String(row.comment) : '',
      row.order_id ? ('#'+row.order_id) : ''
    ]);
  });
  return lines;
}
async function exportDds(side){
  if (!ddsLast[side]) await loadDds(side);
  const list = ddsLast[side] || [];
  const csv = ddsLinesToCSV(ddsBuildExportLines(list));
  ddsDownload(ddsToXLSBlob(csv), `dds_${side}`);
}

/* ===== СКЛАД ===== */
const stockTypeLabels = { in:'Приход', out:'Списание', reserve:'Резерв', release:'Снятие резерва', adjust:'Корректировка' };
const stockReasonLabels = { purchase:'Закупка', order:'Заказ', writeoff:'Списание', manual:'Вручную', production:'Производство' };
const stockState = { list: [] };
const stockMovementsState = { list: [], productId: 0 };
let stockIncomingSaving = false;

function stockNum(v){ const n = Number(v); return Number.isFinite(n) ? n : 0; }
function stockFmt(v){ return stockNum(v).toLocaleString('ru-RU'); }

async function stockFetchList(force=false){
  if (!force && stockState.list.length) return stockState.list;
  try{
    const res = await api('/api/stock');
    stockState.list = res.ok ? await res.json() : [];
  }catch(_){ stockState.list = []; }
  return stockState.list;
}

function stockFilterList(list, q){
  if (!q) return list;
  const s = q.toLowerCase();
  return (list || []).filter(p=>{
    const name = (p.name || '').toLowerCase();
    const id = String(p.id || '');
    return name.includes(s) || id.includes(s);
  });
}

function stockRenderKpi(kpiEl, list){
  if (!kpiEl) return;
  const totalStock = list.reduce((s,p)=> s + stockNum(p.stock_qty), 0);
  const totalReserved = list.reduce((s,p)=> s + stockNum(p.reserved_qty), 0);
  const totalAvailable = list.reduce((s,p)=> s + stockNum(p.available_qty), 0);
  const totalOnOrder = list.reduce((s,p)=> s + stockNum(p.on_order_qty), 0);
  kpiEl.innerHTML = `
    <div class="stock-kpi-grid">
      <div class="stat-card"><div class="stat-title">Склад</div><div class="stat-value">${stockFmt(totalStock)} шт.</div></div>
      <div class="stat-card"><div class="stat-title">Резерв</div><div class="stat-value">${stockFmt(totalReserved)} шт.</div></div>
      <div class="stat-card"><div class="stat-title">Доступно</div><div class="stat-value">${stockFmt(totalAvailable)} шт.</div></div>
      <div class="stat-card"><div class="stat-title">Под заказ</div><div class="stat-value">${stockFmt(totalOnOrder)} шт.</div></div>
      <div class="stat-card"><div class="stat-title">Позиций</div><div class="stat-value">${(list || []).length}</div></div>
    </div>
  `;
  kpiEl.classList && kpiEl.classList.remove('muted');
}

async function loadStock(side, force=false){
  const pane = document.getElementById(`stock-pane-${side}`);
  const tbody = document.querySelector(`#stock-${side}-table tbody`);
  const kpi = document.getElementById(`stock-kpi-${side}`);
  if (!pane || !tbody || !kpi) return;
  const cols = document.querySelector(`#stock-${side}-table colgroup`).children.length;
  tbody.innerHTML = skeletonRows(cols, 8);
  await withOverlay(pane, async ()=>{
    const list = await stockFetchList(force);
    const q = (document.getElementById(`stock-search-${side}`)?.value || '').trim();
    const filtered = stockFilterList(list, q);
    stockRenderKpi(kpi, filtered);
    tbody.innerHTML = '';
    filtered.forEach(p=>{
      const tr = document.createElement('tr');
      tr.innerHTML =
        `<td class="cell-ellipsis">${p.id || ''}</td>` +
        `<td class="cell-ellipsis">${p.name || ''}</td>` +
        `<td class="cell-ellipsis">${stockFmt(p.stock_qty)}</td>` +
        `<td class="cell-ellipsis">${stockFmt(p.reserved_qty)}</td>` +
        `<td class="cell-ellipsis">${stockFmt(p.available_qty)}</td>` +
        `<td class="cell-ellipsis">${stockFmt(p.on_order_qty)}</td>` +
        `<td class="actions"><div class="btns">` +
          `<button class="ghost stock-move" data-id="${p.id}">Движения</button>` +
        `</div></td>`;
      tbody.appendChild(tr);
    });
    if (!filtered.length){
      tbody.innerHTML = `<tr><td colspan="7"><span class="muted">Товаров нет</span></td></tr>`;
    }
  });
}

function stockIsOpen(side){
  const el = document.getElementById(`stock-${side}`);
  return el && el.style.display !== 'none';
}
function stockRefreshOpen(){
  if (stockIsOpen('left')) loadStock('left', true);
  if (stockIsOpen('right')) loadStock('right', true);
}

function stockBuildOptions(selectedId){
  const list = stockState.list || [];
  if (!list.length) return '<option value=\"\">Нет товаров</option>';
  return list.map(p=>{
    const id = String(p.id || '');
    const sel = selectedId && String(selectedId) === id ? 'selected' : '';
    return `<option value=\"${id}\" ${sel}>${(p.name || ('Товар #' + id))}</option>`;
  }).join('');
}

function stockResetIncomingRows(){
  const wrap = document.getElementById('stock-in-items');
  if (!wrap) return;
  wrap.innerHTML = '';
  stockAddIncomingRow();
}

function stockAddIncomingRow(prefill = {}){
  const wrap = document.getElementById('stock-in-items');
  if (!wrap) return;
  const row = document.createElement('div');
  row.className = 'stock-row';
  row.innerHTML = `
    <select class="stock-in-product">${stockBuildOptions(prefill.product_id)}</select>
    <input type="number" class="stock-in-qty" min="1" step="1" value="${prefill.qty ?? 1}">
    <input type="number" class="stock-in-price" min="0" step="0.01" placeholder="—" value="${prefill.price ?? ''}">
    <button class="ghost stock-row-remove" title="Удалить">✕</button>
  `;
  row.querySelector('.stock-row-remove')?.addEventListener('click', ()=> row.remove());
  wrap.appendChild(row);
}

async function stockIncomingOpen(){
  await stockFetchList();
  const back = document.getElementById('stock-in-backdrop');
  if (!back) return;
  document.getElementById('stock-doc-type').value = 'invoice';
  document.getElementById('stock-doc-number').value = '';
  document.getElementById('stock-doc-date').value = '';
  document.getElementById('stock-doc-supplier').value = '';
  document.getElementById('stock-doc-comment').value = '';
  const fileInput = document.getElementById('stock-doc-file');
  if (fileInput) fileInput.value = '';
  const label = document.getElementById('stock-doc-file-label');
  if (label) label.textContent = 'Файл не выбран';
  stockResetIncomingRows();
  back.style.display = 'flex';
}

function stockIncomingClose(){
  const back = document.getElementById('stock-in-backdrop');
  if (back) back.style.display = 'none';
}

async function stockUploadFile(file){
  const fd = new FormData();
  fd.append('file', file);
  const res = await fetch('/api/stock/upload', {
    method: 'POST',
    credentials: 'include',
    headers: { 'x-dev-auth': '1' },
    body: fd
  });
  if (!res.ok) return null;
  const data = await res.json();
  return data && data.url ? data.url : null;
}

async function stockIncomingSave(){
  if (stockIncomingSaving) return;
  stockIncomingSaving = true;
  const items = [];
  document.querySelectorAll('#stock-in-items .stock-row').forEach(row=>{
    const pid = parseInt(row.querySelector('.stock-in-product')?.value || '0', 10) || 0;
    const qty = parseInt(row.querySelector('.stock-in-qty')?.value || '0', 10) || 0;
    const priceRaw = row.querySelector('.stock-in-price')?.value || '';
    const price = priceRaw === '' ? null : parseFloat(priceRaw);
    if (pid > 0 && qty > 0) items.push({ product_id: pid, qty, price });
  });
  if (!items.length){ alert('Добавьте хотя бы одну позицию'); stockIncomingSaving = false; return; }

  const doc = {
    doc_type: document.getElementById('stock-doc-type')?.value || 'other',
    doc_number: (document.getElementById('stock-doc-number')?.value || '').trim(),
    doc_date: (document.getElementById('stock-doc-date')?.value || '').trim(),
    supplier: (document.getElementById('stock-doc-supplier')?.value || '').trim(),
    comment: (document.getElementById('stock-doc-comment')?.value || '').trim(),
    file_url: ''
  };

  const fileInput = document.getElementById('stock-doc-file');
  if (fileInput && fileInput.files && fileInput.files[0]){
    const url = await stockUploadFile(fileInput.files[0]);
    if (!url){ alert('Не удалось загрузить файл'); stockIncomingSaving = false; return; }
    doc.file_url = url;
  }

  const alreadyIn = await stockConfirmOpen({
    title: 'ДДС',
    text: 'Учтен ли данный приход в ДДС?',
    primary: 'Да, учтен',
    secondary: 'Нет, не учтен'
  });
  let ddsData = null;
  if (alreadyIn === false){
    const addToDds = await stockConfirmOpen({
      title: 'ДДС',
      text: 'Внести приход в ДДС как расход (категория \"Закупка\")?',
      primary: 'Да, внести',
      secondary: 'Не нужно'
    });
    if (addToDds === true){
      const sum = items.reduce((s,it)=> s + (Number(it.qty)||0) * (Number(it.price)||0), 0);
      const defDate = doc.doc_date || new Date().toISOString().slice(0,10);
      const defComment = ['Приход товара', doc.doc_number ? ('док. '+doc.doc_number) : '', doc.supplier || '']
        .filter(Boolean).join(' / ');
      ddsData = await stockDdsModalOpen({ amount: sum, date: defDate, payment_method: 'bank', comment: defComment });
    }
  }

  try{
    const res = await api('/api/stock/incoming', {
      method:'POST',
      body: JSON.stringify({ doc, items })
    });
    if (!res.ok) throw new Error(await res.text());
    if (ddsData){
      const ddsRes = await api('/api/cashflow', {
        method:'POST',
        body: JSON.stringify({
          date: ddsData.date,
          type: 'expense',
          amount: ddsData.amount,
          category: 'Закупка',
          payment_method: ddsData.payment_method,
          comment: ddsData.comment || ''
        })
      });
      if (!ddsRes.ok){
        console.error(await ddsRes.text());
        alert('Приход сохранен, но в ДДС не записано');
      }
    }
    stockIncomingClose();
    stockRefreshOpen();
    ddsRefreshOpen();
  }catch(err){
    console.error(err);
    alert('Не удалось сохранить приход');
  } finally {
    stockIncomingSaving = false;
  }
}

async function stockAdjustOpen(){
  await stockFetchList();
  const back = document.getElementById('stock-adjust-backdrop');
  const sel = document.getElementById('stock-adjust-product');
  if (sel) sel.innerHTML = stockBuildOptions();
  document.getElementById('stock-adjust-qty').value = '';
  document.getElementById('stock-adjust-comment').value = '';
  if (back) back.style.display = 'flex';
}

function stockAdjustClose(){
  const back = document.getElementById('stock-adjust-backdrop');
  if (back) back.style.display = 'none';
}

async function stockAdjustSave(){
  const pid = parseInt(document.getElementById('stock-adjust-product')?.value || '0', 10) || 0;
  const delta = parseInt(document.getElementById('stock-adjust-qty')?.value || '0', 10) || 0;
  const comment = (document.getElementById('stock-adjust-comment')?.value || '').trim();
  if (pid <= 0 || delta === 0){ alert('Укажите товар и изменение'); return; }
  try{
    const res = await api('/api/stock/adjust', {
      method:'POST',
      body: JSON.stringify({ product_id: pid, qty: delta, comment })
    });
    if (!res.ok) throw new Error(await res.text());
    stockAdjustClose();
    stockRefreshOpen();
  }catch(err){
    console.error(err);
    alert('Не удалось сохранить корректировку');
  }
}

function stockMovementsSignedQty(row){
  let qtyVal = stockNum(row.qty);
  if (row.type === 'out' || row.type === 'release') qtyVal = -Math.abs(qtyVal);
  return qtyVal;
}

function stockMovementsGetFiltered(){
  const q = (document.getElementById('stock-movements-search')?.value || '').trim().toLowerCase();
  const type = document.getElementById('stock-movements-type')?.value || '';
  const reason = document.getElementById('stock-movements-reason')?.value || '';
  return (stockMovementsState.list || []).filter(row=>{
    if (type && row.type !== type) return false;
    if (reason && row.reason !== reason) return false;
    if (!q) return true;
    const order = row.order_id ? ('#' + row.order_id) : '';
    const doc = row.doc_id ? ('#' + row.doc_id) : '';
    const dt = row.created_at ? new Date(row.created_at).toLocaleString('ru-RU') : '';
    const hay = [
      row.product_name || '',
      stockTypeLabels[row.type] || row.type || '',
      stockReasonLabels[row.reason] || row.reason || '',
      row.comment || '',
      order,
      doc,
      dt
    ].join(' ').toLowerCase();
    return hay.includes(q);
  });
}

function stockMovementsRenderTable(){
  const tbody = document.querySelector('#stock-movements-table tbody');
  if (!tbody) return;
  const rows = stockMovementsGetFiltered();
  tbody.innerHTML = '';
  rows.forEach(row=>{
    const tr = document.createElement('tr');
    const dt = row.created_at ? new Date(row.created_at).toLocaleString('ru-RU') : '—';
    const product = row.product_name || (row.product_id ? ('#' + row.product_id) : '—');
    const type = stockTypeLabels[row.type] || row.type || '—';
    const qtyVal = stockMovementsSignedQty(row);
    const qtyClass = qtyVal > 0 ? 'pos' : (qtyVal < 0 ? 'neg' : 'zero');
    const qtyLabel = qtyVal > 0 ? ('+' + qtyVal) : String(qtyVal);
    const reason = stockReasonLabels[row.reason] || row.reason || '—';
    const order = row.order_id ? ('#' + row.order_id) : '—';
    const doc = row.doc_id ? ('#' + row.doc_id) : '—';
    const comment = row.comment ? String(row.comment) : '';
    tr.innerHTML =
      `<td class="cell-ellipsis">${dt}</td>` +
      `<td class="cell-wrap">${product}</td>` +
      `<td class="cell-ellipsis">${type}</td>` +
      `<td class="cell-ellipsis"><span class="stock-movements-qty ${qtyClass}">${qtyLabel}</span></td>` +
      `<td class="cell-ellipsis">${reason}</td>` +
      `<td class="cell-ellipsis">${order}</td>` +
      `<td class="cell-ellipsis">${doc}</td>` +
      `<td class="cell-wrap">${comment || '—'}</td>`;
    tbody.appendChild(tr);
  });
  if (!rows.length){
    tbody.innerHTML = `<tr><td colspan="8"><span class="muted">Движений нет</span></td></tr>`;
  }
}

async function stockMovementsOpen(pid){
  const productId = parseInt(String(pid || '0'), 10) || 0;
  const back = document.getElementById('stock-movements-backdrop');
  const pane = document.getElementById('stock-movements-pane');
  const title = document.getElementById('stock-movements-title');
  const search = document.getElementById('stock-movements-search');
  const typeSel = document.getElementById('stock-movements-type');
  const reasonSel = document.getElementById('stock-movements-reason');
  const tbody = document.querySelector('#stock-movements-table tbody');
  if (!back || !pane || !title || !tbody) return;
  const p = (stockState.list || []).find(x => String(x.id) === String(productId));
  const isAll = productId <= 0;
  title.textContent = isAll ? 'Общая история движений товара' : ('Движения товара — ' + (p?.name || ('#' + productId)));
  if (search) search.value = '';
  if (typeSel) typeSel.value = '';
  if (reasonSel) reasonSel.value = '';
  stockMovementsState.productId = productId;
  back.style.display = 'flex';
  const cols = document.querySelector('#stock-movements-table colgroup').children.length;
  tbody.innerHTML = skeletonRows(cols, 6);
  await withOverlay(pane, async ()=>{
    const qs = new URLSearchParams({ limit: '1000' });
    if (!isAll) qs.set('product_id', String(productId));
    const res = await api('/api/stock/movements?' + qs.toString());
    stockMovementsState.list = res.ok ? await res.json() : [];
    stockMovementsRenderTable();
  });
}

function stockMovementsClose(){
  const back = document.getElementById('stock-movements-backdrop');
  if (back) back.style.display = 'none';
}

let stockDdsResolver = null;
function stockDdsModalOpen(defaults){
  const back = document.getElementById('stock-dds-backdrop');
  if (!back) return Promise.resolve(null);
  const dateEl = document.getElementById('stock-dds-date');
  const amountEl = document.getElementById('stock-dds-amount');
  const payEl = document.getElementById('stock-dds-payment');
  const commentEl = document.getElementById('stock-dds-comment');

  if (dateEl) dateEl.value = defaults?.date || new Date().toISOString().slice(0,10);
  if (amountEl) amountEl.value = Number(defaults?.amount || 0) ? Number(defaults.amount).toFixed(2) : '';
  if (payEl) payEl.value = defaults?.payment_method || 'bank';
  if (commentEl) commentEl.value = defaults?.comment || '';

  back.style.display = 'flex';
  return new Promise(resolve => { stockDdsResolver = resolve; });
}
function stockDdsModalClose(result){
  const back = document.getElementById('stock-dds-backdrop');
  if (back) back.style.display = 'none';
  if (stockDdsResolver){ stockDdsResolver(result || null); stockDdsResolver = null; }
}

let stockConfirmResolver = null;
function stockConfirmOpen(cfg){
  const back = document.getElementById('stock-dds-confirm-backdrop');
  if (!back) return Promise.resolve(null);
  const title = document.getElementById('stock-dds-confirm-title');
  const text = document.getElementById('stock-dds-confirm-text');
  const primary = document.getElementById('stock-dds-confirm-primary');
  const secondary = document.getElementById('stock-dds-confirm-secondary');
  if (title) title.textContent = cfg?.title || 'ДДС';
  if (text) text.textContent = cfg?.text || '';
  if (primary) primary.textContent = cfg?.primary || 'Да';
  if (secondary) secondary.textContent = cfg?.secondary || 'Нет';
  back.style.display = 'flex';
  return new Promise(resolve => { stockConfirmResolver = resolve; });
}
function stockConfirmClose(result){
  const back = document.getElementById('stock-dds-confirm-backdrop');
  if (back) back.style.display = 'none';
  if (stockConfirmResolver){ stockConfirmResolver(result); stockConfirmResolver = null; }
}

/* ===== ПРОИЗВОДСТВО ===== */
const productionStateLabels = {
  draft:'Черновик',
  confirmed:'Подтвержден',
  in_work:'В работе',
  ready:'Готов',
  closed:'Закрыт',
  cancelled:'Отменен'
};
const productionStageLabels = {
  stage_cut:'Резка',
  stage_bend:'Гибка',
  stage_fitting:'Слесарные',
  stage_assembly:'Сборка',
  stage_qc:'ОТК',
  stage_stock:'Склад'
};
const productionStageStateLabels = { todo:'Не начато', progress:'В работе', done:'Завершено' };
const productionStageKeys = ['stage_cut','stage_bend','stage_fitting','stage_assembly','stage_qc','stage_stock'];
const productionStore = { left: [], right: [] };
let productionFormState = { isNew: true, removedIds: [], items: [], files: [] };

function productionEsc(v){ return String(v ?? '').replace(/[&<>"']/g, m => ({'&':'&amp;','<':'&lt;','>':'&gt;','"':'&quot;',"'":'&#39;'}[m])); }
function productionToInt(v){ const n = parseInt(String(v ?? '0'), 10); return Number.isFinite(n) ? n : 0; }
function productionStageState(v){ return ['todo','progress','done'].includes(v) ? v : 'todo'; }
function productionState(v){ return ['draft','confirmed','in_work','ready','closed','cancelled'].includes(v) ? v : 'draft'; }
function productionProgress(item){
  const w = { todo:0, progress:0.5, done:1 };
  let s = 0;
  productionStageKeys.forEach(k=>{ s += w[productionStageState(item?.[k])] || 0; });
  return Math.round((s / 6) * 1000) / 10;
}
function productionDeriveState(items, fallback='draft'){
  const list = Array.isArray(items) ? items : [];
  if (!list.length) return fallback;
  let allStockDone = true;
  let allQcDone = true;
  let anyStarted = false;
  list.forEach(it=>{
    const stock = productionStageState(it?.stage_stock);
    const qc = productionStageState(it?.stage_qc);
    if (stock !== 'done') allStockDone = false;
    if (qc !== 'done') allQcDone = false;
    productionStageKeys.forEach(k=>{ if (productionStageState(it?.[k]) !== 'todo') anyStarted = true; });
  });
  if (allStockDone) return 'closed';
  if (allQcDone) return 'ready';
  if (anyStarted) return 'in_work';
  return fallback;
}
function productionBuildQuery(side){
  const qs = new URLSearchParams();
  const no = (document.getElementById(`production-no-${side}`)?.value || '').trim();
  const orderId = (document.getElementById(`production-order-${side}`)?.value || '').trim();
  const address = (document.getElementById(`production-address-${side}`)?.value || '').trim();
  const dFrom = (document.getElementById(`production-deadline-from-${side}`)?.value || '').trim();
  const dTo = (document.getElementById(`production-deadline-to-${side}`)?.value || '').trim();
  const state = (document.getElementById(`production-state-${side}`)?.value || '').trim();
  if (no) qs.set('no', no);
  if (orderId) qs.set('order_id', orderId);
  if (address) qs.set('address', address);
  if (dFrom) qs.set('deadline_from', dFrom);
  if (dTo) qs.set('deadline_to', dTo);
  if (state) qs.set('state', state);
  return qs.toString();
}
function productionRenderTable(side){
  const tbody = document.querySelector(`#production-${side}-table tbody`);
  if (!tbody) return;
  const list = productionStore[side] || [];
  tbody.innerHTML = '';
  list.forEach(job=>{
    const tr = document.createElement('tr');
    const pct = Number(job.progress_pct || 0);
    tr.innerHTML =
      `<td class="cell-ellipsis">${productionEsc(job.prod_no || '—')}</td>` +
      `<td class="cell-ellipsis">${job.order_id ? ('#'+job.order_id) : '—'}</td>` +
      `<td class="cell-wrap">${productionEsc(job.address || '—')}</td>` +
      `<td class="cell-ellipsis">${productionEsc(job.deadline_date || '—')}</td>` +
      `<td class="cell-ellipsis">${productionEsc(productionStateLabels[job.state] || job.state || '—')}</td>` +
      `<td><div class="production-progress"><span style="width:${Math.max(0, Math.min(100, pct))}%"></span></div><div class="muted" style="font-size:12px;margin-top:4px">${pct}%</div></td>` +
      `<td class="cell-ellipsis">${productionToInt(job.items_count)}</td>` +
      `<td class="actions"><div class="btns"><button class="ghost production-open" data-no="${productionEsc(job.prod_no || '')}">Открыть</button></div></td>`;
    tbody.appendChild(tr);
  });
  if (!list.length){
    tbody.innerHTML = `<tr><td colspan="8"><span class="muted">Заказов на производство нет</span></td></tr>`;
  }
}
async function loadProduction(side, force=false){
  const pane = document.getElementById(`production-pane-${side}`);
  const table = document.getElementById(`production-${side}-table`);
  const tbody = document.querySelector(`#production-${side}-table tbody`);
  if (!pane || !table || !tbody) return;
  const cols = table.querySelector('colgroup')?.children?.length || 8;
  tbody.innerHTML = skeletonRows(cols, 7);
  await withOverlay(pane, async ()=>{
    const qs = productionBuildQuery(side);
    const res = await api('/api/production' + (qs ? ('?' + qs) : ''));
    productionStore[side] = res.ok ? await res.json() : [];
    productionRenderTable(side);
  });
}
function productionIsOpen(side){
  const el = document.getElementById(`production-${side}`);
  return !!(el && el.style.display !== 'none');
}
function productionRefreshOpen(){
  if (productionIsOpen('left')) loadProduction('left', true);
  if (productionIsOpen('right')) loadProduction('right', true);
}
async function productionEnsureProducts(){
  if (!stockState.list.length){
    await stockFetchList(true);
  }
}
function productionProductOptions(selectedId){
  const list = stockState.list || [];
  return list.map(p=>{
    const id = String(p.id || '');
    const sel = String(selectedId || '') === id ? 'selected' : '';
    return `<option value="${id}" ${sel}>${productionEsc(p.name || ('ID '+id))}</option>`;
  }).join('');
}
function productionDefaultItem(prefill = {}){
  const out = {
    id: prefill.id || null,
    product_id: productionToInt(prefill.product_id),
    qty: Math.max(0, productionToInt(prefill.qty || 1)),
    qty_done: Math.max(0, productionToInt(prefill.qty_done || 0)),
    stage_cut: productionStageState(prefill.stage_cut || 'todo'),
    stage_bend: productionStageState(prefill.stage_bend || 'todo'),
    stage_fitting: productionStageState(prefill.stage_fitting || 'todo'),
    stage_assembly: productionStageState(prefill.stage_assembly || 'todo'),
    stage_qc: productionStageState(prefill.stage_qc || 'todo'),
    stage_stock: productionStageState(prefill.stage_stock || 'todo')
  };
  return out;
}
function productionRenderItems(){
  const wrap = document.getElementById('production-items-wrap');
  if (!wrap) return;
  const list = productionFormState.items || [];
  if (!list.length){
    wrap.innerHTML = `<div class="muted">Позиции не добавлены</div>`;
    return;
  }
  wrap.innerHTML = list.map((it, idx)=>{
    const p = (stockState.list || []).find(x=>String(x.id)===String(it.product_id));
    const pName = p?.name || '';
    const pct = productionProgress(it);
    const stages = productionStageKeys.map(k=>{
      const opts = ['todo','progress','done'].map(v=>`<option value="${v}" ${it[k]===v?'selected':''}>${productionStageStateLabels[v]}</option>`).join('');
      return `<div class="adm-field"><label>${productionStageLabels[k]}</label><select data-i="${idx}" data-stage="${k}">${opts}</select></div>`;
    }).join('');
    return `
      <div class="production-file-row" data-row="${idx}" style="display:block">
        <div style="display:grid;grid-template-columns:minmax(220px,1fr) 120px 140px auto;gap:8px;align-items:end">
          <div class="adm-field">
            <label>Изделие</label>
            <select data-i="${idx}" data-field="product_id">${productionProductOptions(it.product_id)}</select>
            <div class="muted" style="font-size:12px;margin-top:4px">${productionEsc(pName)}</div>
          </div>
          <div class="adm-field">
            <label>Нужно, шт.</label>
            <input type="number" min="0" step="1" data-i="${idx}" data-field="qty" value="${productionToInt(it.qty)}">
          </div>
          <div class="adm-field">
            <label>Выполнено, шт.</label>
            <input type="number" min="0" step="1" data-i="${idx}" data-field="qty_done" value="${productionToInt(it.qty_done)}" disabled>
          </div>
          <div style="display:flex;justify-content:flex-end">
            <button class="ghost" data-act="remove-item" data-i="${idx}" type="button">Удалить</button>
          </div>
        </div>
        <div class="production-stages" style="margin-top:8px">${stages}</div>
        <div style="margin-top:8px">
          <div class="production-progress"><span style="width:${Math.max(0, Math.min(100, pct))}%"></span></div>
          <div class="muted" style="font-size:12px;margin-top:4px">Прогресс позиции: ${pct}%</div>
        </div>
      </div>
    `;
  }).join('');
}
function productionRenderFiles(){
  const wrap = document.getElementById('production-files-list');
  if (!wrap) return;
  const files = productionFormState.files || [];
  if (!files.length){
    wrap.innerHTML = `<div class="muted">Файлы не загружены</div>`;
    return;
  }
  wrap.innerHTML = files.map(f=>`
    <div class="production-file-row">
      <a href="${productionEsc(f.file_url || '')}" target="_blank" rel="noopener">${productionEsc(f.file_name || f.file_url || 'Файл')}</a>
      <button class="ghost" data-act="remove-file" data-id="${productionToInt(f.id)}" type="button">Удалить</button>
    </div>
  `).join('');
}
async function productionOpenByNo(prodNo){
  if (!prodNo) return;
  await productionEnsureProducts();
  const res = await api('/api/production/' + encodeURIComponent(prodNo));
  if (!res.ok){ alert('Не удалось загрузить производственный заказ'); return; }
  const job = await res.json();
  productionFormState = {
    isNew: false,
    removedIds: [],
    prod_no: job.prod_no || '',
    order_id: job.order_id || '',
    address: job.address || '',
    deadline_date: job.deadline_date || '',
    state: productionState(job.state || 'draft'),
    comment: job.comment || '',
    items: (job.items || []).map(productionDefaultItem),
    files: job.files || []
  };
  document.getElementById('production-form-no').value = productionFormState.prod_no || '';
  document.getElementById('production-form-order-id').value = productionFormState.order_id || '';
  document.getElementById('production-form-address').value = productionFormState.address || '';
  document.getElementById('production-form-deadline').value = productionFormState.deadline_date || '';
  document.getElementById('production-form-state').value = productionFormState.state || 'draft';
  document.getElementById('production-form-comment').value = productionFormState.comment || '';
  document.getElementById('production-modal-title').textContent = `Заказ на производство ${productionFormState.prod_no}`;
  productionRenderItems();
  productionRenderFiles();
  document.getElementById('production-modal-backdrop').style.display = 'flex';
}
async function productionOpenNew(prefill = {}){
  await productionEnsureProducts();
  productionFormState = {
    isNew: true,
    removedIds: [],
    prod_no: '',
    order_id: prefill.order_id || '',
    address: prefill.address || '',
    deadline_date: prefill.deadline_date || '',
    state: productionState(prefill.state || 'draft'),
    comment: prefill.comment || '',
    items: (prefill.items || [productionDefaultItem()]).map(productionDefaultItem),
    files: []
  };
  document.getElementById('production-form-no').value = 'будет после сохранения';
  document.getElementById('production-form-order-id').value = productionFormState.order_id || '';
  document.getElementById('production-form-address').value = productionFormState.address || '';
  document.getElementById('production-form-deadline').value = productionFormState.deadline_date || '';
  document.getElementById('production-form-state').value = productionFormState.state || 'draft';
  document.getElementById('production-form-comment').value = productionFormState.comment || '';
  document.getElementById('production-modal-title').textContent = 'Заказ на производство';
  productionRenderItems();
  productionRenderFiles();
  document.getElementById('production-modal-backdrop').style.display = 'flex';
}
function productionCloseModal(){
  const back = document.getElementById('production-modal-backdrop');
  if (back) back.style.display = 'none';
}
function productionCollectPayload(){
  const orderRaw = (document.getElementById('production-form-order-id')?.value || '').trim();
  const orderId = orderRaw ? productionToInt(orderRaw) : null;
  const address = (document.getElementById('production-form-address')?.value || '').trim();
  const deadline_date = (document.getElementById('production-form-deadline')?.value || '').trim();
  let state = productionState((document.getElementById('production-form-state')?.value || 'draft'));
  const comment = (document.getElementById('production-form-comment')?.value || '').trim();
  const items = (productionFormState.items || []).map(it=>({
    id: it.id || undefined,
    product_id: productionToInt(it.product_id),
    qty: Math.max(0, productionToInt(it.qty)),
    stage_cut: productionStageState(it.stage_cut),
    stage_bend: productionStageState(it.stage_bend),
    stage_fitting: productionStageState(it.stage_fitting),
    stage_assembly: productionStageState(it.stage_assembly),
    stage_qc: productionStageState(it.stage_qc),
    stage_stock: productionStageState(it.stage_stock)
  })).filter(it=>it.product_id > 0 && it.qty >= 0);
  if (!['cancelled','closed'].includes(state)){
    const derived = productionDeriveState(items, state);
    if (['in_work','ready','closed'].includes(derived)) state = derived;
  }
  return {
    order_id: orderId,
    address,
    deadline_date,
    state,
    comment,
    items,
    remove_ids: productionFormState.removedIds || []
  };
}
async function productionSave(){
  const payload = productionCollectPayload();
  if (!payload.items.length){ alert('Добавьте хотя бы одну позицию'); return; }
  if (productionFormState.isNew){
    const res = await api('/api/production', { method:'POST', body: JSON.stringify(payload) });
    if (!res.ok){
      const err = await res.json().catch(()=>({}));
      if (err?.error === 'exists'){ alert(`Для этого заказа уже есть производство: ${err.prod_no}`); }
      else alert('Не удалось создать заказ на производство');
      return;
    }
    const job = await res.json();
    await productionOpenByNo(job.prod_no);
    productionRefreshOpen();
    return;
  }
  const no = productionFormState.prod_no;
  const res = await api('/api/production/' + encodeURIComponent(no), { method:'PATCH', body: JSON.stringify(payload) });
  if (!res.ok){ alert('Не удалось сохранить заказ на производство'); return; }
  const job = await res.json();
  await productionOpenByNo(job.prod_no);
  productionRefreshOpen();
  stockRefreshOpen();
}
async function productionUploadFile(){
  const no = productionFormState.prod_no;
  if (!no){ alert('Сначала сохраните заказ'); return; }
  const input = document.getElementById('production-file-input');
  const file = input?.files?.[0];
  if (!file){ alert('Выберите файл'); return; }
  const fd = new FormData();
  fd.append('file', file);
  const up = await fetch('/api/production/upload', {
    method:'POST',
    credentials:'include',
    headers:{ 'x-dev-auth': '1' },
    body: fd
  });
  if (!up.ok){ alert('Не удалось загрузить файл'); return; }
  const data = await up.json();
  const save = await api('/api/production/' + encodeURIComponent(no) + '/files', {
    method:'POST',
    body: JSON.stringify({ url: data.url, name: data.name || file.name })
  });
  if (!save.ok){ alert('Файл загружен, но не привязан к заказу'); return; }
  input.value = '';
  await productionOpenByNo(no);
}
async function productionRemoveFile(fileId){
  const no = productionFormState.prod_no;
  if (!no || !fileId) return;
  const res = await api('/api/production/' + encodeURIComponent(no) + '/files/' + fileId, { method:'DELETE' });
  if (!res.ok){ alert('Не удалось удалить файл'); return; }
  await productionOpenByNo(no);
}
async function productionCreateFromOrder(orderId){
  if (!orderId) return;
  const res = await api('/api/production/from-order', {
    method:'POST',
    body: JSON.stringify({ order_id: Number(orderId) })
  });
  if (!res.ok){
    const err = await res.json().catch(()=>({}));
    if (err?.error === 'no_shortage'){
      alert('Для этого заказа дефицита нет — производство не требуется');
      return;
    }
    alert('Не удалось сформировать заказ на производство');
    return;
  }
  const job = await res.json();
  await productionOpenByNo(job.prod_no);
  productionRefreshOpen();
}
function productionCancelChoice(orderId, jobs){
  const backdrop = document.getElementById('cancel-prod-modal-backdrop');
  const text = document.getElementById('cancel-prod-modal-text');
  const btnAbort = document.getElementById('cancel-prod-modal-abort');
  const btnDetach = document.getElementById('cancel-prod-modal-detach');
  const btnCancel = document.getElementById('cancel-prod-modal-cancel');
  const btnX = document.getElementById('cancel-prod-modal-close');
  if (!backdrop || !text || !btnAbort || !btnDetach || !btnCancel || !btnX) return Promise.resolve(null);
  const active = (jobs || []).filter(j => !['cancelled','closed'].includes(String(j.state || '')));
  if (!active.length) return Promise.resolve(null);
  const names = active.map(j => j.prod_no).filter(Boolean).join(', ');
  text.textContent = `По заказу #${orderId} есть активное производство (${names}). Что сделать?`;
  backdrop.style.display = 'flex';
  return new Promise(resolve=>{
    const cleanup = ()=>{
      backdrop.style.display = 'none';
      btnAbort.onclick = btnDetach.onclick = btnCancel.onclick = btnX.onclick = backdrop.onclick = null;
    };
    btnAbort.onclick = ()=>{ cleanup(); resolve(null); };
    btnX.onclick = ()=>{ cleanup(); resolve(null); };
    backdrop.onclick = (e)=>{ if (e.target === backdrop){ cleanup(); resolve(null); } };
    btnDetach.onclick = ()=>{ cleanup(); resolve('detach'); };
    btnCancel.onclick = ()=>{ cleanup(); resolve('cancel'); };
  });
}

/* ===== СТАТИСТИКА ===== */
function loadStats(){
  const resultEl = document.getElementById('stats-result');
  const topEl    = document.getElementById('top-customers');
  const pane     = document.getElementById('stats-pane');
  resultEl.innerHTML = '<span class="muted">...</span>';
  topEl.innerHTML    = '<span class="muted">...</span>';

  const toNum = v => {
    if (v == null) return 0;
    const s = String(v).replace(/\s+/g,'').replace(',', '.');
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  };
  const fmt = v => toNum(v).toLocaleString('ru-RU',{minimumFractionDigits:2, maximumFractionDigits:2});

  return withOverlay(pane, async ()=>{
    const from = document.getElementById('from').value;
    const to   = document.getElementById('to').value;
    const st   = document.getElementById('stat-status').value;

    // Грузим заказы + весь каталог (каталог нужен, чтобы показать нули)
    const [resOrders, resProducts] = await Promise.all([api('/api/orders'), api('/api/products')]);
    if (!resOrders.ok){ resultEl.textContent='Ошибка загрузки'; topEl.textContent=''; return; }
    const orders   = await resOrders.json();
    const products = resProducts.ok ? await resProducts.json() : [];

    const fromMs = from ? new Date(from+'T00:00:00').getTime() : -Infinity;
    const toMs   = to   ? new Date(to  +'T23:59:59').getTime() :  Infinity;

    // Фильтруем ТОЛЬКО по дате и статусу. Фильтра по товару уже нет.
    const list = orders.filter(o=>{
      const t = o.created_at ? new Date(o.created_at).getTime() : 0;
      const inDate   = t >= fromMs && t <= toMs;
      const byStatus = st ? (o.status === st) : true;
      return inDate && byStatus;
    });

    await ensureItems(list);


    const totalRevenue = list.reduce((s,o)=> s + toNum(o.total), 0);
    const ordersCount  = list.length;

    // Топ клиентов (как было)
    const byCustomer = new Map();
    list.forEach(o=>{
      const key = (o.customer_name || 'Без имени') + ' / ' + (o.phone || '—');
      byCustomer.set(key, (byCustomer.get(key)||0) + toNum(o.total));
    });
    const topCustomers = [...byCustomer.entries()].sort((a,b)=> b[1]-a[1]).slice(0,5);

    // Подсчет по всем товарам, включая 0
    const idToName    = new Map(products.map(p => [String(p.id), (p.name || ('ID '+p.id))]));
    const countsById  = new Map([...idToName.keys()].map(id => [id, 0]));

    list.forEach(o=>{
      (o.items || []).forEach(it=>{
        const id  = String(it.product_id ?? it.productId ?? it.id ?? '');
        const qty = toNum(it.qty ?? it.quantity ?? 0);
        if (countsById.has(id)) {
          countsById.set(id, countsById.get(id) + qty);
        } else {
        }
      });
    });

    // Преобразуем в [имя, количество], сортируем по количеству. НИЧЕГО не обрезаем.
    const allProducts = [...countsById.entries()]
      .map(([idOrName, qty]) => [idToName.get(idOrName) ?? idOrName, qty])
      .sort((a,b)=> b[1]-a[1]);
    
    window.__lastStatsRight = {
  from, to, st, totalRevenue, ordersCount,
  topCustomers, allProducts
};

    resultEl.innerHTML =
      
`<div class="stats-kpis">
  <div class="stat-card"><div class="stat-title">Выручка</div><div class="stat-value">${fmt(totalRevenue)} ₽</div></div>
  <div class="stat-card"><div class="stat-title">Заказов</div><div class="stat-value">${ordersCount}</div></div>
  <div class="stat-card"><div class="stat-title">Статус</div><div class="stat-value">${st || 'все'}</div></div>
  <div class="stat-card"><div class="stat-title">Период</div><div class="stat-value">${from || '—'} — ${to || '—'}</div></div>
</div>`; resultEl.classList && resultEl.classList.remove('muted');

    topEl.innerHTML =
      
`<div class="stats-lists">
  <div class="list-card">
    <div class="list-title">Топ клиентов</div>
    <ol class="stat-list">${
      topCustomers.length 
        ? topCustomers.map(([k,v])=> `<li><span>${k}</span><b>${fmt(v)} ₽</b></li>`).join('') 
        : '<li class="muted">—</li>'
    }</ol>
  </div>
  <div class="list-card">
    <div class="list-title">Топ товаров</div>
    <ol class="stat-list">${
      allProducts.length 
        ? allProducts.map(([n,q])=> `<li><span>${n}</span><b>${q} шт.</b></li>`).join('') 
        : '<li class="muted">—</li>'
    }</ol>
  </div>
</div>`; topEl.classList && topEl.classList.remove('muted');
  });
}

  /* Левое меню */
  function showLeft(section){
    document.getElementById('left-menu').style.display='none';
    document.getElementById('products-left').style.display='none';
    document.getElementById('stats-left').style.display='none';
    document.getElementById('orders-left').style.display='none';
    document.getElementById('stock-left').style.display='none';
    document.getElementById('production-left').style.display='none';
    document.getElementById('dds-left').style.display='none';
    const el=document.getElementById(section+'-left'); if(el) el.style.display='block';
    if(section==='products') loadProductsShortInto('products-left-table','products-pane-left');
    if(section==='stats') populateStatProductsLeft();
    if(section==='orders'){ loadOrdersInto('#orders-left-table tbody','orders-left-pane','status-filter-left', currentSortLeft); wireOrderSort('#orders-left-table', currentSortLeft, ()=>loadOrdersInto('#orders-left-table tbody','orders-left-pane','status-filter-left', currentSortLeft)); }
    if(section==='stock'){ loadStock('left'); }
    if(section==='production'){ loadProduction('left', true); }
    if(section==='dds'){ loadDds('left'); }
  }
  function backToMenuLeft(){
    document.getElementById('left-menu').style.display='block';
    document.getElementById('products-left').style.display='none';
    document.getElementById('stats-left').style.display='none';
    document.getElementById('orders-left').style.display='none';
    document.getElementById('stock-left').style.display='none';
    document.getElementById('production-left').style.display='none';
    document.getElementById('dds-left').style.display='none';
  }
  document.getElementById('open-products-left').addEventListener('click', ()=>showLeft('products'));
  document.getElementById('open-stats-left').addEventListener('click', ()=>showLeft('stats'));
  document.getElementById('open-orders-left').addEventListener('click', ()=>showLeft('orders'));
  document.getElementById('open-stock-left').addEventListener('click', ()=>showLeft('stock'));
  document.getElementById('open-production-left').addEventListener('click', ()=>showLeft('production'));
  const ddsLeft = document.getElementById('open-dds-left');
  if (ddsLeft) ddsLeft.addEventListener('click', ()=>showLeft('dds'));
  document.getElementById('close-products-left').addEventListener('click', backToMenuLeft);
  document.getElementById('close-stats-left').addEventListener('click', backToMenuLeft);
  document.getElementById('close-orders-left').addEventListener('click', backToMenuLeft);
  document.getElementById('close-stock-left').addEventListener('click', backToMenuLeft);
  document.getElementById('close-production-left').addEventListener('click', backToMenuLeft);
  document.getElementById('close-dds-left').addEventListener('click', backToMenuLeft);

  async function populateStatProductsLeft(){ return; }
async function loadStatsLeft(){
  const resultEl = document.getElementById('stats-result-left');
  const topEl    = document.getElementById('top-customers-left');
  const pane     = document.getElementById('stats-pane-left');
  resultEl.innerHTML = '<span class="muted">...</span>';
  topEl.innerHTML    = '<span class="muted">...</span>';

  const toNum = v => {
    if (v == null) return 0;
    const s = String(v).replace(/\s+/g,'').replace(',', '.');
    const n = Number(s);
    return Number.isFinite(n) ? n : 0;
  };
  const fmt = v => toNum(v).toLocaleString('ru-RU',{minimumFractionDigits:2, maximumFractionDigits:2});

  await withOverlay(pane, async ()=>{
    const from = document.getElementById('from-left').value;
    const to   = document.getElementById('to-left').value;
    const st   = document.getElementById('stat-status-left').value;

    const [resOrders, resProducts] = await Promise.all([api('/api/orders'), api('/api/products')]);
    if (!resOrders.ok){ resultEl.textContent='Ошибка загрузки'; topEl.textContent=''; return; }
    const orders   = await resOrders.json();
    const products = resProducts.ok ? await resProducts.json() : [];

    const fromMs = from ? new Date(from+'T00:00:00').getTime() : -Infinity;
    const toMs   = to   ? new Date(to  +'T23:59:59').getTime() :  Infinity;

    const list = orders.filter(o=>{
      const t = o.created_at ? new Date(o.created_at).getTime() : 0;
      const inDate   = t >= fromMs && t <= toMs;
      const byStatus = st ? (o.status === st) : true;
      return inDate && byStatus;
    });

    await ensureItems(list);


    const totalRevenue = list.reduce((s,o)=> s + toNum(o.total), 0);
    const ordersCount  = list.length;

    const byCustomer = new Map();
    list.forEach(o=>{
      const key = (o.customer_name || 'Без имени') + ' / ' + (o.phone || '—');
      byCustomer.set(key, (byCustomer.get(key)||0) + toNum(o.total));
    });
    const topCustomers = [...byCustomer.entries()].sort((a,b)=> b[1]-a[1]).slice(0,5);

    const idToName   = new Map(products.map(p => [String(p.id), (p.name || ('ID '+p.id))]));
    const countsById = new Map([...idToName.keys()].map(id => [id, 0]));

    list.forEach(o=>{
      (o.items || []).forEach(it=>{
        const id  = String(it.product_id ?? it.productId ?? it.id ?? '');
        const qty = toNum(it.qty ?? it.quantity ?? 0);
        if (countsById.has(id)) countsById.set(id, countsById.get(id) + qty);
        else {
        }
      });
    });

    const allProducts = [...countsById.entries()]
      .map(([idOrName, qty]) => [idToName.get(idOrName) ?? idOrName, qty])
      .sort((a,b)=> b[1]-a[1]);
      
    window.__lastStatsRight = {
  from, to, st, totalRevenue, ordersCount,
  topCustomers, allProducts
};

    resultEl.innerHTML =
      
`<div class="stats-kpis">
  <div class="stat-card"><div class="stat-title">Выручка</div><div class="stat-value">${fmt(totalRevenue)} ₽</div></div>
  <div class="stat-card"><div class="stat-title">Заказов</div><div class="stat-value">${ordersCount}</div></div>
  <div class="stat-card"><div class="stat-title">Статус</div><div class="stat-value">${st || 'все'}</div></div>
  <div class="stat-card"><div class="stat-title">Период</div><div class="stat-value">${from || '—'} — ${to || '—'}</div></div>
</div>`; resultEl.classList && resultEl.classList.remove('muted');

    topEl.innerHTML =
      
`<div class="stats-lists">
  <div class="list-card">
    <div class="list-title">Топ клиентов</div>
    <ol class="stat-list">${
      topCustomers.length 
        ? topCustomers.map(([k,v])=> `<li><span>${k}</span><b>${fmt(v)} ₽</b></li>`).join('') 
        : '<li class="muted">—</li>'
    }</ol>
  </div>
  <div class="list-card">
    <div class="list-title">Топ товаров</div>
    <ol class="stat-list">${
      allProducts.length 
        ? allProducts.map(([n,q])=> `<li><span>${n}</span><b>${q} шт.</b></li>`).join('') 
        : '<li class="muted">—</li>'
    }</ol>
  </div>
</div>`; topEl.classList && topEl.classList.remove('muted');
  });
}
  document.getElementById('load-stats-left').addEventListener('click', async (ev)=>{ await withOverlay(ev.currentTarget, async ()=>{ await loadStatsLeft(); }); });

  /* Правое меню */
  function showRight(section){
    document.getElementById('right-menu').style.display='none';
    document.getElementById('products-right').style.display='none';
    document.getElementById('stats-right').style.display='none';
    document.getElementById('orders-right').style.display='none';
    document.getElementById('stock-right').style.display='none';
    document.getElementById('production-right').style.display='none';
    document.getElementById('dds-right').style.display='none';
    const el=document.getElementById(section+'-right'); if(el) el.style.display='block';
    if(section==='products') loadProductsShortInto('products-table','products-pane');
    if(section==='stats') populateStatProducts();
    if(section==='orders'){ loadOrdersInto('#orders-right-table tbody','orders-right-pane','status-filter-right', currentSortRight); wireOrderSort('#orders-right-table', currentSortRight, ()=>loadOrdersInto('#orders-right-table tbody','orders-right-pane','status-filter-right', currentSortRight)); }
    if(section==='stock'){ loadStock('right'); }
    if(section==='production'){ loadProduction('right', true); }
    if(section==='dds'){ loadDds('right'); }
  }
  function backToMenu(){ document.getElementById('right-menu').style.display='block'; document.getElementById('products-right').style.display='none'; document.getElementById('stats-right').style.display='none'; document.getElementById('orders-right').style.display='none'; document.getElementById('stock-right').style.display='none'; document.getElementById('production-right').style.display='none'; document.getElementById('dds-right').style.display='none'; }

  document.getElementById('open-products').addEventListener('click', ()=>showRight('products'));
  document.getElementById('open-stats').addEventListener('click', ()=>showRight('stats'));
  document.getElementById('open-orders-right').addEventListener('click', ()=>showRight('orders'));
  document.getElementById('open-stock').addEventListener('click', ()=>showRight('stock'));
  document.getElementById('open-production').addEventListener('click', ()=>showRight('production'));
  const ddsRight = document.getElementById('open-dds');
  if (ddsRight) ddsRight.addEventListener('click', ()=>showRight('dds'));
  document.getElementById('close-products').addEventListener('click', backToMenu);
  document.getElementById('close-stats').addEventListener('click', backToMenu);
  document.getElementById('close-orders-right').addEventListener('click', backToMenu);
  document.getElementById('close-stock-right').addEventListener('click', backToMenu);
  document.getElementById('close-production-right').addEventListener('click', backToMenu);
  document.getElementById('close-dds-right').addEventListener('click', backToMenu);
  document.getElementById('load-stats').addEventListener('click', async (ev)=>{ await withOverlay(ev.currentTarget, async ()=>{ await loadStats(); }); });
  document.getElementById('dds-apply-left').addEventListener('click', ()=>loadDds('left'));
  document.getElementById('dds-apply-right').addEventListener('click', ()=>loadDds('right'));
  document.getElementById('dds-export-left').addEventListener('click', ()=>exportDds('left'));
  document.getElementById('dds-export-right').addEventListener('click', ()=>exportDds('right'));

  document.getElementById('stock-refresh-left').addEventListener('click', ()=>loadStock('left', true));
  document.getElementById('stock-refresh-right').addEventListener('click', ()=>loadStock('right', true));
  document.getElementById('stock-history-left').addEventListener('click', ()=>stockMovementsOpen(0));
  document.getElementById('stock-history-right').addEventListener('click', ()=>stockMovementsOpen(0));
  document.getElementById('stock-search-left').addEventListener('input', ()=>loadStock('left'));
  document.getElementById('stock-search-right').addEventListener('input', ()=>loadStock('right'));
  document.getElementById('stock-in-left').addEventListener('click', stockIncomingOpen);
  document.getElementById('stock-in-right').addEventListener('click', stockIncomingOpen);
  document.getElementById('stock-adjust-left').addEventListener('click', stockAdjustOpen);
  document.getElementById('stock-adjust-right').addEventListener('click', stockAdjustOpen);
  document.getElementById('stock-upd-left').addEventListener('click', ()=>updOpen());
  document.getElementById('stock-upd-right').addEventListener('click', ()=>updOpen());

  document.getElementById('reload-orders-left').addEventListener('click', async (ev)=>{
    await withOverlay(ev.currentTarget, async ()=>{ ordersCache=[]; await loadOrdersInto('#orders-left-table tbody','orders-left-pane','status-filter-left', currentSortLeft); });
  });
  document.getElementById('status-filter-left').addEventListener('change', ()=>{
    loadOrdersInto('#orders-left-table tbody','orders-left-pane','status-filter-left', currentSortLeft);
  });
  document.getElementById('reload-orders-right').addEventListener('click', async (ev)=>{
    await withOverlay(ev.currentTarget, async ()=>{ ordersCache=[]; await loadOrdersInto('#orders-right-table tbody','orders-right-pane','status-filter-right', currentSortRight); });
  });
  document.getElementById('status-filter-right').addEventListener('change', ()=>{
    loadOrdersInto('#orders-right-table tbody','orders-right-pane','status-filter-right', currentSortRight);
  });

  document.getElementById('production-apply-left').addEventListener('click', ()=>loadProduction('left', true));
  document.getElementById('production-apply-right').addEventListener('click', ()=>loadProduction('right', true));
  document.getElementById('production-refresh-left').addEventListener('click', ()=>loadProduction('left', true));
  document.getElementById('production-refresh-right').addEventListener('click', ()=>loadProduction('right', true));
  document.getElementById('production-add-left').addEventListener('click', ()=>productionOpenNew());
  document.getElementById('production-add-right').addEventListener('click', ()=>productionOpenNew());

  ['left','right'].forEach(side=>{
    const table = document.getElementById(`production-${side}-table`);
    table?.addEventListener('click', (e)=>{
      const btn = e.target.closest('.production-open');
      if (!btn) return;
      const no = btn.getAttribute('data-no') || '';
      if (no) productionOpenByNo(no);
    });
  });

  const productionBackdrop = document.getElementById('production-modal-backdrop');
  document.getElementById('production-modal-close')?.addEventListener('click', productionCloseModal);
  document.getElementById('production-close-btn')?.addEventListener('click', productionCloseModal);
  productionBackdrop?.addEventListener('click', (e)=>{ if (e.target === productionBackdrop) productionCloseModal(); });
  document.getElementById('production-save')?.addEventListener('click', (e)=>{ e.preventDefault(); productionSave(); });
  document.getElementById('production-item-add')?.addEventListener('click', (e)=>{
    e.preventDefault();
    productionFormState.items.push(productionDefaultItem());
    productionRenderItems();
  });
  document.getElementById('production-file-upload')?.addEventListener('click', (e)=>{ e.preventDefault(); productionUploadFile(); });
  document.getElementById('production-items-wrap')?.addEventListener('change', (e)=>{
    const t = e.target;
    const idx = productionToInt(t?.dataset?.i);
    if (!Number.isFinite(idx) || !productionFormState.items[idx]) return;
    if (t.dataset.field === 'product_id'){
      productionFormState.items[idx].product_id = productionToInt(t.value);
      productionRenderItems();
      return;
    }
    if (t.dataset.field === 'qty'){
      productionFormState.items[idx].qty = Math.max(0, productionToInt(t.value));
      return;
    }
    if (t.dataset.stage){
      productionFormState.items[idx][t.dataset.stage] = productionStageState(t.value);
      productionRenderItems();
      return;
    }
  });
  document.getElementById('production-items-wrap')?.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-act="remove-item"]');
    if (!btn) return;
    const idx = productionToInt(btn.dataset.i);
    const item = productionFormState.items[idx];
    if (!item) return;
    if (item.id) productionFormState.removedIds.push(item.id);
    productionFormState.items.splice(idx, 1);
    productionRenderItems();
  });
  document.getElementById('production-files-list')?.addEventListener('click', (e)=>{
    const btn = e.target.closest('[data-act="remove-file"]');
    if (!btn) return;
    const id = productionToInt(btn.dataset.id);
    if (id > 0) productionRemoveFile(id);
  });

  async function populateStatProducts(){ return; }

  document.addEventListener('DOMContentLoaded', async ()=>{ backToMenu(); backToMenuLeft(); });

  document.addEventListener('click', (e)=>{
    const move = e.target.closest('.stock-move');
    if (move){ stockMovementsOpen(move.dataset.id); }
  });

  document.getElementById('stock-in-add-row')?.addEventListener('click', (e)=>{ e.preventDefault(); stockAddIncomingRow(); });
  document.getElementById('stock-in-save')?.addEventListener('click', (e)=>{ e.preventDefault(); stockIncomingSave(); });
  document.getElementById('stock-in-cancel')?.addEventListener('click', (e)=>{ e.preventDefault(); stockIncomingClose(); });
  document.getElementById('stock-in-close')?.addEventListener('click', (e)=>{ e.preventDefault(); stockIncomingClose(); });
  document.getElementById('stock-in-backdrop')?.addEventListener('click', (e)=>{ if (e.target && e.target.id === 'stock-in-backdrop') stockIncomingClose(); });

  document.getElementById('stock-doc-file')?.addEventListener('change', (e)=>{
    const label = document.getElementById('stock-doc-file-label');
    const file = e.target.files && e.target.files[0];
    if (label) label.textContent = file ? file.name : 'Файл не выбран';
  });

  document.getElementById('stock-adjust-save')?.addEventListener('click', (e)=>{ e.preventDefault(); stockAdjustSave(); });
  document.getElementById('stock-adjust-cancel')?.addEventListener('click', (e)=>{ e.preventDefault(); stockAdjustClose(); });
  document.getElementById('stock-adjust-close')?.addEventListener('click', (e)=>{ e.preventDefault(); stockAdjustClose(); });
  document.getElementById('stock-adjust-backdrop')?.addEventListener('click', (e)=>{ if (e.target && e.target.id === 'stock-adjust-backdrop') stockAdjustClose(); });

  document.getElementById('stock-movements-close')?.addEventListener('click', (e)=>{ e.preventDefault(); stockMovementsClose(); });
  document.getElementById('stock-movements-backdrop')?.addEventListener('click', (e)=>{ if (e.target && e.target.id === 'stock-movements-backdrop') stockMovementsClose(); });
  document.getElementById('stock-movements-search')?.addEventListener('input', ()=>stockMovementsRenderTable());
  document.getElementById('stock-movements-type')?.addEventListener('change', ()=>stockMovementsRenderTable());
  document.getElementById('stock-movements-reason')?.addEventListener('change', ()=>stockMovementsRenderTable());
  document.getElementById('stock-movements-refresh')?.addEventListener('click', (e)=>{ e.preventDefault(); stockMovementsOpen(stockMovementsState.productId || 0); });

  document.getElementById('stock-dds-save')?.addEventListener('click', (e)=>{
    e.preventDefault();
    const date = document.getElementById('stock-dds-date')?.value || new Date().toISOString().slice(0,10);
    const amount = parseFloat(document.getElementById('stock-dds-amount')?.value || '0') || 0;
    const payment = document.getElementById('stock-dds-payment')?.value || 'bank';
    const comment = (document.getElementById('stock-dds-comment')?.value || '').trim();
    if (amount <= 0){ alert('Укажите сумму'); return; }
    stockDdsModalClose({ date, amount, payment_method: payment, comment });
  });
  document.getElementById('stock-dds-cancel')?.addEventListener('click', (e)=>{ e.preventDefault(); stockDdsModalClose(null); });
  document.getElementById('stock-dds-close')?.addEventListener('click', (e)=>{ e.preventDefault(); stockDdsModalClose(null); });
  document.getElementById('stock-dds-backdrop')?.addEventListener('click', (e)=>{ if (e.target && e.target.id === 'stock-dds-backdrop') stockDdsModalClose(null); });

  document.getElementById('stock-dds-confirm-primary')?.addEventListener('click', (e)=>{ e.preventDefault(); stockConfirmClose(true); });
  document.getElementById('stock-dds-confirm-secondary')?.addEventListener('click', (e)=>{ e.preventDefault(); stockConfirmClose(false); });
  document.getElementById('stock-dds-confirm-close')?.addEventListener('click', (e)=>{ e.preventDefault(); stockConfirmClose(null); });
  document.getElementById('stock-dds-confirm-backdrop')?.addEventListener('click', (e)=>{ if (e.target && e.target.id === 'stock-dds-confirm-backdrop') stockConfirmClose(null); });

  /* === Настройки === */
  const settingsBackdrop = document.getElementById('settings-modal-backdrop');
  const openSettingsBtn = document.getElementById('open-settings');
  const settingsCloseBtn = document.getElementById('settings-modal-close');
  const settingsCancelBtn = document.getElementById('settings-cancel');
  const settingsSaveBtn = document.getElementById('settings-save');
  const settingsGenUidBtn = document.getElementById('set_edi_sender_gen');
  const notifyTestBtn = document.getElementById('set_notify_tg_test');
  const notifyTestStatus = document.getElementById('set_notify_tg_test_status');

  function uuidv4(){
    return 'xxxxxxxx-xxxx-4xxx-yxxx-xxxxxxxxxxxx'.replace(/[xy]/g, c=>{
      const r = Math.random()*16|0, v = c==='x'?r:(r&0x3|0x8); return v.toString(16);
    });
  }

  let settingsCache = null;
  async function getSettingsCache(){
    if (settingsCache) return settingsCache;
    const res = await api('/api/settings');
    settingsCache = res.ok ? await res.json() : {};
    return settingsCache;
  }

  async function loadSettings(){
    const res = await api('/api/settings');
    const data = res.ok ? await res.json() : {};
    const s = data.seller || {};
    const seo = data.seo || {};
    const home = data.home || {};
    document.getElementById('set_seller_type').value = s.type || 'org';
    document.getElementById('set_seller_name').value = s.name || s.fio || '';
    document.getElementById('set_seller_inn').value = s.inn || '';
    document.getElementById('set_seller_kpp').value = s.kpp || '';
    document.getElementById('set_seller_address').value = s.address || '';
    document.getElementById('set_seller_phone').value = s.phone || '';
    document.getElementById('set_seller_email').value = s.email || '';
    document.getElementById('set_bank_name').value = s.bank_name || '';
    document.getElementById('set_bank_bik').value = s.bank_bik || '';
    document.getElementById('set_bank_corr').value = s.bank_corr || '';
    document.getElementById('set_bank_account').value = s.bank_account || '';
    document.getElementById('set_vat_rate').value = s.vat_rate || 'без НДС';
    document.getElementById('set_vat_included').checked = !!s.vat_included;
    document.getElementById('set_unit_code').value = s.unit_code || '796';
    document.getElementById('set_unit_name').value = s.unit_name || 'шт';
    document.getElementById('set_operation_content').value = s.operation_content || 'Отгрузка товаров';
    document.getElementById('set_basis_name').value = s.basis_name || 'Заказ';
    document.getElementById('set_edi_operator').value = s.edi_operator || '000';
    document.getElementById('set_edi_sender_uid').value = s.edi_sender_uid || '';
    const notifications = data.notifications || {};
    document.getElementById('set_notify_tg_enabled').checked = !!notifications.telegram_enabled;
    document.getElementById('set_notify_tg_bot_token').value = notifications.telegram_bot_token || '';
    document.getElementById('set_notify_tg_chat_id').value = notifications.telegram_chat_id || '';
    document.getElementById('set_notify_email_enabled').checked = !!notifications.email_enabled;
    document.getElementById('set_notify_email_to').value = notifications.email_to || '';
    document.getElementById('set_notify_email_subject').value = notifications.email_subject || '';
    if (notifyTestStatus) notifyTestStatus.textContent = '';
    const defaultCanonical = (location && location.origin ? location.origin : 'https://stilva.ru') + '/';
    document.getElementById('set_seo_site_name').value = seo.site_name || 'STILVA';
    document.getElementById('set_seo_title').value = seo.title || 'Стеллажи из нержавеющей стали для общепита и склада — STILVA';
    document.getElementById('set_seo_description').value = seo.description || 'Производим и поставляем стеллажи из нержавейки: типовые размеры и изготовление под задачу, перфорированные и сплошные полки, подбор стали AISI 304/430, расчёт и доставка по России.';
    document.getElementById('set_seo_keywords').value = seo.keywords || 'стеллажи из нержавеющей стали, стеллажи из нержавейки, стеллажи для общепита, стеллажи для кухни, стеллажи для склада, стеллажи AISI 304, стеллажи AISI 430, перфорированные полки, производственные стеллажи, стеллажи на заказ, производство стеллажей';
    document.getElementById('set_seo_canonical').value = seo.canonical || defaultCanonical;
    document.getElementById('set_seo_robots').value = seo.robots || 'index,follow,max-image-preview:large,max-snippet:-1,max-video-preview:-1';
    document.getElementById('set_seo_og_title').value = seo.og_title || 'Нержавеющие стеллажи STILVA — кухня, общепит, склад';
    document.getElementById('set_seo_og_description').value = seo.og_description || 'Стеллажи из нержавеющей стали для кухни, общепита и складов. Типовые размеры и изготовление под задачу, доставка по России.';
    document.getElementById('set_seo_og_image').value = seo.og_image || (defaultCanonical + 'pictures/1000x400x1800.png');
    document.getElementById('set_seo_og_type').value = seo.og_type || 'website';
    document.getElementById('set_seo_og_locale').value = seo.og_locale || 'ru_RU';
    document.getElementById('set_seo_twitter_card').value = seo.twitter_card || 'summary_large_image';
    document.getElementById('set_seo_theme_color').value = seo.theme_color || '#f7f8fb';
    document.getElementById('set_seo_google_verification').value = seo.google_verification || '';
    document.getElementById('set_seo_yandex_verification').value = seo.yandex_verification || '';
    document.getElementById('set_seo_bing_verification').value = seo.bing_verification || '';
    document.getElementById('set_seo_google_analytics_id').value = seo.google_analytics_id || '';
    document.getElementById('set_seo_yandex_metrika_id').value = seo.yandex_metrika_id || '';

    document.getElementById('set_home_hero_eyebrow').value = home.hero_eyebrow || 'стеллажи из нержавеющей стали';
    document.getElementById('set_home_hero_title').value = home.hero_title || 'Стеллажи для кухни,\\nобщепита и склада';
    document.getElementById('set_home_hero_lead').value = home.hero_lead || 'Типовые размеры и изготовление под задачу. Подбор стали AISI 304/430, перфорированные или сплошные полки, аккуратная сборка.';
    document.getElementById('set_home_hero_cta1_text').value = home.hero_cta1_text || 'Каталог';
    document.getElementById('set_home_hero_cta1_link').value = home.hero_cta1_link || '#catalog';
    document.getElementById('set_home_hero_cta2_text').value = home.hero_cta2_text || 'Получить расчёт';
    document.getElementById('set_home_hero_cta2_link').value = home.hero_cta2_link || '#contacts';

    document.getElementById('set_home_benefits_title').value = home.benefits_title || 'Почему STILVA';
    document.getElementById('set_home_benefits_lead').value = home.benefits_lead || 'Коммерческий класс для рабочих зон: кухня, общепит, склад.';
    document.getElementById('set_home_benefits_items').value = home.benefits_items || 'Сталь под задачу|Подберём AISI 304/430 под условия эксплуатации.\\nКонфигурации|Перфорированные или сплошные полки, нужное количество ярусов.\\nТиповые и под заказ|Быстрое решение из каталога или изготовление под нишу.';

    document.getElementById('set_home_specs_title').value = home.specs_title || 'Характеристики и размеры';
    document.getElementById('set_home_specs_lead').value = home.specs_lead || 'Типовой ряд и индивидуальные решения.';
    document.getElementById('set_home_specs_items').value = home.specs_items || 'Полки|Перфорированные или сплошные — под задачу хранения.\\nРазмеры|Типовой ряд: ширина 800–1200, глубина 300–600, высота 1800 мм.\\nСборка|Разборные или сварные исполнения.\\nРегулировка|Возможна настройка уровня полок по высоте.\\nОпоры|Регулируемые опоры для ровной установки.\\nСроки|Согласуем до старта производства.';

    document.getElementById('set_home_cases_title').value = home.cases_title || 'Сферы применения';
    document.getElementById('set_home_cases_lead').value = home.cases_lead || 'Решения под рабочие зоны и санитарные требования.';
    document.getElementById('set_home_cases_items').value = home.cases_items || 'Общепит и рестораны|Для хранения инвентаря, посуды и продуктов, легко моется.\\nКухни и производства|Нержавейка выдерживает влажность и санитарную обработку.\\nСклады и логистика|Удобная компоновка рядов и доступ к товару.\\nТорговые залы|Аккуратный внешний вид и устойчивость.\\nЛаборатории|Чистая обработка и минимум стыков.';

    document.getElementById('set_home_types_title').value = home.types_title || 'Типы стеллажей';
    document.getElementById('set_home_types_lead').value = home.types_lead || 'Подбираем конструкцию под задачу и условия эксплуатации.';
    document.getElementById('set_home_types_items').value = home.types_items || 'Кухонные стеллажи|Для рабочих зон и хранения на кухне.\\nСкладские стеллажи|Для влажных и пищевых складов.\\nПроизводственные|Для цехов и линий.\\nПерфорированные полки|Вентиляция и стек.\\nСплошные полки|Для мелких предметов.\\nПод заказ|Нестандартные размеры и конфигурации.';

    document.getElementById('set_home_faq_title').value = home.faq_title || 'FAQ';
    document.getElementById('set_home_faq_lead').value = home.faq_lead || 'Коротко на частые вопросы.';
    document.getElementById('set_home_faq_items').value = home.faq_items || 'Нестандартные размеры?|Да, подгоняем под нишу и планировку цеха.\\nКакая сталь используется?|AISI 304/430 — подберём под условия эксплуатации.\\nКакие полки доступны?|Перфорированные или сплошные, количество ярусов согласуем.\\nДоставка?|Доставка по России, условия и сроки фиксируем.';

    document.getElementById('set_home_contacts_title').value = home.contacts_title || 'Свяжитесь с нами';
    document.getElementById('set_home_contacts_lead').value = home.contacts_lead || 'Подробно осудим все детали и возможные нестандартные решения.';
    document.getElementById('set_home_contacts_note').value = home.contacts_note || '';
    document.getElementById('set_home_tg_handle').value = home.tg_handle || 'stilva_support';
    document.getElementById('set_home_wa_phone').value = home.wa_phone || '79000000000';

    document.getElementById('set_home_seo_title').value = home.seo_title || 'Стеллажи из нержавейки для кухни, общепита и склада';
    document.getElementById('set_home_seo_text').value = home.seo_text || 'STILVA производит и поставляет стеллажи из нержавеющей стали для кухни, общепита, пищевых производств и складов. Типовой ряд размеров закрывает большинство задач: ширина 800–1200 мм, глубина 300–600 мм, высота 1800 мм.\\n\\nПодберём сталь под условия эксплуатации (AISI 304/430), тип полок (перфорированные или сплошные), количество ярусов и исполнение (разборное или сварное).\\n\\nЕсли нужно нестандартное решение — изготовим под задачу, согласуем сроки и доставку.';
  }

  async function saveSettings(){
    const type = document.getElementById('set_seller_type').value || 'org';
    const name = (document.getElementById('set_seller_name').value || '').trim();
    const payload = {
      seller: {
        type,
        name,
        fio: name,
        inn: (document.getElementById('set_seller_inn').value || '').trim(),
        kpp: (document.getElementById('set_seller_kpp').value || '').trim(),
        address: (document.getElementById('set_seller_address').value || '').trim(),
        phone: (document.getElementById('set_seller_phone').value || '').trim(),
        email: (document.getElementById('set_seller_email').value || '').trim(),
        bank_name: (document.getElementById('set_bank_name').value || '').trim(),
        bank_bik: (document.getElementById('set_bank_bik').value || '').trim(),
        bank_corr: (document.getElementById('set_bank_corr').value || '').trim(),
        bank_account: (document.getElementById('set_bank_account').value || '').trim(),
        vat_rate: document.getElementById('set_vat_rate').value || 'без НДС',
        vat_included: document.getElementById('set_vat_included').checked ? 1 : 0,
        unit_code: (document.getElementById('set_unit_code').value || '796').trim(),
        unit_name: (document.getElementById('set_unit_name').value || 'шт').trim(),
        operation_content: (document.getElementById('set_operation_content').value || '').trim(),
        basis_name: (document.getElementById('set_basis_name').value || '').trim(),
        edi_operator: (document.getElementById('set_edi_operator').value || '000').trim(),
        edi_sender_uid: (document.getElementById('set_edi_sender_uid').value || '').trim()
      },
      notifications: {
        telegram_enabled: document.getElementById('set_notify_tg_enabled').checked ? 1 : 0,
        telegram_bot_token: (document.getElementById('set_notify_tg_bot_token').value || '').trim(),
        telegram_chat_id: (document.getElementById('set_notify_tg_chat_id').value || '').trim(),
        email_enabled: document.getElementById('set_notify_email_enabled').checked ? 1 : 0,
        email_to: (document.getElementById('set_notify_email_to').value || '').trim(),
        email_subject: (document.getElementById('set_notify_email_subject').value || '').trim()
      },
      seo: {
        site_name: (document.getElementById('set_seo_site_name').value || '').trim(),
        title: (document.getElementById('set_seo_title').value || '').trim(),
        description: (document.getElementById('set_seo_description').value || '').trim(),
        keywords: (document.getElementById('set_seo_keywords').value || '').trim(),
        canonical: (document.getElementById('set_seo_canonical').value || '').trim(),
        robots: (document.getElementById('set_seo_robots').value || '').trim(),
        og_title: (document.getElementById('set_seo_og_title').value || '').trim(),
        og_description: (document.getElementById('set_seo_og_description').value || '').trim(),
        og_image: (document.getElementById('set_seo_og_image').value || '').trim(),
        og_type: (document.getElementById('set_seo_og_type').value || '').trim(),
        og_locale: (document.getElementById('set_seo_og_locale').value || '').trim(),
        twitter_card: (document.getElementById('set_seo_twitter_card').value || '').trim(),
        theme_color: (document.getElementById('set_seo_theme_color').value || '').trim(),
        google_verification: (document.getElementById('set_seo_google_verification').value || '').trim(),
        yandex_verification: (document.getElementById('set_seo_yandex_verification').value || '').trim(),
        bing_verification: (document.getElementById('set_seo_bing_verification').value || '').trim(),
        google_analytics_id: (document.getElementById('set_seo_google_analytics_id').value || '').trim(),
        yandex_metrika_id: (document.getElementById('set_seo_yandex_metrika_id').value || '').trim()
      },
      home: {
        hero_eyebrow: (document.getElementById('set_home_hero_eyebrow').value || '').trim(),
        hero_title: (document.getElementById('set_home_hero_title').value || '').trim(),
        hero_lead: (document.getElementById('set_home_hero_lead').value || '').trim(),
        hero_cta1_text: (document.getElementById('set_home_hero_cta1_text').value || '').trim(),
        hero_cta1_link: (document.getElementById('set_home_hero_cta1_link').value || '').trim(),
        hero_cta2_text: (document.getElementById('set_home_hero_cta2_text').value || '').trim(),
        hero_cta2_link: (document.getElementById('set_home_hero_cta2_link').value || '').trim(),
        benefits_title: (document.getElementById('set_home_benefits_title').value || '').trim(),
        benefits_lead: (document.getElementById('set_home_benefits_lead').value || '').trim(),
        benefits_items: (document.getElementById('set_home_benefits_items').value || '').trim(),
        specs_title: (document.getElementById('set_home_specs_title').value || '').trim(),
        specs_lead: (document.getElementById('set_home_specs_lead').value || '').trim(),
        specs_items: (document.getElementById('set_home_specs_items').value || '').trim(),
        cases_title: (document.getElementById('set_home_cases_title').value || '').trim(),
        cases_lead: (document.getElementById('set_home_cases_lead').value || '').trim(),
        cases_items: (document.getElementById('set_home_cases_items').value || '').trim(),
        types_title: (document.getElementById('set_home_types_title').value || '').trim(),
        types_lead: (document.getElementById('set_home_types_lead').value || '').trim(),
        types_items: (document.getElementById('set_home_types_items').value || '').trim(),
        faq_title: (document.getElementById('set_home_faq_title').value || '').trim(),
        faq_lead: (document.getElementById('set_home_faq_lead').value || '').trim(),
        faq_items: (document.getElementById('set_home_faq_items').value || '').trim(),
        contacts_title: (document.getElementById('set_home_contacts_title').value || '').trim(),
        contacts_lead: (document.getElementById('set_home_contacts_lead').value || '').trim(),
        contacts_note: (document.getElementById('set_home_contacts_note').value || '').trim(),
        tg_handle: (document.getElementById('set_home_tg_handle').value || '').trim(),
        wa_phone: (document.getElementById('set_home_wa_phone').value || '').trim(),
        seo_title: (document.getElementById('set_home_seo_title').value || '').trim(),
        seo_text: (document.getElementById('set_home_seo_text').value || '').trim()
      }
    };
    const res = await api('/api/settings', { method:'POST', body: JSON.stringify(payload) });
    if (!res.ok){
      alert('Не удалось сохранить настройки');
      return;
    }
    settingsCache = payload;
    settingsClose();
  }

  async function testNotifications(){
    if (!notifyTestStatus) return;
    notifyTestStatus.textContent = 'Отправка...';
    const notificationsPayload = {
      notifications: {
        telegram_enabled: document.getElementById('set_notify_tg_enabled').checked ? 1 : 0,
        telegram_bot_token: (document.getElementById('set_notify_tg_bot_token').value || '').trim(),
        telegram_chat_id: (document.getElementById('set_notify_tg_chat_id').value || '').trim(),
        email_enabled: document.getElementById('set_notify_email_enabled').checked ? 1 : 0,
        email_to: (document.getElementById('set_notify_email_to').value || '').trim(),
        email_subject: (document.getElementById('set_notify_email_subject').value || '').trim()
      }
    };
    const saveRes = await api('/api/settings', { method:'PATCH', body: JSON.stringify(notificationsPayload) });
    if (!saveRes.ok){
      notifyTestStatus.textContent = 'Не удалось сохранить настройки';
      return;
    }
    const res = await api('/api/notifications/test', { method:'POST', body:'{}' });
    if (res.ok){
      notifyTestStatus.textContent = 'Тест отправлен';
      return;
    }
    const err = await res.json().catch(()=>({}));
    if (err && err.error === 'notifications_not_configured'){
      notifyTestStatus.textContent = 'Заполните token/chat_id и включите уведомления';
      return;
    }
    notifyTestStatus.textContent = 'Ошибка отправки';
  }

  function settingsOpen(){
    settingsBackdrop.style.display='flex';
    loadSettings();
  }
  function settingsClose(){
    settingsBackdrop.style.display='none';
  }
  openSettingsBtn?.addEventListener('click', settingsOpen);
  settingsCloseBtn?.addEventListener('click', settingsClose);
  settingsCancelBtn?.addEventListener('click', settingsClose);
  settingsBackdrop?.addEventListener('click', (e)=>{ if (e.target === settingsBackdrop) settingsClose(); });
  settingsSaveBtn?.addEventListener('click', (e)=>{ e.preventDefault(); saveSettings(); });
  settingsGenUidBtn?.addEventListener('click', (e)=>{ e.preventDefault(); document.getElementById('set_edi_sender_uid').value = uuidv4(); });
  notifyTestBtn?.addEventListener('click', (e)=>{ e.preventDefault(); testNotifications(); });

  /* === УПД === */
  const updBackdrop = document.getElementById('upd-modal-backdrop');
  const updCloseBtn = document.getElementById('upd-modal-close');
  const updCloseBtn2 = document.getElementById('upd-close');
  const updLoadBtn = document.getElementById('upd-load-order');
  const updCreateBtn = document.getElementById('upd-create');
  const updDownloadBtn = document.getElementById('upd-download-xml');
  const updPrintBtn = document.getElementById('upd-print');
  const updConfirmBox = document.getElementById('upd-confirm-box');
  const updConfirmYes = document.getElementById('upd-confirm-yes');
  const updConfirmNo = document.getElementById('upd-confirm-no');

  let updCurrentOrder = null;
  let updDocId = null;

  async function updFetchByOrder(orderId){
    const res = await api(`/api/upd?order_id=${orderId}`);
    if (!res.ok) return null;
    return await res.json();
  }

  async function updCreateForOrder(orderId){
    const res = await api('/api/upd', { method:'POST', body: JSON.stringify({ order_id: orderId }) });
    if (!res.ok){
      const err = await res.json().catch(()=>({}));
      if (err && err.error === 'validation'){
        const map = {
          seller_name:'Продавец: наименование', seller_inn:'Продавец: ИНН', seller_fio:'Продавец: ФИО', seller_address:'Продавец: адрес',
          buyer_name:'Покупатель: наименование', buyer_inn:'Покупатель: ИНН', buyer_address:'Покупатель: адрес', buyer_other:'Покупатель: иные сведения (для физлица)',
          consignee_address:'Грузополучатель: адрес'
        };
        const fields = (err.fields || []).map(f=>map[f] || f).join(', ');
        alert('Заполните обязательные поля: ' + fields);
      } else if (err && err.error === 'no_signers'){
        alert('Добавьте подписантов для УПД в карточке заказа.');
      } else {
        alert('Не удалось сформировать УПД');
      }
      return null;
    }
    return await res.json();
  }

  function updOpen(){
    updBackdrop.style.display='flex';
    updCurrentOrder = null; updDocId = null;
    document.getElementById('upd-order-id').value = '';
    document.getElementById('upd-order-summary').textContent = '—';
    updDownloadBtn.disabled = true;
    updPrintBtn.disabled = true;
    updConfirmBox.style.display = 'none';
  }
  function updClose(){
    updBackdrop.style.display='none';
  }
  function updSummary(order){
    if (!order){ document.getElementById('upd-order-summary').textContent = '—'; return; }
    const name = order.customer_name || 'Без имени';
    const phone = order.phone || '—';
    const total = order.total || 0;
    document.getElementById('upd-order-summary').textContent = `Заказ #${order.id} • ${name} • ${phone} • ${total} ₽`;
  }
  async function updLoadOrder(){
    const id = parseInt(document.getElementById('upd-order-id').value || '0', 10);
    if (!id){ alert('Введите номер заказа'); return; }
    const res = await api('/api/orders/'+id);
    if (!res.ok){ alert('Заказ не найден'); return; }
    updCurrentOrder = await res.json();
    updSummary(updCurrentOrder);
    const meta = await updFetchByOrder(id);
    if (meta && meta.id){
      updDocId = meta.id;
      updDownloadBtn.disabled = false;
      updPrintBtn.disabled = false;
      document.getElementById('upd-order-summary').textContent = `УПД создан: ${meta.doc_number || meta.id}`;
    } else {
      updDocId = null;
      updDownloadBtn.disabled = true;
      updPrintBtn.disabled = true;
    }
  }
  function updAskConfirm(){
    if (!updCurrentOrder){ alert('Сначала загрузите заказ'); return; }
    updConfirmBox.style.display = 'block';
  }
  async function updCreateConfirmed(){
    if (!updCurrentOrder) return;
    const doc = await updCreateForOrder(updCurrentOrder.id);
    if (!doc) return;
    updDocId = doc.id;
    updDownloadBtn.disabled = false;
    updPrintBtn.disabled = false;
    updConfirmBox.style.display = 'none';
    document.getElementById('upd-order-summary').textContent = `УПД создан: ${doc.doc_number}`;
  }
  function updDownload(){
    if (!updDocId) return;
    window.location.href = `/api/upd/${updDocId}/xml`;
  }
  function updPrint(){
    if (!updDocId) return;
    window.open(`/api/upd/${updDocId}/print`, '_blank');
  }

  updBackdrop?.addEventListener('click', (e)=>{ if (e.target === updBackdrop) updClose(); });
  updCloseBtn?.addEventListener('click', updClose);
  updCloseBtn2?.addEventListener('click', updClose);
  updLoadBtn?.addEventListener('click', (e)=>{ e.preventDefault(); updLoadOrder(); });
  updCreateBtn?.addEventListener('click', (e)=>{ e.preventDefault(); updAskConfirm(); });
  updConfirmYes?.addEventListener('click', (e)=>{ e.preventDefault(); updCreateConfirmed(); });
  updConfirmNo?.addEventListener('click', (e)=>{ e.preventDefault(); updConfirmBox.style.display = 'none'; });
  updDownloadBtn?.addEventListener('click', (e)=>{ e.preventDefault(); updDownload(); });
  updPrintBtn?.addEventListener('click', (e)=>{ e.preventDefault(); updPrint(); });

  function skeletonRows(cols, count=6){
    const tr=[]; for(let i=0;i<count;i++){ const cells=Array.from({length:cols},()=>'<td><span class="muted">...</span></td>').join(''); tr.push('<tr>'+cells+'</tr>');} return tr.join('');
  }

  (function(){
    const SEP = '\t';
    function escapeCell(v){ const s = String(v).replace(/\r?\n|\r/g, ' ').replace(/"/g, '""').trim(); return '"' + s + '"'; }
    function tableToCSVString(table){
      const ths = Array.from(table.tHead?.rows?.[0]?.cells || []);
      const lastH = Math.max(0, ths.length - 1);
      const header = ths.slice(0, lastH).map(th => escapeCell(th.textContent)).join(SEP);
      const body = Array.from(table.tBodies?.[0]?.rows || []).map(tr => {
        const cells = Array.from(tr.cells);
        const last = Math.max(0, cells.length - 1);
        const vals = cells.slice(0, last).map(td => {
          const sel = td.querySelector && td.querySelector('select');
          return escapeCell(sel ? sel.value : td.textContent);
        });
        return vals.join(SEP);
      });
      return [header, ...body].join('\r\n');
    }
    function csvUTF16LEBlob(csvStr){ const buf = new Uint16Array(csvStr.length + 1); buf[0] = 0xFEFF; for (let i = 0; i < csvStr.length; i++) buf[i+1] = csvStr.charCodeAt(i); return new Blob([buf], { type: 'application/vnd.ms-excel;charset=utf-16le' }); }
    function downloadBlob(blob, filename){ const url = URL.createObjectURL(blob); const a = document.createElement('a'); a.href = url; a.download = filename; document.body.appendChild(a); a.click(); setTimeout(()=>{ URL.revokeObjectURL(url); a.remove(); }, 0); }
    function exportOrders(tableId, prefix){ const table = document.getElementById(tableId); if (!table) return; const csv = tableToCSVString(table); const blob = csvUTF16LEBlob(csv); const stamp = new Date().toISOString().slice(0,19).replace(/[:T]/g,'-'); downloadBlob(blob, `${prefix}_${stamp}.xls`); }
    const btnL = document.getElementById('export-orders-left'); if (btnL && !btnL.dataset.wired){ btnL.dataset.wired='1'; btnL.addEventListener('click', ()=> exportOrders('orders-left-table','orders_left')); }
    const btnR = document.getElementById('export-orders-right'); if (btnR && !btnR.dataset.wired){ btnR.dataset.wired='1'; btnR.addEventListener('click', ()=> exportOrders('orders-right-table','orders_right')); }
  })();

  /* === Intercept status change for "Отменен" === */
  (function(){
    function showRollbackModal(selectEl, orderId, newStatus, onConfirm){
      const backdrop = document.getElementById('rollback-modal-backdrop');
      const msg = document.getElementById('rollback-modal-text');
      const btnYes = document.getElementById('rollback-modal-yes');
      const btnNo = document.getElementById('rollback-modal-no');
      const btnX = document.getElementById('rollback-modal-close');

      function cleanup(){ backdrop.style.display='none'; btnYes.onclick = btnNo.onclick = btnX.onclick = backdrop.onclick = null; }
      function revert(){
        cleanup();
        const prev = selectEl.dataset.prev || 'Выполнен';
        selectEl.value = prev;
        applyRowStatusClass(selectEl.closest('tr'), prev);
      }

      msg.textContent = `Вы меняете статус с «Выполнен» на «${newStatus}». Будет выполнен откат: проводка ДДС аннулируется, складские остатки будут возвращены (и при необходимости перерезервированы). Продолжить?`;
      backdrop.style.display='flex';
      btnNo.onclick = revert;
      btnX.onclick = revert;
      backdrop.onclick = (ev)=>{ if(ev.target===backdrop) revert(); };
      btnYes.onclick = async ()=>{
        cleanup();
        await onConfirm();
      };
    }

    function showCancelModal(selectEl, orderId){
      const backdrop = document.getElementById('cancel-modal-backdrop');
      const txt = document.getElementById('cancel-reason');
      const btnSave = document.getElementById('cancel-modal-save');
      const btnCancel = document.getElementById('cancel-modal-cancel');
      const btnX = document.getElementById('cancel-modal-close');

      function cleanup(){ backdrop.style.display='none'; btnSave.onclick = btnCancel.onclick = btnX.onclick = backdrop.onclick = null; }
      function revert(){ cleanup(); const prev = selectEl.dataset.prev || ''; selectEl.value = prev || 'Новый'; }

      txt.value='';
      backdrop.style.display='flex';
      btnCancel.onclick = revert;
      btnX.onclick = revert;
      backdrop.onclick = (ev)=>{ if(ev.target===backdrop) revert(); };

      btnSave.onclick = async ()=>{
        const reason = txt.value.trim();
        if(!reason){ txt.focus(); txt.style.boxShadow='0 0 0 3px rgba(220,38,38,.25)'; return; }
        let prodAction = null;
        try{
          const jobsRes = await api('/api/production/order/' + orderId);
          const jobs = jobsRes.ok ? await jobsRes.json() : [];
          const activeJobs = (jobs || []).filter(j => !['cancelled','closed'].includes(String(j.state || '')));
          if (activeJobs.length){
            cleanup();
            prodAction = await productionCancelChoice(orderId, activeJobs);
            if (!prodAction){
              const prev = selectEl.dataset.prev || 'Новый';
              selectEl.value = prev;
              applyRowStatusClass(selectEl.closest('tr'), prev);
              return;
            }
          } else {
            cleanup();
          }
        } catch (_){
          cleanup();
        }
        await withOverlay(selectEl, async ()=>{
          await api('/api/orders/'+orderId+'/status',{method:'PATCH', body: JSON.stringify({status:'Отменен'})});
          const idx = ordersCache.findIndex(x=>String(x.id)===String(orderId));
          const prevNote = idx>-1 ? (ordersCache[idx].note||'').trim() : '';
          const newNote = addCancelStampToNote(prevNote, reason);
          await api('/api/orders/' + orderId, { method: 'PATCH', body: JSON.stringify({ cancel_reason: reason, note: newNote }) });
          if (prodAction){
            await api('/api/production/order/' + orderId + '/cancel-action', {
              method:'POST',
              body: JSON.stringify({ action: prodAction })
            });
          }
          if(idx>-1){ ordersCache[idx].status='Отменен'; ordersCache[idx].cancel_reason = reason; ordersCache[idx].note = newNote; }
          setLocalCancel(String(orderId), reason, newNote);
          selectEl.dataset.prev = 'Отменен'; applyRowStatusClass(selectEl.closest('tr'), 'Отменен');
          ddsRefreshOpen();
          stockRefreshOpen();
          productionRefreshOpen();
        });
      };
    }

    document.addEventListener('change', function(e){
      const sel = e.target.closest && e.target.closest('.status-select');
      if(!sel) return;
      if(sel.dataset.skipCancelCheck === '1'){ sel.dataset.skipCancelCheck=''; return; }
      if(!sel.dataset.prev) sel.dataset.prev = sel.value;
      const orderId = sel.dataset.id;
      const val = sel.value;
      const prev = sel.dataset.prev || '';

      if(prev === 'Выполнен' && val !== 'Выполнен'){
        e.stopImmediatePropagation(); e.stopPropagation(); e.preventDefault();
        showRollbackModal(sel, orderId, val, async ()=>{
          if (val === 'Отменен'){
            showCancelModal(sel, orderId);
            return;
          }
          await withOverlay(sel, async ()=>{
            const resp = await api('/api/orders/'+orderId+'/status',{method:'PATCH', body: JSON.stringify({ status: val })});
            if (!resp.ok){
              sel.value = prev;
              applyRowStatusClass(sel.closest('tr'), prev);
              return;
            }
            const idx = ordersCache.findIndex(x=>String(x.id)===String(orderId));
            if(idx>-1) ordersCache[idx].status = val;
            sel.dataset.prev = val;
            applyRowStatusClass(sel.closest('tr'), val);
            ddsRefreshOpen();
            stockRefreshOpen();
          });
        });
        return;
      }

      if(val === 'Отменен'){
        e.stopImmediatePropagation(); e.stopPropagation(); e.preventDefault();
        showCancelModal(sel, orderId);
        return;
      }

      if(prev === 'Отменен' && val !== prev){
        e.stopImmediatePropagation(); e.stopPropagation(); e.preventDefault();
        (async ()=>{
          await withOverlay(sel, async ()=>{
            const idx = ordersCache.findIndex(x=>String(x.id)===String(orderId));
            const prevNote = idx>-1 ? (ordersCache[idx].note||'').trim() : '';
            const cleaned = removeCancelStampFromNote(prevNote);
            if(cleaned !== prevNote){
              await api('/api/orders/'+orderId, {method:'PATCH', body: JSON.stringify({ note: cleaned, cancel_reason: '' })});
              if(idx>-1){ ordersCache[idx].note = cleaned; ordersCache[idx].cancel_reason = ''; }
            }
            await api('/api/orders/'+orderId+'/status',{method:'PATCH', body: JSON.stringify({ status: val })});
            if(idx>-1) ordersCache[idx].status = val;
            clearLocalCancel(String(orderId));
            sel.dataset.prev = val; applyRowStatusClass(sel.closest('tr'), val);
            ddsRefreshOpen();
          });
        })();
        return;
      }

      sel.dataset.prev = val;
    }, true);

  })();

</script>

<div class="modal-backdrop" id="rollback-modal-backdrop" style="display:none">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="rollback-modal-title" style="width:min(720px,96vw)">
    <div class="modal-head">
      <h3 id="rollback-modal-title" class="card-title" style="margin:0">Подтверждение отката</h3>
      <button class="close-x" id="rollback-modal-close">✕</button>
    </div>
    <div style="padding:12px;display:grid;gap:12px">
      <div id="rollback-modal-text" class="muted"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="ghost" id="rollback-modal-no">Нет</button>
        <button id="rollback-modal-yes">Да, откатить</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="cancel-modal-backdrop" style="display:none">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="cancel-modal-title">
    <div class="modal-head">
      <h3 id="cancel-modal-title" class="card-title" style="margin:0">Причина отмены</h3>
      <button class="close-x" id="cancel-modal-close">✕</button>
    </div>
    <div style="padding:12px;display:grid;gap:10px">
      <textarea id="cancel-reason" rows="4" placeholder="Укажите причину отмены..." required></textarea>
      <div style="display:flex;gap:8px;justify-content:flex-end">
        <button class="ghost" id="cancel-modal-cancel">Отмена</button>
        <button id="cancel-modal-save">Сохранить</button>
      </div>
    </div>
  </div>
</div>

<div class="modal-backdrop" id="cancel-prod-modal-backdrop" style="display:none">
  <div class="modal" role="dialog" aria-modal="true" aria-labelledby="cancel-prod-modal-title" style="width:min(720px,96vw)">
    <div class="modal-head">
      <h3 id="cancel-prod-modal-title" class="card-title" style="margin:0">Производство по отмененному заказу</h3>
      <button class="close-x" id="cancel-prod-modal-close">✕</button>
    </div>
    <div style="padding:12px;display:grid;gap:12px">
      <div id="cancel-prod-modal-text" class="muted"></div>
      <div style="display:flex;gap:8px;justify-content:flex-end;flex-wrap:wrap">
        <button class="ghost" id="cancel-prod-modal-abort">Отмена действия</button>
        <button class="ghost" id="cancel-prod-modal-detach">Оставить в производстве</button>
        <button id="cancel-prod-modal-cancel">Отменить производство</button>
      </div>
    </div>
  </div>
</div>
<!-- === Добавление товара: кнопка + модалка === -->
<style>
  .adm-fab{position:fixed; right:20px; bottom:20px; z-index:9999;
    display:inline-flex; align-items:center; gap:8px;
    padding:10px 14px; border:0; border-radius:999px; cursor:pointer;
    background:#10b981; color:#fff; font-weight:800; box-shadow:0 10px 24px rgba(0,0,0,.18); opacity:.95}
  .adm-fab:hover{opacity:1}
  .adm-modal-back{position:fixed; inset:0; background:rgba(2,6,23,.48); backdrop-filter: blur(2px);
    display:none; align-items:center; justify-content:center; z-index:10000}
  .adm-modal{width:min(920px,96vw); max-height:86vh; overflow:auto; background:#fff; color:#111827;
    border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 20px 50px rgba(0,0,0,.25); padding:18px}
  .adm-modal h3{margin:0 0 12px}
  .adm-grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .adm-col{display:flex; flex-direction:column; gap:10px}
  .adm-field label{font-size:12px; color:#475569; display:block; margin-bottom:4px}
  .adm-field input[type="text"], .adm-field input[type="number"], .adm-field textarea{
    width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:10px; outline:none}
  .adm-actions{display:flex; gap:10px; justify-content:flex-end; margin-top:12px}
  .adm-btn{padding:10px 14px; border-radius:10px; border:0; cursor:pointer; font-weight:700}
  .adm-btn--ghost{background:#eef2ff; color:#111}
  .adm-btn--accent{background:#111827; color:#fff}
  @media (max-width:800px){ .adm-grid{grid-template-columns:1fr} }
</style>

<div class="adm-modal-back" id="admAddBack">
  <div class="adm-modal">
    <h3>Новый товар</h3>
    <div class="adm-grid">
      <div class="adm-col">
        <div class="adm-field">
          <label>Название*</label>
          <input type="text" id="p_name" placeholder="Например: STILVA S-150">
        </div>
        <div class="adm-field">
          <label>Цена, ₽*</label>
          <input type="number" id="p_price" min="0" step="0.01" placeholder="0.00">
        </div>
        <div class="adm-field">
          <label>Опубликован</label>
          <input type="checkbox" id="p_published" checked>
        </div>
        <div class="adm-field">
          <label>Ссылка на изображение</label>
          <input type="text" id="p_image_url" placeholder="https://…/img.jpg">
        </div>
        <div class="adm-field">
          <label>Описание</label>
          <textarea id="p_description" rows="4" placeholder="Короткое описание"></textarea>
        </div>
        <div class="adm-field">
          <label>SEO Title</label>
          <input type="text" id="p_seo_title" placeholder="Title для карточки товара">
        </div>
        <div class="adm-field">
          <label>SEO Slug</label>
          <input type="text" id="p_seo_slug" placeholder="800x300x1800">
        </div>
        <div class="adm-field">
          <label>SEO Description</label>
          <textarea id="p_seo_description" rows="3" placeholder="Meta description карточки товара"></textarea>
        </div>
        <div class="adm-field">
          <label>SEO Keywords</label>
          <textarea id="p_seo_keywords" rows="2" placeholder="ключ1, ключ2, ключ3"></textarea>
        </div>
        <div class="adm-field">
          <label>SEO H1</label>
          <input type="text" id="p_seo_h1" placeholder="H1 для карточки товара">
        </div>
      </div>
      <div class="adm-col">
        <div class="adm-field">
          <label>Кол-во полок</label>
          <input type="number" id="p_shelves" min="0" step="1" value="0">
        </div>
        <div class="adm-field">
  <label>Материал</label>
  <select id="p_material">
    <option>AISI 430</option>
    <option>AISI 304</option>
    <option>AISI 304/430</option>
  </select>
</div>
<div class="adm-field">
  <label>Конструкция</label>
  <select id="p_construction">
    <option>Сборно-разборная</option>
    <option>Сварная</option>
  </select>
</div>
<div class="adm-field">
  <label>Перфорация</label>
  <select id="p_perforation">
    <option>Да</option>
    <option>Нет</option>
  </select>
</div>
        <div class="adm-field">
          <label>Толщина полки</label>
          <input type="text" id="p_shelf_thickness" placeholder="0.8 мм">
        </div>
        <div class="adm-field">
          <label>В наличии</label>
          <input type="number" id="p_stock_qty" min="0" step="1" value="0">
        </div>
        <div class="adm-field">
          <label>Срок поставки</label>
          <input type="number" id="p_lead_time_days" min="0" step="1" value="0">
        </div>
        <div class="adm-field">
          <label>Тип поставки</label>
          <select id="p_supply_mode">
            <option value="stock">Склад</option>
            <option value="mto">Под заказ</option>
            <option value="mixed">Смешанный</option>
          </select>
        </div>
        <div class="adm-field">
          <label>SEO Robots</label>
          <input type="text" id="p_seo_robots" placeholder="index,follow">
        </div>
        <div class="adm-field">
          <label>SEO Canonical</label>
          <input type="text" id="p_seo_canonical" placeholder="https://stilva.ru/catalog/slug">
        </div>
        <div class="adm-field">
          <label>OG Title</label>
          <input type="text" id="p_seo_og_title" placeholder="OG title карточки товара">
        </div>
        <div class="adm-field">
          <label>OG Description</label>
          <textarea id="p_seo_og_description" rows="2" placeholder="OG description карточки товара"></textarea>
        </div>
      </div>
    </div>
    <div class="adm-actions">
      <button class="adm-btn adm-btn--ghost" id="admAddCancel">Отмена</button>
      <button class="adm-btn adm-btn--accent" id="admAddSave">Сохранить</button>
    </div>
  </div>
</div>

<script>
(function(){
  const $ = sel => document.querySelector(sel);
  const back = $('#admAddBack');
  const open = () => back.style.display = 'flex';
  const close = () => back.style.display = 'none';

  ['#add-product-left', '#add-product-right'].forEach(sel=>{
  const b = document.querySelector(sel);
  if (b) b.addEventListener('click', open);
});
$('#admAddCancel').addEventListener('click', close);


  function num(v, def=0){
    const n = parseFloat(v);
    return Number.isFinite(n) ? n : def;
  }
  function int(v, def=0){
    const n = parseInt(v, 10);
    return Number.isFinite(n) ? n : def;
  }

  $('#admAddSave').addEventListener('click', async function(){
    const payload = {
      name: ($('#p_name').value || '').trim(),
      price: num($('#p_price').value, 0),
      published: $('#p_published').checked ? 1 : 0,
      image_url: ($('#p_image_url').value || '').trim(),
      shelves: int($('#p_shelves').value, 0),
      material: ($('#p_material').value || '').trim(),
      construction: ($('#p_construction').value || '').trim(),
      perforation: ($('#p_perforation').value || '').trim(),
      shelf_thickness: ($('#p_shelf_thickness').value || '').trim(),
      description: ($('#p_description').value || '').trim(),
      seo_title: ($('#p_seo_title').value || '').trim(),
      seo_slug: ($('#p_seo_slug').value || '').trim(),
      seo_description: ($('#p_seo_description').value || '').trim(),
      seo_keywords: ($('#p_seo_keywords').value || '').trim(),
      seo_h1: ($('#p_seo_h1').value || '').trim(),
      stock_qty: int($('#p_stock_qty').value, 0),
      lead_time_days: int($('#p_lead_time_days').value, 0),
      supply_mode: ($('#p_supply_mode').value || 'stock'),
      seo_robots: ($('#p_seo_robots').value || '').trim(),
      seo_canonical: ($('#p_seo_canonical').value || '').trim(),
      seo_og_title: ($('#p_seo_og_title').value || '').trim(),
      seo_og_description: ($('#p_seo_og_description').value || '').trim(),
    };

    if (!payload.name) { alert('Введите название'); return; }
    if (payload.price <= 0) { if(!confirm('Цена 0 — сохранить?')) return; }

    try{
      const res = await fetch('/api/products', {
        method:'POST',
        headers:{'Content-Type':'application/json'},
        body: JSON.stringify(payload)
      });
      if (!res.ok){
        const t = await res.text();
        throw new Error('Ошибка API: ' + t);
      }
      close();
      // проще и надёжнее, чем лезть в чужой рендер: просто обновим страницу
      location.reload();
    }catch(err){
      console.error(err);
      alert('Не удалось сохранить товар. См. консоль.');
    }
  });
})();
</script>
<!-- === /Добавление товара === -->


<!-- === Редактирование товара (отдельная модалка + превью) === -->
<style>
  .adm-modal-back{position:fixed; inset:0; background:rgba(2,6,23,.48); backdrop-filter: blur(2px);
    display:none; align-items:center; justify-content:center; z-index:10000}
  .adm-modal{width:min(920px,96vw); max-height:86vh; overflow:auto; background:#fff; color:#111827;
    border:1px solid #e5e7eb; border-radius:16px; box-shadow:0 20px 50px rgba(0,0,0,.25); padding:18px}
  .adm-modal h3{margin:0 0 12px}
  .adm-grid{display:grid; grid-template-columns:1fr 1fr; gap:12px}
  .adm-col{display:flex; flex-direction:column; gap:10px}
  .adm-field label{font-size:12px; color:#475569; display:block; margin-bottom:4px}
  .adm-field input[type="text"], .adm-field input[type="number"], .adm-field textarea, .adm-field select{
    width:100%; padding:10px 12px; border:1px solid #d1d5db; border-radius:10px; outline:none; background:#fff}
  .adm-row{display:flex; gap:14px; align-items:center}
  .adm-actions{display:flex; gap:10px; justify-content:flex-end; margin-top:12px}
  .adm-btn{padding:10px 14px; border-radius:10px; border:0; cursor:pointer; font-weight:700}
  .adm-btn--ghost{background:#eef2ff; color:#111}
  .adm-btn--accent{background:#111827; color:#fff}
  .adm-btn--danger{background:#ef4444; color:#fff}
  .imgbox{display:flex; gap:12px; align-items:center}
  .imgbox img{width:120px; height:90px; object-fit:cover; border-radius:10px; border:1px solid #e5e7eb; background:#f3f4f6}
  @media (max-width:800px){ .adm-grid{grid-template-columns:1fr} .imgbox{flex-direction:column; align-items:flex-start} }
</style>

<div class="adm-modal-back" id="admEditBack">
  <div class="adm-modal" role="dialog" aria-modal="true">
    <h3 id="e_title">Карточка товара</h3>
    <div class="adm-grid">
      <div class="adm-col">
        <div class="adm-field">
          <label>Название*</label>
          <input type="text" id="e_name" placeholder="Например: STILVA S-150">
        </div>
        <div class="adm-row">
          <div class="adm-field" style="flex:1">
            <label>Цена, ₽*</label>
            <input type="number" id="e_price" min="0" step="0.01" placeholder="0.00">
          </div>
          <div class="adm-field" style="width:160px">
            <label>Опубликован</label>
            <input type="checkbox" id="e_published">
          </div>
        </div>
        <div class="adm-field">
          <label>Ссылка на изображение</label>
          <div class="imgbox">
            <input type="text" id="e_image_url" placeholder="https://…/img.jpg" style="flex:1">
            <img id="e_preview" alt="prev">
          </div>
        </div>
        <div class="adm-field">
          <label>Описание</label>
          <textarea id="e_description" rows="4" placeholder="Короткое описание"></textarea>
        </div>
        <div class="adm-field">
          <label>SEO Title</label>
          <input type="text" id="e_seo_title" placeholder="Title для карточки товара">
        </div>
        <div class="adm-field">
          <label>SEO Slug</label>
          <input type="text" id="e_seo_slug" placeholder="800x300x1800">
        </div>
        <div class="adm-field">
          <label>SEO Description</label>
          <textarea id="e_seo_description" rows="3" placeholder="Meta description карточки товара"></textarea>
        </div>
        <div class="adm-field">
          <label>SEO Keywords</label>
          <textarea id="e_seo_keywords" rows="2" placeholder="ключ1, ключ2, ключ3"></textarea>
        </div>
        <div class="adm-field">
          <label>SEO H1</label>
          <input type="text" id="e_seo_h1" placeholder="H1 для карточки товара">
        </div>
      </div>

      <div class="adm-col">
        <div class="adm-row">
          <div class="adm-field" style="flex:1">
            <label>Кол-во полок</label>
            <input type="number" id="e_shelves" min="0" step="1" value="0">
          </div>
          <div class="adm-field" style="flex:1">
            <label>Срок поставки, дней</label>
            <input type="number" id="e_lead_time_days" min="0" step="1" value="0">
          </div>
        </div>
        <div class="adm-row">
          <div class="adm-field" style="flex:1">
            <label>Тип поставки</label>
            <select id="e_supply_mode">
              <option value="stock">Склад</option>
              <option value="mto">Под заказ</option>
              <option value="mixed">Смешанный</option>
            </select>
          </div>
        </div>
        <div class="adm-row">
          <div class="adm-field" style="flex:1">
            <label>Материал</label>
            <select id="e_material">
              <option>AISI 430</option>
              <option>AISI 304</option>
              <option>AISI 304/430</option>
            </select>
          </div>
          <div class="adm-field" style="flex:1">
            <label>Конструкция</label>
            <select id="e_construction">
              <option>Сборно-разборная</option>
              <option>Сварная</option>
            </select>
          </div>
          <div class="adm-field" style="flex:1">
            <label>Перфорация</label>
            <select id="e_perforation">
              <option>Да</option>
              <option>Нет</option>
            </select>
          </div>
        </div>
        <div class="adm-field">
          <label>Толщина полки</label>
          <input type="text" id="e_shelf_thickness" placeholder="0.8 мм">
        </div>
        <div class="adm-field">
          <label>SEO Robots</label>
          <input type="text" id="e_seo_robots" placeholder="index,follow">
        </div>
        <div class="adm-field">
          <label>SEO Canonical</label>
          <input type="text" id="e_seo_canonical" placeholder="https://stilva.ru/catalog/slug">
        </div>
        <div class="adm-field">
          <label>OG Title</label>
          <input type="text" id="e_seo_og_title" placeholder="OG title карточки товара">
        </div>
        <div class="adm-field">
          <label>OG Description</label>
          <textarea id="e_seo_og_description" rows="2" placeholder="OG description карточки товара"></textarea>
        </div>
      </div>
    </div>

    <div class="adm-actions">
      <button class="adm-btn adm-btn--danger" id="e_delete" style="margin-right:auto">Удалить</button>
      <button class="adm-btn adm-btn--ghost" id="e_cancel">Отмена</button>
      <button class="adm-btn adm-btn--accent" id="e_save">Сохранить</button>
    </div>
  </div>
</div>

<script>
(function(){
  const back = document.getElementById('admEditBack');
  const prev = document.getElementById('e_preview');
  const byId = s => document.getElementById(s);
  let currentId = null;

  function preview(){
    const url = (byId('e_image_url').value||'').trim();
    prev.src = url ? url : 'data:image/svg+xml;utf8,'+encodeURIComponent('<svg xmlns="http://www.w3.org/2000/svg" width="120" height="90"><rect width="100%" height="100%" fill="#f3f4f6"/><text x="50%" y="50%" dominant-baseline="middle" text-anchor="middle" font-family="Arial" font-size="12" fill="#9ca3af">превью</text></svg>');
  }
  byId('e_image_url').addEventListener('input', preview);

  function fill(p){
    byId('e_name').value = p?.name || '';
    byId('e_price').value = p?.price ?? '';
    byId('e_published').checked = !!(p?.published);
    byId('e_image_url').value = p?.image_url || '';
    byId('e_description').value = p?.description || '';
    byId('e_seo_title').value = p?.seo_title || '';
    byId('e_seo_slug').value = p?.seo_slug || '';
    byId('e_seo_description').value = p?.seo_description || '';
    byId('e_seo_keywords').value = p?.seo_keywords || '';
    byId('e_seo_h1').value = p?.seo_h1 || '';
    byId('e_shelves').value = p?.shelves ?? 0;
    byId('e_lead_time_days').value = p?.lead_time_days ?? 0;
    byId('e_supply_mode').value = p?.supply_mode || 'stock';
    byId('e_material').value = p?.material || 'AISI 430';
    byId('e_construction').value = p?.construction || 'Сборно-разборная';
    byId('e_perforation').value = p?.perforation || 'Да';
    byId('e_shelf_thickness').value = p?.shelf_thickness || '';
    byId('e_seo_robots').value = p?.seo_robots || '';
    byId('e_seo_canonical').value = p?.seo_canonical || '';
    byId('e_seo_og_title').value = p?.seo_og_title || '';
    byId('e_seo_og_description').value = p?.seo_og_description || '';
    preview();
  }

  function collect(){
    return {
      name: (byId('e_name').value||'').trim(),
      price: parseFloat(byId('e_price').value||'0') || 0,
      published: byId('e_published').checked ? 1 : 0,
      image_url: (byId('e_image_url').value||'').trim(),
      description: (byId('e_description').value||'').trim(),
      seo_title: (byId('e_seo_title').value||'').trim(),
      seo_slug: (byId('e_seo_slug').value||'').trim(),
      seo_description: (byId('e_seo_description').value||'').trim(),
      seo_keywords: (byId('e_seo_keywords').value||'').trim(),
      seo_h1: (byId('e_seo_h1').value||'').trim(),
      shelves: parseInt(byId('e_shelves').value||'0',10) || 0,
      lead_time_days: parseInt(byId('e_lead_time_days').value||'0',10) || 0,
      supply_mode: byId('e_supply_mode').value || 'stock',
      material: byId('e_material').value,
      construction: byId('e_construction').value,
      perforation: byId('e_perforation').value,
      shelf_thickness: (byId('e_shelf_thickness').value||'').trim(),
      seo_robots: (byId('e_seo_robots').value||'').trim(),
      seo_canonical: (byId('e_seo_canonical').value||'').trim(),
      seo_og_title: (byId('e_seo_og_title').value||'').trim(),
      seo_og_description: (byId('e_seo_og_description').value||'').trim(),
    };
  }

  function openEdit(p){ currentId = p?.id || null; byId('e_title').textContent = 'Карточка товара' + (currentId? ' #' + currentId : ''); fill(p||{}); back.style.display='flex'; }
  function closeEdit(){ back.style.display='none'; currentId=null; }

  byId('e_cancel').addEventListener('click', closeEdit);
  back.addEventListener('click', e=>{ if(e.target===back) closeEdit(); });

  byId('e_save').addEventListener('click', async ()=>{
    if(!currentId) return;
    const payload = collect();
    if(!payload.name){ alert('Введите название'); return; }
    try{
      const res = await fetch('/api/products/'+currentId,{ method:'PUT', headers:{'Content-Type':'application/json'}, body: JSON.stringify(payload) });
      if(!res.ok) throw new Error(await res.text());
      closeEdit(); location.reload();
    }catch(e){ console.error(e); alert('Не удалось сохранить товар'); }
  });

  byId('e_delete').addEventListener('click', async ()=>{
    if(!currentId) return;
    if(!confirm('Удалить товар #'+currentId+'?')) return;
    try{
      const res = await fetch('/api/products/'+currentId,{ method:'DELETE' });
      if(!res.ok) throw new Error(await res.text());
      closeEdit(); location.reload();
    }catch(e){ console.error(e); alert('Не удалось удалить товар'); }
  });

  // Делаем функцию видимой глобально
  window.__openEditProduct = openEdit;
})();
</script>
<!-- === /Редактирование товара === -->

<script>
(function(){
  const SEP = '\t';
  function esc(v){ return '"' + String(v ?? '').replace(/\r?\n|\r/g,' ').replace(/"/g,'""') + '"'; }
  function linesToCSV(lines){
    return lines.map(row => row.map(esc).join(SEP)).join('\r\n');
  }
  function toXLSBlob(csv){
    const buf = new Uint16Array(csv.length + 1);
    buf[0] = 0xFEFF; // BOM
    for (let i=0;i<csv.length;i++) buf[i+1]=csv.charCodeAt(i);
    return new Blob([buf], { type: 'application/vnd.ms-excel;charset=utf-16le' });
  }
  function download(blob, prefix){
    const a=document.createElement('a');
    a.href=URL.createObjectURL(blob);
    const stamp=new Date().toISOString().slice(0,19).replace(/[:T]/g,'-');
    a.download = `${prefix}_${stamp}.xls`;
    document.body.appendChild(a); a.click();
    setTimeout(()=>{ URL.revokeObjectURL(a.href); a.remove(); }, 0);
  }
  function buildStatsCSV(s){
    const lines=[];
    lines.push(['Период', `${s.from || '—'} — ${s.to || '—'}`]);
    lines.push(['Статус', s.st || 'все']);
    lines.push(['Выручка, ₽', s.totalRevenue]);
    lines.push(['Заказов', s.ordersCount]);
    lines.push([]);
    lines.push(['Топ клиентов','Сумма, ₽']);
    (s.topCustomers || []).forEach(([name,sum])=> lines.push([name, sum]));
    lines.push([]);
    lines.push(['Товары (за период)','Кол-во, шт.']);
    (s.allProducts || []).forEach(([name,qty])=> lines.push([name, qty]));
    return linesToCSV(lines);
  }

  async function exportStats(side){ // side: 'right' | 'left'
    const key = side === 'left' ? '__lastStatsLeft' : '__lastStatsRight';
    const calc = side === 'left' ? loadStatsLeft : loadStats;
    if(!window[key]){ await calc(); }
    const s = window[key];
    if(!s) return;
    const csv = buildStatsCSV(s);
    download(toXLSBlob(csv), `stats_${side}`);
  }

  const btnR = document.getElementById('export-stats');
  if(btnR && !btnR.dataset.wired){
    btnR.dataset.wired = '1';
    btnR.addEventListener('click', ()=> exportStats('right'));
  }
  const btnL = document.getElementById('export-stats-left');
  if(btnL && !btnL.dataset.wired){
    btnL.dataset.wired = '1';
    btnL.addEventListener('click', ()=> exportStats('left'));
  }
})();
</script>

</body>
</html>
